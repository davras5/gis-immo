<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBL Immobilienportfolio - GIS POC</title>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <style>
        /* ===== CSS CUSTOM PROPERTIES ===== */
        :root {
            --grey-900: #333;
            --grey-600: #666;
            --grey-400: #999;
            --grey-300: #ccc;
            --grey-100: #f5f5f5;
            --grey-50: #fafafa;
            --accent-panel: #6B747C;
            --primary-red: #c00;
            --white: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: var(--grey-900);
        }
        
        /* ===== HEADER ===== */
        #header {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 90px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        #logo-area {
            display: flex;
            align-items: flex-start;
            gap: 0;
            min-width: 320px;
        }
        
        #logo-flag {
            width: 25px;
            height: auto;
        }
        
        #logo-text-img {
            height: 50px;
            width: auto;
        }
        
        #search-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 0 40px;
        }
        
        #search-wrapper {
            position: relative;
            width: 100%;
            max-width: 550px;
            z-index: 2000;
        }

        #search-container {
            display: flex;
            align-items: center;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            width: 100%;
            overflow: hidden;
            background: var(--white);
            height: 40px;
            box-sizing: border-box;
        }
        
        #search-icon-btn {
            background: var(--grey-100);
            border: none;
            border-right: 1px solid var(--grey-300);
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #search-icon-btn:hover {
            background: var(--grey-100);
        }
        
        #search-icon-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }
        
        #search-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 14px;
            font-size: 14px;
            outline: none;
        }
        
        #search-input::placeholder {
            color: var(--grey-400);
        }

        /* NEW: Search Clear Button */
        #search-clear-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            color: var(--grey-400);
            height: 100%;
        }

        #search-clear-btn:hover {
            color: var(--grey-900);
            background: var(--grey-50);
        }

        #search-clear-btn .material-symbols-outlined {
            font-size: 18px;
        }

        #search-clear-btn.visible {
            display: flex;
        }

        /* Spinner style */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--grey-100);
            border-top: 2px solid var(--grey-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }

        #search-results.active {
            display: block;
        }

        .search-section-header {
            background: var(--accent-panel);
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-100);
            transition: background 0.15s;
        }

        .search-item:hover {
            background: var(--grey-100);
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--grey-900);
        }

        .search-item-title b {
            color: var(--primary-red);
        }

        .search-item-subtitle {
            font-size: 12px;
            color: var(--grey-600);
            margin-top: 2px;
        }
        
        .view-toggle {
            display: flex;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            height: 40px;
            box-sizing: border-box;
        }
        
        .view-toggle-btn {
            background: var(--white);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-right: 1px solid var(--grey-300);
            transition: background 0.2s, padding 0.2s;
        }
        
        .view-toggle-btn:last-child {
            border-right: none;
        }
        
        .view-toggle-btn:hover {
            background: var(--grey-100);
        }
        
        .view-toggle-btn.active {
            background: var(--accent-panel);
        }
        
        .view-toggle-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }
        
        .view-toggle-btn.active .material-symbols-outlined {
            color: var(--white);
        }
        
        .view-toggle-btn .view-label {
            display: none;
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-900);
        }
        
        .view-toggle-btn.active .view-label {
            display: inline;
            color: var(--white);
        }
        
        #header-right {
            display: flex;
            align-items: center;
            gap: 32px;
            min-width: 250px;
            justify-content: flex-end;
        }

        #filter-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #object-count {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 500;
            padding: 0 8px;
        }
        
        .header-btn {
            background: var(--white);
            border: 1px solid var(--grey-300);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            height: 40px;
            box-sizing: border-box;
            gap: 6px;
            transition: background 0.2s;
        }
        
        .header-btn:hover {
            background: var(--grey-100);
        }
        
        .header-btn .material-symbols-outlined {
            font-size: 18px;
        }
        
        #login-btn {
            background: var(--white);
            border: 1px solid var(--grey-300);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #login-btn:hover {
            background: var(--grey-100);
        }
        
        #login-btn .material-symbols-outlined {
            font-size: 22px;
            color: var(--grey-600);
        }
        
        /* ===== MAIN CONTENT ===== */
        #main {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
        }
        
        /* ===== MAP VIEW ===== */
        #map-view {
            flex: 1;
            position: relative;
            display: none;
        }
        
        #map-view.active {
            display: flex;
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        /* ===== LIST VIEW ===== */
        #list-view {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--white);
            overflow: hidden;
        }
        
        #list-view.active {
            display: flex;
        }
        
        .list-header {
            display: flex;
            background: var(--grey-100);
            border-bottom: 2px solid var(--grey-300);
            font-weight: 600;
            font-size: 12px;
            color: var(--grey-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .list-header-cell {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border-right: 1px solid var(--grey-300);
        }
        
        .list-header-cell:hover {
            background: var(--grey-100);
        }
        
        .list-header-cell .material-symbols-outlined {
            font-size: 16px;
            color: var(--grey-600);
        }
        
        .list-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .list-row {
            display: flex;
            border-bottom: 1px solid var(--grey-100);
            transition: background 0.15s;
            cursor: pointer;
        }
        
        .list-row:hover {
            background: var(--grey-100);
        }
        
        .list-row:nth-child(even) {
            background: var(--grey-50);
        }
        
        .list-row:nth-child(even):hover {
            background: var(--grey-100);
        }
        
        .list-cell {
            padding: 14px 16px;
            font-size: 13px;
            border-right: 1px solid var(--grey-100);
            display: flex;
            align-items: center;
        }
        
        .col-id { width: 120px; flex-shrink: 0; }
        .col-name { width: 200px; flex-shrink: 0; font-weight: 500; }
        .col-land { width: 80px; flex-shrink: 0; }
        .col-ort { width: 120px; flex-shrink: 0; }
        .col-adresse { flex: 1; min-width: 200px; }
        .col-portfolio { width: 180px; flex-shrink: 0; }
        .col-flaeche { width: 100px; flex-shrink: 0; text-align: right; justify-content: flex-end; }
        .col-status { width: 120px; flex-shrink: 0; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-badge.in-betrieb {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.in-renovation {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.in-planung {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-badge.ausser-betrieb {
            background: var(--grey-100);
            color: var(--grey-600);
        }
        
        /* ===== GALLERY VIEW ===== */
        #gallery-view {
            flex: 1;
            display: none;
            background: var(--grey-50);
            overflow-y: auto;
            padding: 24px;
        }
        
        #gallery-view.active {
            display: block;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .gallery-card {
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: pointer;
        }
        
        .gallery-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .gallery-image {
            height: 180px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .gallery-image .material-symbols-outlined {
            font-size: 64px;
            color: rgba(255,255,255,0.3);
        }
        
        .gallery-image-label {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .gallery-content {
            padding: 16px;
        }
        
        .gallery-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 4px;
        }
        
        .gallery-subtitle {
            font-size: 13px;
            color: var(--grey-600);
            margin-bottom: 12px;
        }
        
        .gallery-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .gallery-tag {
            background: var(--grey-100);
            color: var(--grey-600);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .gallery-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--grey-100);
            font-size: 12px;
            color: var(--grey-600);
        }
        
        .gallery-link {
            color: #005ea8;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .gallery-link:hover {
            text-decoration: underline;
        }
        
        .gallery-link .material-symbols-outlined {
            font-size: 16px;
        }
        
        /* ===== DETAIL VIEW ===== */
        #detail-view {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--grey-50);
            overflow: hidden;
        }
        
        #detail-view.active {
            display: flex;
        }
        
        .detail-header {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            padding: 12px 24px;
        }
        
        .detail-header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--grey-600);
        }
        
        .breadcrumb .material-symbols-outlined {
            font-size: 18px;
            color: var(--grey-400);
        }
        
        .breadcrumb a {
            color: var(--grey-600);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            color: var(--grey-900);
            text-decoration: underline;
        }
        
        .breadcrumb span.current {
            color: var(--grey-900);
            font-weight: 500;
        }
        
        .detail-header-actions {
            display: flex;
            gap: 16px;
        }
        
        .btn-edit {
            background: var(--grey-900);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-edit:hover {
            background: #444;
        }
        
        .btn-edit .material-symbols-outlined {
            font-size: 16px;
        }
        
        .btn-back {
            background: var(--white);
            color: var(--grey-900);
            border: 1px solid var(--grey-300);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-back:hover {
            background: var(--grey-100);
        }
        
        .btn-back .material-symbols-outlined {
            font-size: 16px;
        }
        
        .detail-tabs {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            padding: 0 24px;
        }
        
        .detail-tabs-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }
        
        .detail-tab {
            padding: 14px 20px;
            font-size: 14px;
            color: var(--grey-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .detail-tab:hover {
            color: var(--grey-900);
            background: var(--grey-50);
        }
        
        .detail-tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            font-weight: 500;
        }
        
        .detail-tab.disabled {
            color: var(--grey-400);
            cursor: not-allowed;
        }
        
        .detail-tab.disabled:hover {
            color: var(--grey-400);
            background: transparent;
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .detail-left,
        .detail-right {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .detail-section {
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .detail-section-title {
            background: var(--grey-100);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            border-bottom: 1px solid var(--grey-300);
        }
        
        .detail-section-content {
            padding: 16px;
        }
        
        /* Image Carousel */
        .carousel {
            position: relative;
            height: 340px;
            background: var(--grey-100);
        }
        
        .carousel-image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }
        
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        
        .carousel-btn:hover {
            background: var(--white);
        }
        
        .carousel-btn.prev {
            left: 16px;
        }
        
        .carousel-btn.next {
            right: 16px;
        }
        
        .carousel-btn .material-symbols-outlined {
            font-size: 24px;
            color: var(--grey-900);
        }
        
        .carousel-dots {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .carousel-dot.active {
            background: var(--white);
        }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .data-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .data-item.full-width {
            grid-column: 1 / -1;
        }
        
        .data-label {
            font-size: 12px;
            color: var(--grey-600);
        }
        
        .data-value {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 500;
        }
        
        .data-value.placeholder {
            color: var(--grey-400);
        }
        
        /* Mini Map */
        .mini-map-container {
            height: 340px;
            margin-bottom: 16px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .mini-map {
            width: 100%;
            height: 100%;
        }
        
        .address-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .address-table th {
            background: var(--grey-100);
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 1px solid var(--grey-300);
        }
        
        .address-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--grey-100);
        }
        
        .address-table tr:last-child td {
            border-bottom: none;
        }
        
        .address-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary-red);
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .address-marker .material-symbols-outlined {
            font-size: 14px;
            color: var(--white);
        }
        
        /* ===== ACCORDION PANEL ===== */
        #accordion-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 280px;
            background: var(--accent-panel);
            color: white;
            z-index: 500;
            display: flex;
            flex-direction: column;
            max-height: calc(100% - 60px);
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #accordion-panel.collapsed {
            display: none;
        }
        
        .accordion-item {
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .accordion-item:last-of-type {
            border-bottom: none;
        }
        
        .accordion-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .accordion-header:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .accordion-header.active {
            background: var(--grey-100);
            color: var(--grey-900);
        }
        
        .accordion-arrow {
            transition: transform 0.3s;
            display: flex;
            align-items: center;
        }
        
        .accordion-arrow .material-symbols-outlined {
            font-size: 18px;
        }
        
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
        
        .accordion-header.active .accordion-arrow .material-symbols-outlined {
            color: var(--grey-900);
        }
        
        .accordion-content {
            display: none;
            padding: 12px 16px;
            background: var(--white);
            font-size: 13px;
            color: var(--grey-900);
        }
        
        .accordion-content.show {
            display: block;
        }
        
        #menu-toggle {
            position: absolute;
            left: 10px;
            background: var(--grey-900);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 501;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 180px;
            margin-left: calc((280px - 180px) / 2);
        }
        
        #menu-toggle:hover {
            background: #444;
        }
        
        #menu-toggle .material-symbols-outlined {
            font-size: 18px;
        }
        
        /* ===== INFO PANEL ===== */
        #info-panel {
            position: absolute;
            top: 10px;
            right: 60px;
            width: 320px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 500;
            display: none;
        }
        
        #info-panel.show {
            display: block;
        }
        
        #info-preview-image {
            height: 140px;
            background-size: cover;
            background-position: center;
            background-color: var(--grey-100);
        }
        
        #info-header {
            background: var(--grey-100);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--grey-300);
        }
        
        #info-header-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        #info-header-actions {
            display: flex;
            gap: 8px;
        }
        
        #info-header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--grey-600);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #info-header-actions button:hover {
            color: var(--grey-900);
        }
        
        #info-header-actions .material-symbols-outlined {
            font-size: 20px;
        }
        
        #info-body {
            padding: 16px;
        }
        
        .info-section-title {
            background: var(--grey-100);
            padding: 8px 12px;
            margin: -16px -16px 16px -16px;
            font-size: 13px;
            color: var(--grey-600);
        }
        
        .info-location {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--grey-100);
        }
        
        .info-row {
            display: flex;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .info-label {
            color: var(--grey-600);
            width: 120px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: var(--grey-900);
        }
        
        .info-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--grey-100);
        }
        
        .info-detail-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--grey-900);
            color: var(--white);
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        
        .info-detail-link:hover {
            background: #444;
        }
        
        .info-detail-link .material-symbols-outlined {
            font-size: 18px;
        }
        
        /* ===== FOOTER ===== */
        #footer {
            background: var(--grey-100);
            border-top: 1px solid var(--grey-300);
            padding: 4px 16px;
            font-size: 12px;
            color: var(--grey-600);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #coordinates {
            font-family: monospace;
        }
        
        #footer-links a {
            color: #005ea8;
            text-decoration: none;
            margin-left: 16px;
        }
        
        #footer-links a:hover {
            text-decoration: underline;
        }
        
        /* Mapbox Controls */
        .mapboxgl-ctrl-top-right {
            top: 10px;
            right: 10px;
        }

        /* ===== STYLE SWITCHER ===== */
        .style-switcher {
            position: absolute;
            bottom: 40px;
            right: 20px;
            z-index: 500;
        }

        .style-switcher-btn {
            background: var(--white);
            border: 2px solid var(--grey-300);
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .style-switcher-btn:hover {
            border-color: var(--grey-400);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .style-switcher-btn img {
            width: 80px;
            height: 60px;
            border-radius: 2px;
            object-fit: cover;
        }

        .style-switcher-btn span {
            font-size: 11px;
            color: var(--grey-600);
            font-weight: 500;
        }

        .style-switcher-panel {
            position: absolute;
            bottom: 0;
            right: 100%;
            margin-right: 10px;
            background: var(--white);
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            padding: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(10px);
            transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
        }

        .style-switcher-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .style-option {
            background: var(--white);
            border: 2px solid var(--grey-300);
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: border-color 0.2s, transform 0.15s;
        }

        .style-option:hover {
            border-color: var(--grey-400);
            transform: translateY(-2px);
        }

        .style-option.active {
            border-color: var(--primary-red);
            border-width: 3px;
            padding: 3px;
        }

        .style-option img {
            width: 70px;
            height: 50px;
            border-radius: 2px;
            object-fit: cover;
        }

        .style-option span {
            font-size: 10px;
            color: var(--grey-600);
            font-weight: 500;
            white-space: nowrap;
        }

        .style-option.active span {
            color: var(--primary-red);
            font-weight: 600;
        }

        /* ===== TAB CONTENT SWITCHING ===== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== MEASUREMENTS TAB ===== */
        .measurements-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .measurements-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--grey-100);
            background: var(--grey-50);
        }

        .measurements-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            padding: 8px 12px;
            min-width: 250px;
        }

        .measurements-search .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-400);
        }

        .measurements-search input {
            border: none;
            outline: none;
            font-size: 14px;
            width: 100%;
            background: transparent;
        }

        .measurements-search input::placeholder {
            color: var(--grey-400);
        }

        .measurements-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-action {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--grey-600);
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }

        .btn-action:hover:not(:disabled) {
            background: var(--grey-100);
            color: var(--grey-900);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-action .material-symbols-outlined {
            font-size: 18px;
        }

        /* Measurements Table */
        .measurements-table-container {
            overflow-x: auto;
        }

        .measurements-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 13px;
        }

        .measurements-table th {
            background: var(--white);
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 1px solid var(--grey-300);
            white-space: nowrap;
        }

        .measurements-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .measurements-table th.sortable:hover {
            background: var(--grey-50);
        }

        .measurements-table th .sort-icon {
            font-size: 16px;
            vertical-align: middle;
            margin-left: 4px;
        }

        .measurements-table th.sort-asc .sort-icon {
            content: 'arrow_upward';
        }

        .measurements-table th.sort-desc .sort-icon {
            content: 'arrow_downward';
        }

        .measurements-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        .measurements-table tbody tr:hover {
            background: var(--grey-50);
        }

        .measurements-table tbody tr.selected {
            background: #e3f2fd;
        }

        .measurements-table .col-checkbox {
            width: 50px;
            text-align: center;
        }

        .measurements-table .col-asset {
            width: 100px;
        }

        .measurements-table .col-type {
            width: 180px;
        }

        .measurements-table .col-area {
            width: 90px;
            text-align: right;
        }

        .measurements-table .col-unit {
            width: 60px;
        }

        .measurements-table .col-accuracy {
            width: 90px;
        }

        .measurements-table .col-estimate {
            width: 90px;
            text-align: center;
        }

        .measurements-table .col-standard {
            width: 70px;
        }

        .measurements-table .col-from,
        .measurements-table .col-until {
            width: 95px;
        }

        .measurements-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .check-icon {
            color: #1a7f64;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <header id="header">
        <div id="logo-area">
            <img id="logo-flag" src="https://www.swisstopo.admin.ch/images/swiss-logo-flag.svg" alt="Schweizer Flagge">
            <img id="logo-text-img" src="https://prod-swisstopoch-hcms-sdweb.imgix.net/2023/12/16/26d017bc-3987-4322-aa29-18052c11eac5.png" alt="Schweizerische Eidgenossenschaft">
        </div>
        
        <div id="search-area">
            <div id="search-wrapper">
                <div id="search-container">
                    <button id="search-icon-btn">
                        <span class="material-symbols-outlined">search</span>
                    </button>
                    <input type="text" id="search-input" placeholder="Suche nach Objekten, Orten oder Karten">
                    <button id="search-clear-btn" title="Suche löschen">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                    <div id="search-spinner" class="spinner"></div>
                </div>
                <div id="search-results"></div>
            </div>
            
            <div class="view-toggle">
                <button class="view-toggle-btn active" data-view="map" title="Karte">
                    <span class="material-symbols-outlined">map</span>
                    <span class="view-label">Karte</span>
                </button>
                <button class="view-toggle-btn" data-view="list" title="Tabelle">
                    <span class="material-symbols-outlined">view_list</span>
                    <span class="view-label">Tabelle</span>
                </button>
                <button class="view-toggle-btn" data-view="gallery" title="Galerie">
                    <span class="material-symbols-outlined">grid_view</span>
                    <span class="view-label">Galerie</span>
                </button>
            </div>
        </div>
        
        <div id="header-right">
            <div id="filter-controls">
                <span id="object-count">10 Objekte</span>
                <button class="header-btn" id="filter-btn">
                    <span class="material-symbols-outlined">filter_list</span>
                    Filter
                </button>
            </div>
            <div id="login-area">
                <button id="login-btn" title="Anmelden">
                    <span class="material-symbols-outlined">person</span>
                </button>
            </div>
        </div>
    </header>
    
    <main id="main">
        <div id="map-view" class="active">
            <div id="map"></div>
            
            <nav id="accordion-panel">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Teilen</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Kartenansicht teilen via Link, E-Mail oder Social Media. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Drucken</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Kartenausschnitt als PDF exportieren mit Legende und Massstab. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Zeichnen & Messen auf der Karte</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Werkzeuge zum Zeichnen von Punkten, Linien und Polygonen sowie Distanz- und Flächenmessung. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Export</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Daten exportieren als GeoJSON, CSV, KML oder Shapefile. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Geokatalog</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Verfügbare Hintergrundkarten und Layer durchsuchen und aktivieren. (Platzhalter)
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>OpenStreetMap</li>
                            <li>Satellite Imagery</li>
                            <li>Topografische Karte</li>
                        </ul>
                    </div>
                </div>
            </nav>
            
            <div id="menu-toggle">
                <span class="material-symbols-outlined">expand_less</span>
                <span id="menu-toggle-text">Menü schliessen</span>
            </div>
            
            <aside id="info-panel">
                <div id="info-preview-image"></div>
                <div id="info-header">
                    <span id="info-header-title">Objekt-Information</span>
                    <div id="info-header-actions">
                        <button title="Drucken"><span class="material-symbols-outlined">print</span></button>
                        <button title="Link kopieren"><span class="material-symbols-outlined">link</span></button>
                        <button id="info-close" title="Schliessen"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div id="info-body"></div>
            </aside>

            <!-- Style Switcher -->
            <div class="style-switcher">
                <div class="style-switcher-panel" id="style-panel">
                    <button class="style-option active" data-style="light-v11" title="Light">
                        <img id="thumb-light-v11" src="" alt="Light">
                        <span>Light</span>
                    </button>
                    <button class="style-option" data-style="streets-v12" title="Standard">
                        <img id="thumb-streets-v12" src="" alt="Standard">
                        <span>Standard</span>
                    </button>
                    <button class="style-option" data-style="satellite-v9" title="Luftbild">
                        <img id="thumb-satellite-v9" src="" alt="Luftbild">
                        <span>Luftbild</span>
                    </button>
                    <button class="style-option" data-style="satellite-streets-v12" title="Luftbild + Strassen">
                        <img id="thumb-satellite-streets-v12" src="" alt="Luftbild + Strassen">
                        <span>Hybrid</span>
                    </button>
                </div>
                <button class="style-switcher-btn" id="style-switcher-btn" title="Hintergrund wechseln">
                    <img id="current-style-thumb" src="" alt="Aktueller Stil">
                    <span>Hintergrund</span>
                </button>
            </div>
        </div>
        
        <div id="list-view">
            <div class="list-header">
                <div class="list-header-cell col-id">ID <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-name">Bezeichnung <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-land">Land <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-ort">Ort <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-adresse">Adresse <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-portfolio">Teilportfolio <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-flaeche">Fläche NGF <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-status">Status <span class="material-symbols-outlined">unfold_more</span></div>
            </div>
            <div class="list-body" id="list-body"></div>
        </div>
        
        <div id="gallery-view">
            <div class="gallery-grid" id="gallery-grid"></div>
        </div>
        
        <div id="detail-view">
            <div class="detail-header">
                <div class="detail-header-inner">
                    <div class="breadcrumb" id="detail-breadcrumb">
                        <span class="material-symbols-outlined">public</span>
                        <a href="#" onclick="switchView('gallery'); return false;">Alle Objekte</a>
                        <span>></span>
                        <span class="current" id="breadcrumb-name">Gebäude</span>
                    </div>
                    <div class="detail-header-actions">
                        <button class="btn-edit">
                            <span class="material-symbols-outlined">edit</span>
                            Bearbeiten
                        </button>
                        <button class="btn-back" id="btn-back">
                            <span class="material-symbols-outlined">arrow_back</span>
                            Zurück
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="detail-tabs">
                <div class="detail-tabs-inner">
                    <div class="detail-tab active" data-tab="uebersicht">Übersicht</div>
                    <div class="detail-tab" data-tab="bemessungen">Bemessungen</div>
                    <div class="detail-tab disabled" data-tab="belegung">Belegung</div>
                    <div class="detail-tab disabled" data-tab="kosten">Kosten</div>
                    <div class="detail-tab disabled" data-tab="vertraege">Verträge</div>
                    <div class="detail-tab disabled" data-tab="ausstattung">Ausstattung</div>
                    <div class="detail-tab disabled" data-tab="dokumente">Dokumente</div>
                </div>
            </div>
            
            <div class="detail-content">
                <!-- Tab Content: Übersicht -->
                <div class="tab-content active" data-content="uebersicht">
                <div class="detail-grid">
                    <div class="detail-left">
                        <div class="detail-section">
                            <div class="detail-section-title">Bilder</div>
                            <div class="carousel" id="detail-carousel">
                                <div class="carousel-image" id="carousel-image"></div>
                                <button class="carousel-btn prev" onclick="carouselPrev()">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <button class="carousel-btn next" onclick="carouselNext()">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                                <div class="carousel-dots" id="carousel-dots"></div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Zusätzliche Informationen</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Baujahr</span>
                                        <span class="data-value" id="detail-baujahr">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Sanierung</span>
                                        <span class="data-value placeholder" id="detail-sanierung">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Ladestationen für Elektrofahrzeuge</span>
                                        <span class="data-value placeholder" id="detail-ladestationen">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Denkmalschutz</span>
                                        <span class="data-value placeholder" id="detail-denkmalschutz">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Parkplätze</span>
                                        <span class="data-value placeholder" id="detail-parkplaetze">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Anzahl Geschosse</span>
                                        <span class="data-value placeholder" id="detail-geschosse">—</span>
                                    </div>
                                    <div class="data-item full-width">
                                        <span class="data-label">Baubewilligung</span>
                                        <span class="data-value placeholder" id="detail-baubewilligung">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Energiestatistik</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Energieklasse</span>
                                        <span class="data-value placeholder" id="detail-energieklasse">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Wärmeerzeuger Heizung</span>
                                        <span class="data-value placeholder" id="detail-waermeerzeuger">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Energie-/Wärmequelle Heizung</span>
                                        <span class="data-value placeholder" id="detail-waermequelle">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Wärmeerzeuger Warmwasser</span>
                                        <span class="data-value placeholder" id="detail-warmwasser">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-right">
                        <div class="detail-section">
                            <div class="detail-section-title">Objekt Stammdaten</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Bezeichnung Objekt</span>
                                        <span class="data-value" id="detail-name">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Bezeichnung Grundstück</span>
                                        <span class="data-value placeholder" id="detail-grundstueck-name">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">ID Objekt</span>
                                        <span class="data-value" id="detail-id">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">ID Grundstück</span>
                                        <span class="data-value placeholder" id="detail-grundstueck-id">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">EGID Objekt (nur Schweiz)</span>
                                        <span class="data-value placeholder" id="detail-egid">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">EGRID Grundstück (nur Schweiz)</span>
                                        <span class="data-value placeholder" id="detail-egrid">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Gültig von</span>
                                        <span class="data-value placeholder" id="detail-gueltig-von">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Gültig bis</span>
                                        <span class="data-value placeholder" id="detail-gueltig-bis">Keine Angabe</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Teilportfolio</span>
                                        <span class="data-value" id="detail-teilportfolio">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Objektart Bund 1</span>
                                        <span class="data-value placeholder" id="detail-objektart1">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Teilportfolio Gruppe</span>
                                        <span class="data-value placeholder" id="detail-teilportfolio-gruppe">—</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Objektart Bund 2</span>
                                        <span class="data-value placeholder" id="detail-objektart2">—</span>
                                    </div>
                                    <div class="data-item full-width">
                                        <span class="data-label">Art Eigentum</span>
                                        <span class="data-value placeholder" id="detail-eigentum">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Adresse</div>
                            <div class="detail-section-content">
                                <div class="mini-map-container">
                                    <div id="mini-map" class="mini-map"></div>
                                </div>
                                <table class="address-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Country</th>
                                            <th>City</th>
                                            <th>Street</th>
                                            <th>House number</th>
                                            <th>Postal code</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <span class="address-marker">
                                                    <span class="material-symbols-outlined">location_on</span>
                                                </span>
                                            </td>
                                            <td id="detail-country">—</td>
                                            <td id="detail-city">—</td>
                                            <td id="detail-street">—</td>
                                            <td id="detail-housenumber">—</td>
                                            <td id="detail-plz">—</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Tab Content: Bemessungen -->
                <div class="tab-content" data-content="bemessungen">
                    <div class="measurements-container">
                        <!-- Area Measurements Section -->
                        <div class="detail-section">
                            <div class="detail-section-title">Flächenbemessungen</div>

                            <div class="measurements-toolbar">
                                <div class="measurements-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="measurements-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="measurements-actions">
                                    <button class="btn-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Löschen
                                    </button>
                                    <button class="btn-action" disabled>
                                        <span class="material-symbols-outlined">open_in_new</span>
                                        Anzeigen
                                    </button>
                                    <button class="btn-back">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufügen
                                    </button>
                                </div>
                            </div>

                            <div class="measurements-table-container">
                                <table class="measurements-table" id="measurements-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-measurements">
                                            </th>
                                            <th class="col-asset sortable" data-sort="asset">
                                                Objekt
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-type">Bemessungsart</th>
                                            <th class="col-area">Wert</th>
                                            <th class="col-unit">Einheit</th>
                                            <th class="col-accuracy">Genauigkeit</th>
                                            <th class="col-estimate">BM Schätzung</th>
                                            <th class="col-standard">Standard</th>
                                            <th class="col-from">Gültig von</th>
                                            <th class="col-until">Gültig bis</th>
                                        </tr>
                                    </thead>
                                    <tbody id="measurements-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer id="footer">
        <div id="coordinates">WGS 84 | Koordinaten: --</div>
        <div id="footer-links">
            <a href="https://www.admin.ch/gov/de/start/rechtliches.html" target="_blank">Rechtliches</a>
            <a href="https://github.com/davras5/gis-immo" target="_blank">Quellcode</a>
        </div>
    </footer>

    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';
        
        // Status Farben
        var statusColors = {
            'In Betrieb': '#2e7d32',
            'In Renovation': '#f57c00',
            'In Planung': '#1976d2',
            'Ausser Betrieb': '#757575'
        };
        
        // Placeholder images
        var placeholderImages = [
            'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1554435493-93422e8220c8?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1577495508048-b635879837f1?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800&h=600&fit=crop'
        ];
        
        // Variables
        var portfolioData = null;
        var currentDetailBuilding = null;
        var currentCarouselIndex = 0;
        var miniMap = null;
        var previousView = 'gallery';
        var selectedBuildingId = null;
        var searchMarker = null; 
        
        // Daten laden
        fetch('data/buildings.geojson')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                portfolioData = data;
                document.getElementById('object-count').textContent = portfolioData.features.length + ' Objekte';
                renderListView();
                renderGalleryView();
                
                if (map.loaded()) {
                    addMapLayers();
                } else {
                    map.on('load', addMapLayers);
                }
                
                // Check if URL has detail view
                var initialView = getViewFromURL();
                var buildingId = getBuildingIdFromURL();
                if (initialView === 'detail' && buildingId) {
                    showDetailView(buildingId);
                } else if (initialView !== 'map') {
                    switchView(initialView);
                }
            })
            .catch(function(error) {
                console.error('Fehler beim Laden der Daten:', error);
            });
        
        // ===== VIEW MANAGEMENT =====
        var currentView = 'map';
        
        function getViewFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('view') || 'map';
        }
        
        function getBuildingIdFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        function setViewInURL(view, buildingId) {
            var url = new URL(window.location);
            url.searchParams.set('view', view);
            if (buildingId) {
                url.searchParams.set('id', buildingId);
            } else {
                url.searchParams.delete('id');
            }
            window.history.pushState({}, '', url);
        }
        
        function switchView(view) {
            if (view !== 'detail') {
                previousView = currentView !== 'detail' ? currentView : previousView;
            }
            currentView = view;
            setViewInURL(view);
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide views
            document.getElementById('map-view').classList.remove('active');
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('gallery-view').classList.remove('active');
            document.getElementById('detail-view').classList.remove('active');
            
            var viewElement = document.getElementById(view + '-view');
            if (viewElement) {
                viewElement.classList.add('active');
            }
            
            // Resize map if switching to map view
            if (view === 'map' && window.map) {
                setTimeout(function() { map.resize(); }, 100);
            }
        }
        
        function showDetailView(buildingId) {
            if (!portfolioData) return;
            
            // Find building by ID
            var building = portfolioData.features.find(function(f) {
                return f.properties.id === buildingId;
            });
            
            if (!building) {
                console.error('Building not found:', buildingId);
                return;
            }
            
            currentDetailBuilding = building;
            
            // Store previous view if not already in detail
            if (currentView !== 'detail') {
                previousView = currentView;
            }
            
            // Update URL
            setViewInURL('detail', buildingId);
            currentView = 'detail';
            
            // Hide all views, show detail
            document.getElementById('map-view').classList.remove('active');
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('gallery-view').classList.remove('active');
            document.getElementById('detail-view').classList.add('active');
            
            // Clear active state from view toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Populate detail view
            populateDetailView(building);
        }
        
        function populateDetailView(building) {
            var props = building.properties;
            var coords = building.geometry.coordinates;
            
            // Breadcrumb
            document.getElementById('breadcrumb-name').textContent = props.name;
            
            // Objekt Stammdaten
            document.getElementById('detail-name').textContent = props.name;
            document.getElementById('detail-id').textContent = props.id;
            document.getElementById('detail-teilportfolio').textContent = props.teilportfolio;
            document.getElementById('detail-baujahr').textContent = props.baujahr;
            
            // Address
            document.getElementById('detail-country').textContent = props.land;
            document.getElementById('detail-city').textContent = props.ort;
            
            // Parse address into street and house number
            var addressParts = parseAddress(props.adresse);
            document.getElementById('detail-street').textContent = addressParts.street;
            document.getElementById('detail-housenumber').textContent = addressParts.number;
            document.getElementById('detail-plz').textContent = addressParts.plz || '—';
            
            // Initialize carousel
            initCarousel();
            
            // Initialize mini map
            initMiniMap(coords);
        }
        
        function parseAddress(address) {
            // Simple address parsing
            var parts = address.split(' ');
            var number = '';
            var street = address;
            
            // Try to find house number at the end
            if (parts.length > 1) {
                var lastPart = parts[parts.length - 1];
                if (/^\d/.test(lastPart)) {
                    number = lastPart;
                    street = parts.slice(0, -1).join(' ');
                }
            }
            
            return { street: street, number: number, plz: '' };
        }
        
        function initCarousel() {
            currentCarouselIndex = 0;
            updateCarouselImage();
            
            // Create dots
            var dotsContainer = document.getElementById('carousel-dots');
            dotsContainer.innerHTML = '';
            placeholderImages.forEach(function(_, index) {
                var dot = document.createElement('div');
                dot.className = 'carousel-dot' + (index === 0 ? ' active' : '');
                dot.onclick = function() {
                    currentCarouselIndex = index;
                    updateCarouselImage();
                };
                dotsContainer.appendChild(dot);
            });
        }
        
        function updateCarouselImage() {
            var imageEl = document.getElementById('carousel-image');
            imageEl.style.backgroundImage = 'url(' + placeholderImages[currentCarouselIndex] + ')';
            
            // Update dots
            document.querySelectorAll('.carousel-dot').forEach(function(dot, index) {
                dot.classList.toggle('active', index === currentCarouselIndex);
            });
        }
        
        function carouselPrev() {
            currentCarouselIndex = (currentCarouselIndex - 1 + placeholderImages.length) % placeholderImages.length;
            updateCarouselImage();
        }
        
        function carouselNext() {
            currentCarouselIndex = (currentCarouselIndex + 1) % placeholderImages.length;
            updateCarouselImage();
        }
        
        function initMiniMap(coords) {
            // Destroy existing map if any
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
            
            // Create new mini map
            miniMap = new mapboxgl.Map({
                container: 'mini-map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: coords,
                zoom: 17,
                pitch: 50,
                bearing: -17
            });
            
            // Add 3D buildings layer
            miniMap.on('load', function() {
                // Add 3D buildings
                var layers = miniMap.getStyle().layers;
                var labelLayerId;
                for (var i = 0; i < layers.length; i++) {
                    if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                        labelLayerId = layers[i].id;
                        break;
                    }
                }
                
                miniMap.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': [
                            'interpolate', ['linear'], ['zoom'],
                            15, 0,
                            15.05, ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate', ['linear'], ['zoom'],
                            15, 0,
                            15.05, ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.6
                    }
                }, labelLayerId);
                
                // Add marker
                new mapboxgl.Marker({ color: '#c00' })
                    .setLngLat(coords)
                    .addTo(miniMap);
            });
            
            // Add navigation controls
            miniMap.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
        }
        
        // View toggle click handlers
        document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                switchView(this.dataset.view);
            });
        });
        
        // Back button handler
        document.getElementById('btn-back').addEventListener('click', function() {
            switchView(previousView || 'gallery');
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', function() {
            var view = getViewFromURL();
            var buildingId = getBuildingIdFromURL();
            if (view === 'detail' && buildingId) {
                showDetailView(buildingId);
            } else {
                switchView(view);
            }
        });
        
        // ===== RENDER LIST VIEW =====
        function renderListView() {
            if (!portfolioData) return;
            
            var listBody = document.getElementById('list-body');
            var html = '';
            
            portfolioData.features.forEach(function(feature) {
                var props = feature.properties;
                var statusClass = props.status === 'In Betrieb' ? 'in-betrieb' : 
                                  props.status === 'In Renovation' ? 'in-renovation' : 
                                  props.status === 'In Planung' ? 'in-planung' : 'ausser-betrieb';
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                
                html += '<div class="list-row" data-id="' + props.id + '">' +
                    '<div class="list-cell col-id">' + props.id + '</div>' +
                    '<div class="list-cell col-name">' + props.name + '</div>' +
                    '<div class="list-cell col-land">' + props.land + '</div>' +
                    '<div class="list-cell col-ort">' + props.ort + '</div>' +
                    '<div class="list-cell col-adresse">' + props.adresse + '</div>' +
                    '<div class="list-cell col-portfolio">' + props.teilportfolio + '</div>' +
                    '<div class="list-cell col-flaeche">' + flaeche + ' m²</div>' +
                    '<div class="list-cell col-status"><span class="status-badge ' + statusClass + '">' + props.status + '</span></div>' +
                '</div>';
            });
            
            listBody.innerHTML = html;
            
            // Add click handlers
            document.querySelectorAll('.list-row').forEach(function(row) {
                row.addEventListener('click', function() {
                    var buildingId = this.dataset.id;
                    showDetailView(buildingId);
                });
            });
        }
        
        // ===== RENDER GALLERY VIEW =====
        function renderGalleryView() {
            if (!portfolioData) return;
            
            var galleryGrid = document.getElementById('gallery-grid');
            var html = '';
            
            portfolioData.features.forEach(function(feature, index) {
                var props = feature.properties;
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                // Use placeholder images
                var imageUrl = placeholderImages[index % placeholderImages.length];
                
                html += '<div class="gallery-card" data-id="' + props.id + '">' +
                    '<div class="gallery-image" style="background-image: url(' + imageUrl + ')">' +
                        '<div class="gallery-image-label">' + props.land + '</div>' +
                    '</div>' +
                    '<div class="gallery-content">' +
                        '<div class="gallery-title">' + props.name + '</div>' +
                        '<div class="gallery-subtitle">' + props.adresse + '</div>' +
                        '<div class="gallery-meta">' +
                            '<span class="gallery-tag">' + props.teilportfolio + '</span>' +
                            '<span class="gallery-tag">' + flaeche + ' m²</span>' +
                        '</div>' +
                        '<div class="gallery-footer">' +
                            '<span>Baujahr ' + props.baujahr + '</span>' +
                            '<a href="#" class="gallery-link" onclick="event.stopPropagation();">Details <span class="material-symbols-outlined">arrow_forward</span></a>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            
            galleryGrid.innerHTML = html;
            
            // Add click handlers
            document.querySelectorAll('.gallery-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    var buildingId = this.dataset.id;
                    showDetailView(buildingId);
                });
            });
        }
        
        // ===== INITIALIZE MAP =====
        
        // 1. Parse URL parameters for map state
        var urlParams = new URLSearchParams(window.location.search);
        var initialLat = parseFloat(urlParams.get('lat'));
        var initialLng = parseFloat(urlParams.get('lng'));
        var initialZoom = parseFloat(urlParams.get('zoom'));

        // Defaults (Switzerland)
        var startCenter = [8.2275, 46.8182];
        var startZoom = 2;

        // Override defaults if URL params exist
        if (!isNaN(initialLat) && !isNaN(initialLng) && !isNaN(initialZoom)) {
            startCenter = [initialLng, initialLat];
            startZoom = initialZoom;
        }

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: startCenter,
            zoom: startZoom
        });
        
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.ScaleControl({ maxWidth: 200 }), 'bottom-left');
        
        // 2. Update URL on map move/zoom
        map.on('moveend', function() {
            if (currentView !== 'map') return; // Don't update if not in map view
            
            var center = map.getCenter();
            var zoom = map.getZoom();
            
            var url = new URL(window.location);
            url.searchParams.set('lng', center.lng.toFixed(5));
            url.searchParams.set('lat', center.lat.toFixed(5));
            url.searchParams.set('zoom', zoom.toFixed(2));
            
            // Use replaceState to update URL without adding to history stack
            window.history.replaceState({}, '', url);
        });

        map.on('mousemove', function(e) {
            var lng = e.lngLat.lng.toFixed(5);
            var lat = e.lngLat.lat.toFixed(5);
            document.getElementById('coordinates').textContent = 'WGS 84 | Koordinaten: ' + lng + ', ' + lat;
        });
        
        function addMapLayers() {
            if (!portfolioData) return;
            
            map.addSource('portfolio', {
                type: 'geojson',
                data: portfolioData
            });
            
            // Main points layer
            map.addLayer({
                id: 'portfolio-points',
                type: 'circle',
                source: 'portfolio',
                paint: {
                    'circle-radius': 10,
                    'circle-color': [
                        'match',
                        ['get', 'status'],
                        'In Betrieb', '#2e7d32',
                        'In Renovation', '#f57c00',
                        'In Planung', '#1976d2',
                        'Ausser Betrieb', '#757575',
                        '#999999'
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });
            
            // Selected point highlight layer
            map.addLayer({
                id: 'portfolio-selected',
                type: 'circle',
                source: 'portfolio',
                filter: ['==', ['get', 'id'], ''],
                paint: {
                    'circle-radius': 16,
                    'circle-color': 'transparent',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#c00'
                }
            });
            
            map.on('mouseenter', 'portfolio-points', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'portfolio-points', function() {
                map.getCanvas().style.cursor = '';
            });
            
            // CLICK HANDLER
            map.on('click', 'portfolio-points', function(e) {
                var props = e.features[0].properties;
                // UPDATED: Pass 'false' so map does NOT zoom on click
                selectBuilding(props.id, false);
            });
            
            // Click on map (not on a point) to deselect
            map.on('click', function(e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['portfolio-points'] });
                if (features.length === 0) {
                    selectedBuildingId = null;
                    updateSelectedBuilding();
                    document.getElementById('info-panel').classList.remove('show');
                }
            });
        }
        
        // Reusable function to select a building
        // UPDATED: Added flyToBuilding parameter (default false)
        function selectBuilding(buildingId, flyToBuilding = false) {
            // Find feature props
            var building = portfolioData.features.find(function(f) { return f.properties.id === buildingId; });
            if (!building) return;
            
            var props = building.properties;
            var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
            var statusColor = statusColors[props.status] || '#999999';
            
            // Update selected ID
            selectedBuildingId = buildingId;
            updateSelectedBuilding();
            
            // Find building index for placeholder image
            var buildingIndex = portfolioData.features.findIndex(function(f) {
                return f.properties.id === buildingId;
            });
            var imageUrl = placeholderImages[buildingIndex % placeholderImages.length];
            
            // Set preview image
            document.getElementById('info-preview-image').style.backgroundImage = 'url(' + imageUrl + ')';
            
            var infoHtml = 
                '<div class="info-section-title">' + props.teilportfolio + '</div>' +
                '<div class="info-location">' + props.ort + ', ' + props.land + '</div>' +
                '<div class="info-row"><span class="info-label">Objekt-ID</span><span class="info-value">' + props.id + '</span></div>' +
                '<div class="info-row"><span class="info-label">Name</span><span class="info-value">' + props.name + '</span></div>' +
                '<div class="info-row"><span class="info-label">Adresse</span><span class="info-value">' + props.adresse + '</span></div>' +
                '<div class="info-row"><span class="info-label">Fläche NGF</span><span class="info-value">' + flaeche + ' m²</span></div>' +
                '<div class="info-row"><span class="info-label">Baujahr</span><span class="info-value">' + props.baujahr + '</span></div>' +
                '<div class="info-row"><span class="info-label">Verantwortlich</span><span class="info-value">' + props.verantwortlich + '</span></div>' +
                '<div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color:' + statusColor + '; font-weight: 600;">' + props.status + '</span></div>' +
                '<div class="info-footer">' +
                    '<button class="info-detail-link" onclick="showDetailView(\'' + props.id + '\')">' +
                        '<span class="material-symbols-outlined">open_in_new</span>' +
                        'Details anzeigen' +
                    '</button>' +
                '</div>';
            
            document.getElementById('info-body').innerHTML = infoHtml;
            document.getElementById('info-panel').classList.add('show');
            
            // UPDATED: Only fly to building if explicitly requested (e.g. from Search)
            if (map && flyToBuilding) {
                map.flyTo({
                    center: building.geometry.coordinates,
                    zoom: 16
                });
            }
        }
        
        function updateSelectedBuilding() {
            if (map && map.getLayer('portfolio-selected')) {
                map.setFilter('portfolio-selected', ['==', ['get', 'id'], selectedBuildingId || '']);
            }
        }
        
        // ===== SEARCH FUNCTIONALITY =====
        var searchInput = document.getElementById('search-input');
        var searchResults = document.getElementById('search-results');
        var searchSpinner = document.getElementById('search-spinner');
        var searchClearBtn = document.getElementById('search-clear-btn');
        var searchDebounceTimer;
        
        // Listen for input
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchDebounceTimer);
            var val = e.target.value.trim();
            
            // Toggle clear button visibility
            if (val.length > 0) {
                searchClearBtn.classList.add('visible');
            } else {
                searchClearBtn.classList.remove('visible');
            }
            
            if (val.length < 2) {
                searchResults.classList.remove('active');
                searchSpinner.style.display = 'none';
                return;
            }
            
            searchSpinner.style.display = 'block';
            searchDebounceTimer = setTimeout(function() {
                performSearch(val);
            }, 300);
        });

        // Clear Button Click Listener
        searchClearBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            searchResults.classList.remove('active');
            searchInput.focus();
            
            // Remove the search marker if it exists
            if (searchMarker) {
                searchMarker.remove();
                searchMarker = null;
            }
        });
        
        // Close search on click outside
        document.addEventListener('click', function(e) {
            if (!document.getElementById('search-wrapper').contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // Close search on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchResults.classList.remove('active');
            }
        });
        
        function performSearch(term) {
            var promises = [];
            
            // 1. Local Search
            promises.push(new Promise(function(resolve) {
                var matches = [];
                if (portfolioData) {
                    var lowerTerm = term.toLowerCase();
                    matches = portfolioData.features.filter(function(f) {
                        var p = f.properties;
                        return (p.name && p.name.toLowerCase().includes(lowerTerm)) ||
                               (p.adresse && p.adresse.toLowerCase().includes(lowerTerm)) ||
                               (p.ort && p.ort.toLowerCase().includes(lowerTerm));
                    });
                }
                resolve({ type: 'local', data: matches });
            }));
            
            // 2. Swisstopo Locations
            promises.push(fetch('https://api3.geo.admin.ch/rest/services/ech/SearchServer?type=locations&limit=5&sr=4326&searchText=' + encodeURIComponent(term))
                .then(r => r.json())
                .then(data => ({ type: 'locations', data: data.results }))
                .catch(e => ({ type: 'locations', data: [] })));
                
            // 3. Swisstopo Layers
            promises.push(fetch('https://api3.geo.admin.ch/rest/services/ech/SearchServer?type=layers&limit=5&lang=de&searchText=' + encodeURIComponent(term))
                .then(r => r.json())
                .then(data => ({ type: 'layers', data: data.results }))
                .catch(e => ({ type: 'layers', data: [] })));
                
            Promise.all(promises).then(function(results) {
                renderSearchResults(results);
                searchSpinner.style.display = 'none';
            });
        }
        
        function renderSearchResults(results) {
            var localResults = results.find(function(r) { return r.type === 'local'; }).data;
            var locResults = results.find(function(r) { return r.type === 'locations'; }).data;
            var layerResults = results.find(function(r) { return r.type === 'layers'; }).data;
            
            var html = '';
            
            // Section: Objekte (Local)
            if (localResults.length > 0) {
                html += '<div class="search-section-header">Objekte</div>';
                localResults.forEach(function(f) {
                    html += '<div class="search-item" onclick="handleSearchClick(\'local\', \'' + f.properties.id + '\')">' +
                            '<div class="search-item-title">' + f.properties.name + '</div>' +
                            '<div class="search-item-subtitle">' + f.properties.adresse + ', ' + f.properties.ort + '</div>' +
                            '</div>';
                });
            }
            
            // Section: Orte (API)
            if (locResults.length > 0) {
                html += '<div class="search-section-header">Orte</div>';
                locResults.forEach(function(r, index) {
                    var lat = r.attrs.lat;
                    var lon = r.attrs.lon;
                    var zoom = r.attrs.zoomlevel || 14;
                    html += '<div class="search-item" onclick="handleSearchClick(\'location\', null, ' + lat + ', ' + lon + ', ' + zoom + ')">' +
                            '<div class="search-item-title">' + r.attrs.label + '</div>' +
                            '</div>';
                });
            }
            
            // Section: Karten (API)
            if (layerResults.length > 0) {
                html += '<div class="search-section-header">Karten hinzufügen...</div>';
                layerResults.forEach(function(r) {
                    html += '<div class="search-item" onclick="handleSearchClick(\'layer\', \'' + r.attrs.label.replace(/'/g, "\\'") + '\')">' +
                            '<div class="search-item-title">' + r.attrs.label + '</div>' +
                            '</div>';
                });
            }
            
            if (html === '') {
                html = '<div class="search-item" style="cursor:default;"><div class="search-item-subtitle">Keine Resultate gefunden</div></div>';
            }
            
            searchResults.innerHTML = html;
            searchResults.classList.add('active');
        }
        
        // Make this function global so onclick in HTML string works
        window.handleSearchClick = function(type, id, lat, lon, zoom) {
            searchResults.classList.remove('active');
            
            if (currentView !== 'map') {
                switchView('map');
            }
            
            if (type === 'local') {
                // Pass true to fly to the building when searching
                selectBuilding(id, true);
                
                // Remove generic search marker if we select a specific building
                if (searchMarker) {
                    searchMarker.remove();
                    searchMarker = null;
                }

                var b = portfolioData.features.find(f => f.properties.id === id);
                if(b) {
                    searchInput.value = b.properties.name;
                    searchClearBtn.classList.add('visible');
                }

            } else if (type === 'location') {
                // 1. Remove existing marker
                if (searchMarker) {
                    searchMarker.remove();
                }

                // 2. Fly to location
                map.flyTo({
                    center: [lon, lat],
                    zoom: zoom
                });

                // 3. Add Red Marker
                searchMarker = new mapboxgl.Marker({ color: '#c00' })
                    .setLngLat([lon, lat])
                    .addTo(map);

                // Clear selected building info panel
                selectedBuildingId = null;
                updateSelectedBuilding();
                document.getElementById('info-panel').classList.remove('show');
                
                searchClearBtn.classList.add('visible');

            } else if (type === 'layer') {
                alert('Layer "' + id + '" wird bald verfügbar sein.');
            }
        };
        
        // ===== ACCORDION =====
        document.querySelectorAll('.accordion-header').forEach(function(header) {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                var isActive = this.classList.contains('active');
                
                document.querySelectorAll('.accordion-header').forEach(function(h) { h.classList.remove('active'); });
                document.querySelectorAll('.accordion-content').forEach(function(c) { c.classList.remove('show'); });
                
                if (!isActive) {
                    this.classList.add('active');
                    content.classList.add('show');
                }
                
                setTimeout(updateMenuTogglePosition, 10);
            });
        });
        
        // ===== MENU TOGGLE =====
        var menuToggle = document.getElementById('menu-toggle');
        var accordionPanel = document.getElementById('accordion-panel');
        var menuToggleText = document.getElementById('menu-toggle-text');
        var menuToggleIcon = menuToggle.querySelector('.material-symbols-outlined');
        var menuOpen = true;
        
        function updateMenuTogglePosition() {
            var mainRect = document.getElementById('map-view').getBoundingClientRect();

            if (menuOpen) {
                var panelRect = accordionPanel.getBoundingClientRect();
                var calculatedTop = panelRect.bottom - mainRect.top;
                // Ensure button stays below the panel - if panel hasn't rendered yet, retry
                if (panelRect.height < 50) {
                    setTimeout(updateMenuTogglePosition, 50);
                    return;
                }
                menuToggle.style.top = calculatedTop + 'px';
            } else {
                menuToggle.style.top = '10px';
            }
        }
        
        setTimeout(updateMenuTogglePosition, 100);
        
        menuToggle.addEventListener('click', function() {
            menuOpen = !menuOpen;
            
            if (menuOpen) {
                accordionPanel.classList.remove('collapsed');
                menuToggleText.textContent = 'Menü schliessen';
                menuToggleIcon.textContent = 'expand_less';
            } else {
                accordionPanel.classList.add('collapsed');
                menuToggleText.textContent = 'Menü öffnen';
                menuToggleIcon.textContent = 'expand_more';
            }
            
            setTimeout(updateMenuTogglePosition, 10);
        });
        
        var observer = new MutationObserver(function() {
            setTimeout(updateMenuTogglePosition, 10);
        });
        observer.observe(accordionPanel, { attributes: true, childList: true, subtree: true });
        
        // ===== INFO PANEL CLOSE =====
        document.getElementById('info-close').addEventListener('click', function() {
            document.getElementById('info-panel').classList.remove('show');
            selectedBuildingId = null;
            updateSelectedBuilding();
        });
        
        // ===== DETAIL TABS =====
        document.querySelectorAll('.detail-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                if (this.classList.contains('disabled')) {
                    return;
                }
                var targetTab = this.dataset.tab;

                // Update active tab
                document.querySelectorAll('.detail-tab').forEach(function(t) {
                    t.classList.remove('active');
                });
                this.classList.add('active');

                // Switch content
                document.querySelectorAll('.tab-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                var targetContent = document.querySelector('.tab-content[data-content="' + targetTab + '"]');
                if (targetContent) {
                    targetContent.classList.add('active');
                }

                // Render measurements table when switching to Bemessungen tab
                if (targetTab === 'bemessungen') {
                    renderMeasurementsTable();
                }
            });
        });

        // ===== STYLE SWITCHER =====
        var currentMapStyle = localStorage.getItem('mapStyle') || 'light-v11';
        var styleSwitcherBtn = document.getElementById('style-switcher-btn');
        var stylePanel = document.getElementById('style-panel');
        var stylePanelOpen = false;

        // Map style definitions
        var mapStyles = {
            'light-v11': { name: 'Light', url: 'mapbox://styles/mapbox/light-v11' },
            'streets-v12': { name: 'Standard', url: 'mapbox://styles/mapbox/streets-v12' },
            'satellite-v9': { name: 'Luftbild', url: 'mapbox://styles/mapbox/satellite-v9' },
            'satellite-streets-v12': { name: 'Hybrid', url: 'mapbox://styles/mapbox/satellite-streets-v12' }
        };

        // Generate thumbnail URL using Mapbox Static Images API
        function getStyleThumbnail(styleId, width, height) {
            var lon = 8.2275;
            var lat = 46.8182;
            var zoom = 6;
            return 'https://api.mapbox.com/styles/v1/mapbox/' + styleId + '/static/' +
                   lon + ',' + lat + ',' + zoom + '/' + width + 'x' + height +
                   '?access_token=' + mapboxgl.accessToken;
        }

        // Initialize thumbnails
        function initStyleThumbnails() {
            Object.keys(mapStyles).forEach(function(styleId) {
                var thumbEl = document.getElementById('thumb-' + styleId);
                if (thumbEl) {
                    thumbEl.src = getStyleThumbnail(styleId, 140, 100);
                }
            });
            // Set current style thumbnail
            document.getElementById('current-style-thumb').src = getStyleThumbnail(currentMapStyle, 160, 120);
        }

        // Update active style button
        function updateActiveStyleButton() {
            document.querySelectorAll('.style-option').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.style === currentMapStyle) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('current-style-thumb').src = getStyleThumbnail(currentMapStyle, 160, 120);
        }

        // Toggle style panel
        function toggleStylePanel() {
            stylePanelOpen = !stylePanelOpen;
            if (stylePanelOpen) {
                stylePanel.classList.add('show');
            } else {
                stylePanel.classList.remove('show');
            }
        }

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            if (stylePanelOpen && !e.target.closest('.style-switcher')) {
                stylePanelOpen = false;
                stylePanel.classList.remove('show');
            }
        });

        // Style switcher button click
        styleSwitcherBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleStylePanel();
        });

        // Style option click handlers
        document.querySelectorAll('.style-option').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var styleId = this.dataset.style;
                if (styleId === currentMapStyle) {
                    toggleStylePanel();
                    return;
                }

                currentMapStyle = styleId;
                localStorage.setItem('mapStyle', styleId);
                updateActiveStyleButton();

                // Change map style
                map.setStyle(mapStyles[styleId].url);

                // Close panel
                stylePanelOpen = false;
                stylePanel.classList.remove('show');
            });
        });

        // Re-add layers after style change
        map.on('style.load', function() {
            // Only re-add if portfolio data is loaded and source doesn't exist
            if (portfolioData && !map.getSource('portfolio')) {
                addMapLayers();
            }
        });

        // Apply saved style on load (if different from default)
        if (currentMapStyle !== 'light-v11') {
            map.once('load', function() {
                map.setStyle(mapStyles[currentMapStyle].url);
            });
        }

        // Initialize thumbnails after a short delay to ensure token is available
        setTimeout(initStyleThumbnails, 100);
        updateActiveStyleButton();

        // ===== MEASUREMENTS TAB =====

        // Demo data for measurements
        var measurementsData = [
            {
                id: 'meas-001',
                asset: 'DE-BE-11',
                areaType: 'Bruttogeschossfläche',
                value: 4200,
                unit: 'm²',
                accuracy: 'Aggregiert',
                bmEstimate: false,
                standard: 'MFG',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            },
            {
                id: 'meas-002',
                asset: 'DE-BE-11',
                areaType: 'Nettogeschossfläche',
                value: 3900,
                unit: 'm²',
                accuracy: 'Geschätzt',
                bmEstimate: true,
                standard: 'n/a',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            },
            {
                id: 'meas-003',
                asset: 'DE-BE-11',
                areaType: 'Energiebezugsfläche',
                value: 4100,
                unit: 'm²',
                accuracy: 'Geschätzt',
                bmEstimate: true,
                standard: 'n/a',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            },
            {
                id: 'meas-004',
                asset: 'DE-BE-11',
                areaType: 'Volumen',
                value: 12600,
                unit: 'm³',
                accuracy: 'Geschätzt',
                bmEstimate: true,
                standard: 'n/a',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            },
            {
                id: 'meas-005',
                asset: 'DE-BE-11',
                areaType: 'Arbeitsplätze',
                value: 85,
                unit: 'Stk',
                accuracy: 'Aggregiert',
                bmEstimate: false,
                standard: 'n/a',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            },
            {
                id: 'meas-006',
                asset: 'DE-BE-11',
                areaType: 'Reinigungsfläche',
                value: 3200,
                unit: 'm²',
                accuracy: 'Geschätzt',
                bmEstimate: true,
                standard: 'n/a',
                validFrom: '06.04.2020',
                validUntil: '27.11.2025'
            }
        ];

        var filteredMeasurements = measurementsData.slice();
        var measurementsSortDirection = 'asc';
        var measurementsSortColumn = 'asset';

        function renderMeasurementsTable() {
            var tbody = document.getElementById('measurements-tbody');
            if (!tbody) return;

            var html = '';
            filteredMeasurements.forEach(function(m) {
                var formattedValue = Number(m.value).toLocaleString('de-CH');
                var checkIcon = m.bmEstimate ? '<span class="material-symbols-outlined check-icon">check</span>' : '';

                html += '<tr data-id="' + m.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="measurement-checkbox"></td>' +
                    '<td class="col-asset">' + m.asset + '</td>' +
                    '<td class="col-type">' + m.areaType + '</td>' +
                    '<td class="col-area">' + formattedValue + '</td>' +
                    '<td class="col-unit">' + m.unit + '</td>' +
                    '<td class="col-accuracy">' + m.accuracy + '</td>' +
                    '<td class="col-estimate">' + checkIcon + '</td>' +
                    '<td class="col-standard">' + m.standard + '</td>' +
                    '<td class="col-from">' + m.validFrom + '</td>' +
                    '<td class="col-until">' + m.validUntil + '</td>' +
                '</tr>';
            });

            tbody.innerHTML = html;

            // Add checkbox event listeners
            document.querySelectorAll('.measurement-checkbox').forEach(function(cb) {
                cb.addEventListener('change', updateMeasurementsSelection);
            });
        }

        function updateMeasurementsSelection() {
            var checkboxes = document.querySelectorAll('.measurement-checkbox');
            var checkedCount = document.querySelectorAll('.measurement-checkbox:checked').length;
            var selectAll = document.getElementById('select-all-measurements');

            // Update select all checkbox state
            if (selectAll) {
                selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
            }

            // Update row selection styling
            document.querySelectorAll('.measurements-table tbody tr').forEach(function(row) {
                var cb = row.querySelector('.measurement-checkbox');
                if (cb && cb.checked) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });

            // Enable/disable action buttons based on selection
            var actionBtns = document.querySelectorAll('.measurements-actions .btn-action');
            actionBtns.forEach(function(btn) {
                btn.disabled = checkedCount === 0;
            });
        }

        // Select All checkbox handler
        var selectAllCheckbox = document.getElementById('select-all-measurements');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                var checkboxes = document.querySelectorAll('.measurement-checkbox');
                var isChecked = this.checked;
                checkboxes.forEach(function(cb) {
                    cb.checked = isChecked;
                });
                updateMeasurementsSelection();
            });
        }

        // Filter functionality
        var measurementsFilter = document.getElementById('measurements-filter');
        if (measurementsFilter) {
            measurementsFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();

                if (term === '') {
                    filteredMeasurements = measurementsData.slice();
                } else {
                    filteredMeasurements = measurementsData.filter(function(m) {
                        return m.asset.toLowerCase().includes(term) ||
                               m.areaType.toLowerCase().includes(term) ||
                               m.accuracy.toLowerCase().includes(term) ||
                               m.standard.toLowerCase().includes(term) ||
                               m.unit.toLowerCase().includes(term) ||
                               String(m.value).includes(term);
                    });
                }

                sortMeasurements();
                renderMeasurementsTable();
            });
        }

        // Sort functionality
        function sortMeasurements() {
            filteredMeasurements.sort(function(a, b) {
                var valA = a[measurementsSortColumn];
                var valB = b[measurementsSortColumn];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return measurementsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return measurementsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Sort column click handler
        document.querySelectorAll('.measurements-table th.sortable').forEach(function(th) {
            th.addEventListener('click', function() {
                var column = this.dataset.sort;

                // Toggle direction if same column, else default to asc
                if (column === measurementsSortColumn) {
                    measurementsSortDirection = measurementsSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    measurementsSortColumn = column;
                    measurementsSortDirection = 'asc';
                }

                // Update sort icons
                document.querySelectorAll('.measurements-table th.sortable').forEach(function(header) {
                    header.classList.remove('sort-asc', 'sort-desc');
                    var icon = header.querySelector('.sort-icon');
                    if (icon) icon.textContent = 'unfold_more';
                });

                this.classList.add('sort-' + measurementsSortDirection);
                var sortIcon = this.querySelector('.sort-icon');
                if (sortIcon) {
                    sortIcon.textContent = measurementsSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward';
                }

                sortMeasurements();
                renderMeasurementsTable();
            });
        });

        // Placeholder click handler for Add button in measurements
        var addMeasurementBtn = document.querySelector('.measurements-actions .btn-back');
        if (addMeasurementBtn) {
            addMeasurementBtn.addEventListener('click', function() {
                alert('Bemessung hinzufügen - kommt bald...');
            });
        }
    </script>
</body>
</html>
