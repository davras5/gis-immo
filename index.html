<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBL Immobilienportfolio - GIS POC</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }
        
        /* ===== HEADER ===== */
        #header {
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 16px;
            height: 90px;
            z-index: 1000;
        }
        
        #logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 320px;
        }
        
        #logo-flag {
            width: 25px;
            height: auto;
        }
        
        #logo-text-img {
            height: 50px;
            width: auto;
        }
        
        #search-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 0 40px;
        }
        
        #search-container {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 550px;
            overflow: hidden;
        }
        
        #search-icon-btn {
            background: #f5f5f5;
            border: none;
            border-right: 1px solid #ccc;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #search-icon-btn:hover {
            background: #eee;
        }
        
        #search-icon-btn .material-icons {
            font-size: 20px;
            color: #666;
        }
        
        #search-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 14px;
            font-size: 14px;
            outline: none;
        }
        
        #search-input::placeholder {
            color: #999;
        }
        
        .view-toggle {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .view-toggle-btn {
            background: #fff;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #ccc;
        }
        
        .view-toggle-btn:last-child {
            border-right: none;
        }
        
        .view-toggle-btn:hover {
            background: #f5f5f5;
        }
        
        .view-toggle-btn.active {
            background: #e0e0e0;
        }
        
        .view-toggle-btn .material-icons {
            font-size: 20px;
            color: #666;
        }
        
        .view-toggle-btn.active .material-icons {
            color: #333;
        }
        
        #header-right {
            display: flex;
            align-items: center;
            gap: 24px;
            min-width: 250px;
            justify-content: flex-end;
        }
        
        #object-count {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            padding: 0 8px;
        }
        
        .header-btn {
            background: #fff;
            border: 1px solid #ccc;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }
        
        .header-btn:hover {
            background: #f5f5f5;
        }
        
        .header-btn .material-icons {
            font-size: 18px;
        }
        
        #login-btn {
            background: #fff;
            border: 1px solid #ccc;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #login-btn:hover {
            background: #f5f5f5;
        }
        
        #login-btn .material-icons {
            font-size: 22px;
            color: #666;
        }
        
        /* ===== MAIN CONTENT ===== */
        #main {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
        }
        
        /* ===== MAP VIEW ===== */
        #map-view {
            flex: 1;
            position: relative;
            display: none;
        }
        
        #map-view.active {
            display: flex;
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        /* ===== LIST VIEW ===== */
        #list-view {
            flex: 1;
            display: none;
            flex-direction: column;
            background: #fff;
            overflow: hidden;
        }
        
        #list-view.active {
            display: flex;
        }
        
        .list-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 12px;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .list-header-cell {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border-right: 1px solid #dee2e6;
        }
        
        .list-header-cell:hover {
            background: #e9ecef;
        }
        
        .list-header-cell .material-icons {
            font-size: 16px;
            color: #6c757d;
        }
        
        .list-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .list-row {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.15s;
            cursor: pointer;
        }
        
        .list-row:hover {
            background: #f8f9fa;
        }
        
        .list-row:nth-child(even) {
            background: #fdfdfd;
        }
        
        .list-row:nth-child(even):hover {
            background: #f8f9fa;
        }
        
        .list-cell {
            padding: 14px 16px;
            font-size: 13px;
            border-right: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .col-id { width: 120px; flex-shrink: 0; }
        .col-name { width: 200px; flex-shrink: 0; font-weight: 500; }
        .col-land { width: 80px; flex-shrink: 0; }
        .col-ort { width: 120px; flex-shrink: 0; }
        .col-adresse { flex: 1; min-width: 200px; }
        .col-portfolio { width: 180px; flex-shrink: 0; }
        .col-flaeche { width: 100px; flex-shrink: 0; text-align: right; justify-content: flex-end; }
        .col-status { width: 120px; flex-shrink: 0; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-badge.in-betrieb {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.in-renovation {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.in-planung {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-badge.ausser-betrieb {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* ===== GALLERY VIEW ===== */
        #gallery-view {
            flex: 1;
            display: none;
            background: #f8f9fa;
            overflow-y: auto;
            padding: 24px;
        }
        
        #gallery-view.active {
            display: block;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .gallery-card {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: pointer;
        }
        
        .gallery-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .gallery-image {
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .gallery-image .material-icons {
            font-size: 64px;
            color: rgba(255,255,255,0.3);
        }
        
        .gallery-image-label {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .gallery-content {
            padding: 16px;
        }
        
        .gallery-title {
            font-size: 15px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }
        
        .gallery-subtitle {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 12px;
        }
        
        .gallery-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .gallery-tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .gallery-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
        }
        
        .gallery-link {
            color: #005ea8;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .gallery-link:hover {
            text-decoration: underline;
        }
        
        .gallery-link .material-icons {
            font-size: 16px;
        }
        
        /* ===== ACCORDION PANEL ===== */
        #accordion-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 280px;
            background: #6B747C;
            color: white;
            z-index: 500;
            display: flex;
            flex-direction: column;
            max-height: calc(100% - 60px);
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #accordion-panel.collapsed {
            display: none;
        }
        
        .accordion-item {
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .accordion-item:last-of-type {
            border-bottom: none;
        }
        
        .accordion-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .accordion-header:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .accordion-header.active {
            background: #E9ECEF;
            color: #333;
        }
        
        .accordion-arrow {
            transition: transform 0.3s;
            display: flex;
            align-items: center;
        }
        
        .accordion-arrow .material-icons {
            font-size: 18px;
        }
        
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
        
        .accordion-header.active .accordion-arrow .material-icons {
            color: #333;
        }
        
        .accordion-content {
            display: none;
            padding: 12px 16px;
            background: #ffffff;
            font-size: 13px;
            color: #333;
        }
        
        .accordion-content.show {
            display: block;
        }
        
        #menu-toggle {
            position: absolute;
            left: 10px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 501;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 180px;
            margin-left: calc((280px - 180px) / 2);
        }
        
        #menu-toggle:hover {
            background: #444;
        }
        
        #menu-toggle .material-icons {
            font-size: 18px;
        }
        
        /* ===== INFO PANEL ===== */
        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 320px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 500;
            display: none;
        }
        
        #info-panel.show {
            display: block;
        }
        
        #info-header {
            background: #f5f5f5;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
        }
        
        #info-header-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        #info-header-actions {
            display: flex;
            gap: 8px;
        }
        
        #info-header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #info-header-actions button:hover {
            color: #333;
        }
        
        #info-header-actions .material-icons {
            font-size: 20px;
        }
        
        #info-body {
            padding: 16px;
        }
        
        .info-section-title {
            background: #f0f0f0;
            padding: 8px 12px;
            margin: -16px -16px 16px -16px;
            font-size: 13px;
            color: #666;
        }
        
        .info-location {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .info-row {
            display: flex;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .info-label {
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: #333;
        }
        
        /* ===== FOOTER ===== */
        #footer {
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 4px 16px;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #coordinates {
            font-family: monospace;
        }
        
        #footer-links a {
            color: #005ea8;
            text-decoration: none;
            margin-left: 16px;
        }
        
        #footer-links a:hover {
            text-decoration: underline;
        }
        
        /* Mapbox Controls */
        .mapboxgl-ctrl-top-right {
            top: 60px;
            right: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="header">
        <div id="logo-area">
            <img id="logo-flag" src="https://www.swisstopo.admin.ch/images/swiss-logo-flag.svg" alt="Schweizer Flagge">
            <img id="logo-text-img" src="https://prod-swisstopoch-hcms-sdweb.imgix.net/2023/12/16/26d017bc-3987-4322-aa29-18052c11eac5.png" alt="Schweizerische Eidgenossenschaft">
        </div>
        
        <div id="search-area">
            <div id="search-container">
                <button id="search-icon-btn">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <input type="text" id="search-input" placeholder="Suche nach Objekten, Grundstücken, Adressen oder Karten" disabled>
            </div>
            
            <div class="view-toggle">
                <button class="view-toggle-btn active" data-view="map" title="Karte">
                    <span class="material-symbols-outlined">map</span>
                </button>
                <button class="view-toggle-btn" data-view="list" title="Liste">
                    <span class="material-symbols-outlined">view_list</span>
                </button>
                <button class="view-toggle-btn" data-view="gallery" title="Galerie">
                    <span class="material-symbols-outlined">grid_view</span>
                </button>
            </div>
        </div>
        
        <div id="header-right">
            <span id="object-count">10 Objekte</span>
            <button class="header-btn" id="filter-btn">
                <span class="material-symbols-outlined">filter_list</span>
                Filter
            </button>
            <button id="login-btn" title="Anmelden">
                <span class="material-symbols-outlined">person_outline</span>
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main">
        <!-- Map View -->
        <div id="map-view" class="active">
            <div id="map"></div>
            
            <!-- Accordion Panel -->
            <nav id="accordion-panel">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Teilen</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Kartenansicht teilen via Link, E-Mail oder Social Media. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Drucken</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Kartenausschnitt als PDF exportieren mit Legende und Massstab. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Zeichnen & Messen auf der Karte</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Werkzeuge zum Zeichnen von Punkten, Linien und Polygonen sowie Distanz- und Flächenmessung. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Export</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Daten exportieren als GeoJSON, CSV, KML oder Shapefile. (Platzhalter)
                    </div>
                </div>
                
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Geokatalog</span>
                        <span class="accordion-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="accordion-content">
                        Verfügbare Hintergrundkarten und Layer durchsuchen und aktivieren. (Platzhalter)
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>OpenStreetMap</li>
                            <li>Satellite Imagery</li>
                            <li>Topografische Karte</li>
                        </ul>
                    </div>
                </div>
            </nav>
            
            <!-- Menu Toggle -->
            <div id="menu-toggle">
                <span class="material-symbols-outlined">expand_less</span>
                <span id="menu-toggle-text">Menü schliessen</span>
            </div>
            
            <!-- Info Panel -->
            <aside id="info-panel">
                <div id="info-header">
                    <span id="info-header-title">Objekt-Information</span>
                    <div id="info-header-actions">
                        <button title="Drucken"><span class="material-symbols-outlined">print</span></button>
                        <button title="Link kopieren"><span class="material-symbols-outlined">link</span></button>
                        <button id="info-close" title="Schliessen"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div id="info-body"></div>
            </aside>
        </div>
        
        <!-- List View -->
        <div id="list-view">
            <div class="list-header">
                <div class="list-header-cell col-id">ID <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-name">Bezeichnung <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-land">Land <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-ort">Ort <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-adresse">Adresse <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-portfolio">Teilportfolio <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-flaeche">Fläche NGF <span class="material-symbols-outlined">unfold_more</span></div>
                <div class="list-header-cell col-status">Status <span class="material-symbols-outlined">unfold_more</span></div>
            </div>
            <div class="list-body" id="list-body"></div>
        </div>
        
        <!-- Gallery View -->
        <div id="gallery-view">
            <div class="gallery-grid" id="gallery-grid"></div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer id="footer">
        <div id="coordinates">WGS 84 | Koordinaten: --</div>
        <div id="footer-links">
            <a href="#">Mehr Informationen</a>
            <a href="#">Hilfe</a>
        </div>
    </footer>

    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';
        
        // Status Farben
        var statusColors = {
            'In Betrieb': '#2e7d32',      // Grün
            'In Renovation': '#f57c00',    // Orange
            'In Planung': '#1976d2',       // Blau
            'Ausser Betrieb': '#757575'    // Grau
        };
        
        // GeoJSON Daten - wird via fetch geladen
        var portfolioData = null;
        
        // Daten laden
        fetch('data/buildings.geojson')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                portfolioData = data;
                
                // Objekt-Zähler aktualisieren
                document.getElementById('object-count').textContent = portfolioData.features.length + ' Objekte';
                
                // Views rendern
                renderListView();
                renderGalleryView();
                
                // Karte initialisieren wenn ready
                if (map.loaded()) {
                    addMapLayers();
                } else {
                    map.on('load', addMapLayers);
                }
            })
            .catch(function(error) {
                console.error('Fehler beim Laden der Daten:', error);
            });
        
        // ===== VIEW MANAGEMENT =====
        var currentView = 'map';
        
        function getViewFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('view') || 'map';
        }
        
        function setViewInURL(view) {
            var url = new URL(window.location);
            url.searchParams.set('view', view);
            window.history.pushState({}, '', url);
        }
        
        function switchView(view) {
            currentView = view;
            setViewInURL(view);
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide views
            document.getElementById('map-view').classList.remove('active');
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('gallery-view').classList.remove('active');
            document.getElementById(view + '-view').classList.add('active');
            
            // Resize map if switching to map view
            if (view === 'map' && window.map) {
                setTimeout(function() { map.resize(); }, 100);
            }
        }
        
        // View toggle click handlers
        document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                switchView(this.dataset.view);
            });
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', function() {
            var view = getViewFromURL();
            switchView(view);
        });
        
        // ===== RENDER LIST VIEW =====
        function renderListView() {
            if (!portfolioData) return;
            
            var listBody = document.getElementById('list-body');
            var html = '';
            
            portfolioData.features.forEach(function(feature) {
                var props = feature.properties;
                var statusClass = props.status === 'In Betrieb' ? 'in-betrieb' : 
                                  props.status === 'In Renovation' ? 'in-renovation' : 
                                  props.status === 'In Planung' ? 'in-planung' : 'ausser-betrieb';
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                
                html += '<div class="list-row" data-id="' + props.id + '">' +
                    '<div class="list-cell col-id">' + props.id + '</div>' +
                    '<div class="list-cell col-name">' + props.name + '</div>' +
                    '<div class="list-cell col-land">' + props.land + '</div>' +
                    '<div class="list-cell col-ort">' + props.ort + '</div>' +
                    '<div class="list-cell col-adresse">' + props.adresse + '</div>' +
                    '<div class="list-cell col-portfolio">' + props.teilportfolio + '</div>' +
                    '<div class="list-cell col-flaeche">' + flaeche + ' m²</div>' +
                    '<div class="list-cell col-status"><span class="status-badge ' + statusClass + '">' + props.status + '</span></div>' +
                '</div>';
            });
            
            listBody.innerHTML = html;
        }
        
        // ===== RENDER GALLERY VIEW =====
        function renderGalleryView() {
            if (!portfolioData) return;
            
            var galleryGrid = document.getElementById('gallery-grid');
            var html = '';
            
            // Color schemes for different portfolio types
            var colorSchemes = {
                'Verwaltungsgebäude': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                'Diplomatische Vertretung': 'linear-gradient(135deg, #c31432 0%, #240b36 100%)',
                'Logistikzentrum': 'linear-gradient(135deg, #f57c00 0%, #ff9800 100%)',
                'Bildungseinrichtung': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                'Wohnliegenschaft': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'Technische Infrastruktur': 'linear-gradient(135deg, #373b44 0%, #4286f4 100%)'
            };
            
            var icons = {
                'Verwaltungsgebäude': 'account_balance',
                'Diplomatische Vertretung': 'public',
                'Logistikzentrum': 'warehouse',
                'Bildungseinrichtung': 'school',
                'Wohnliegenschaft': 'apartment',
                'Technische Infrastruktur': 'dns'
            };
            
            portfolioData.features.forEach(function(feature) {
                var props = feature.properties;
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                var gradient = colorSchemes[props.teilportfolio] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                var icon = icons[props.teilportfolio] || 'business';
                
                html += '<div class="gallery-card" data-id="' + props.id + '">' +
                    '<div class="gallery-image" style="background: ' + gradient + '">' +
                        '<span class="material-symbols-outlined">' + icon + '</span>' +
                        '<div class="gallery-image-label">' + props.land + '</div>' +
                    '</div>' +
                    '<div class="gallery-content">' +
                        '<div class="gallery-title">' + props.name + '</div>' +
                        '<div class="gallery-subtitle">' + props.adresse + '</div>' +
                        '<div class="gallery-meta">' +
                            '<span class="gallery-tag">' + props.teilportfolio + '</span>' +
                            '<span class="gallery-tag">' + flaeche + ' m²</span>' +
                        '</div>' +
                        '<div class="gallery-footer">' +
                            '<span>Baujahr ' + props.baujahr + '</span>' +
                            '<a href="#" class="gallery-link">Details <span class="material-symbols-outlined">arrow_forward</span></a>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            
            galleryGrid.innerHTML = html;
        }
        
        // ===== INITIALIZE MAP =====
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [8.2275, 46.8182],
            zoom: 2
        });
        
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.ScaleControl({ maxWidth: 200 }), 'bottom-left');
        
        map.on('mousemove', function(e) {
            var lng = e.lngLat.lng.toFixed(5);
            var lat = e.lngLat.lat.toFixed(5);
            document.getElementById('coordinates').textContent = 'WGS 84 | Koordinaten: ' + lng + ', ' + lat;
        });
        
        // Map Layers hinzufügen (wird nach Daten-Laden aufgerufen)
        function addMapLayers() {
            if (!portfolioData) return;
            
            map.addSource('portfolio', {
                type: 'geojson',
                data: portfolioData
            });
            
            // Punkte mit statusabhängiger Farbe
            map.addLayer({
                id: 'portfolio-points',
                type: 'circle',
                source: 'portfolio',
                paint: {
                    'circle-radius': 10,
                    'circle-color': [
                        'match',
                        ['get', 'status'],
                        'In Betrieb', '#2e7d32',
                        'In Renovation', '#f57c00',
                        'In Planung', '#1976d2',
                        'Ausser Betrieb', '#757575',
                        '#999999'  // Fallback
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });
            
            map.on('mouseenter', 'portfolio-points', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'portfolio-points', function() {
                map.getCanvas().style.cursor = '';
            });
            
            map.on('click', 'portfolio-points', function(e) {
                var props = e.features[0].properties;
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                var statusColor = statusColors[props.status] || '#999999';
                
                var infoHtml = 
                    '<div class="info-section-title">' + props.teilportfolio + '</div>' +
                    '<div class="info-location">' + props.ort + ', ' + props.land + '</div>' +
                    '<div class="info-row"><span class="info-label">Objekt-ID</span><span class="info-value">' + props.id + '</span></div>' +
                    '<div class="info-row"><span class="info-label">Name</span><span class="info-value">' + props.name + '</span></div>' +
                    '<div class="info-row"><span class="info-label">Adresse</span><span class="info-value">' + props.adresse + '</span></div>' +
                    '<div class="info-row"><span class="info-label">Fläche NGF</span><span class="info-value">' + flaeche + ' m²</span></div>' +
                    '<div class="info-row"><span class="info-label">Baujahr</span><span class="info-value">' + props.baujahr + '</span></div>' +
                    '<div class="info-row"><span class="info-label">Verantwortlich</span><span class="info-value">' + props.verantwortlich + '</span></div>' +
                    '<div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color:' + statusColor + '; font-weight: 600;">' + props.status + '</span></div>';
                
                document.getElementById('info-body').innerHTML = infoHtml;
                document.getElementById('info-panel').classList.add('show');
            });
        }
        
        // ===== ACCORDION =====
        document.querySelectorAll('.accordion-header').forEach(function(header) {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                var isActive = this.classList.contains('active');
                
                document.querySelectorAll('.accordion-header').forEach(function(h) { h.classList.remove('active'); });
                document.querySelectorAll('.accordion-content').forEach(function(c) { c.classList.remove('show'); });
                
                if (!isActive) {
                    this.classList.add('active');
                    content.classList.add('show');
                }
                
                setTimeout(updateMenuTogglePosition, 10);
            });
        });
        
        // ===== MENU TOGGLE =====
        var menuToggle = document.getElementById('menu-toggle');
        var accordionPanel = document.getElementById('accordion-panel');
        var menuToggleText = document.getElementById('menu-toggle-text');
        var menuToggleIcon = menuToggle.querySelector('.material-icons');
        var menuOpen = true;
        
        function updateMenuTogglePosition() {
            var mainRect = document.getElementById('map-view').getBoundingClientRect();
            
            if (menuOpen) {
                var panelRect = accordionPanel.getBoundingClientRect();
                menuToggle.style.top = (panelRect.bottom - mainRect.top) + 'px';
            } else {
                menuToggle.style.top = '10px';
            }
        }
        
        setTimeout(updateMenuTogglePosition, 100);
        
        menuToggle.addEventListener('click', function() {
            menuOpen = !menuOpen;
            
            if (menuOpen) {
                accordionPanel.classList.remove('collapsed');
                menuToggleText.textContent = 'Menü schliessen';
                menuToggleIcon.textContent = 'expand_less';
            } else {
                accordionPanel.classList.add('collapsed');
                menuToggleText.textContent = 'Menü öffnen';
                menuToggleIcon.textContent = 'expand_more';
            }
            
            setTimeout(updateMenuTogglePosition, 10);
        });
        
        var observer = new MutationObserver(function() {
            setTimeout(updateMenuTogglePosition, 10);
        });
        observer.observe(accordionPanel, { attributes: true, childList: true, subtree: true });
        
        // ===== INFO PANEL CLOSE =====
        document.getElementById('info-close').addEventListener('click', function() {
            document.getElementById('info-panel').classList.remove('show');
        });
        
        // ===== INITIALIZE =====
        // Set initial view from URL
        var initialView = getViewFromURL();
        if (initialView !== 'map') {
            switchView(initialView);
        }
    </script>
</body>
</html>
