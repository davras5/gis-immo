<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBL Immobilienportfolio - GIS POC</title>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <style>
        /* ===== CSS CUSTOM PROPERTIES ===== */
        :root {
            /* Grey Scale - Cold blue-grey to match --accent-panel #6C757D */
            --grey-900: #2D3236;
            --grey-800: #3D4347;
            --grey-700: #4E555A;
            --grey-600: #5E666B;
            --grey-500: #6C757D; /* WCAG AA compliant on white, matches accent-panel */
            --grey-300: #C5CCD1;
            --grey-200: #DDE2E6;
            --grey-100: #F3F5F7;
            --grey-50: #F9FAFB;

            /* Brand Colors */
            --accent-panel: #6C757D;
            --primary-red: #c00;
            --primary-red-dark: #a00;
            --white: #ffffff;

            /* Interactive Blue (consolidated) */
            --interactive-blue: #005ea8;
            --focus-ring: var(--interactive-blue);

            /* Status Colors - Unified System */
            --status-active: #2e7d32;
            --status-active-bg: #e8f5e9;
            --status-active-text: #1b5e20;

            --status-renovation: #ef6c00;
            --status-renovation-bg: #fff3e0;
            --status-renovation-text: #e65100;

            --status-planning: #1976d2;
            --status-planning-bg: #e3f2fd;
            --status-planning-text: #0d47a1;

            --status-inactive: #6C757D;
            --status-inactive-bg: var(--grey-100);
            --status-inactive-text: #5E666B;

            /* Legacy semantic colors (mapped to new system) */
            --success-green: var(--status-active);
            --warning-orange: var(--status-renovation-text);
            --info-blue: var(--status-planning);

            /* ===== TYPOGRAPHY SYSTEM ===== */
            /* Type Scale (1.25 ratio - Major Third) */
            --text-xs: 0.75rem;     /* 12px - minimum accessible size */
            --text-sm: 0.875rem;    /* 14px - secondary text */
            --text-base: 1rem;      /* 16px - body text */
            --text-lg: 1.125rem;    /* 18px - large text */
            --text-xl: 1.25rem;     /* 20px - headings */
            --text-2xl: 1.5rem;     /* 24px - large headings */

            /* Line Heights */
            --leading-tight: 1.25;
            --leading-snug: 1.375;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;

            /* Font Weights */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* ===== SPACING SYSTEM ===== */
            /* 4px base unit scale */
            --space-0: 0;
            --space-1: 0.25rem;     /* 4px */
            --space-2: 0.5rem;      /* 8px */
            --space-3: 0.75rem;     /* 12px */
            --space-4: 1rem;        /* 16px */
            --space-5: 1.25rem;     /* 20px */
            --space-6: 1.5rem;      /* 24px */
            --space-8: 2rem;        /* 32px */
            --space-10: 2.5rem;     /* 40px */
            --space-12: 3rem;       /* 48px */
            --space-16: 4rem;       /* 64px */

            /* ===== COMPONENT TOKENS ===== */
            /* Border Radius */
            --radius-sm: 0.25rem;   /* 4px */
            --radius-md: 0.5rem;    /* 8px */
            --radius-lg: 0.75rem;   /* 12px */
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 4px 16px rgba(0, 0, 0, 0.2);

            /* Touch Target (WCAG 2.1 minimum) */
            --touch-target-min: 44px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: var(--grey-900);
        }
        
        /* ===== HEADER ===== */
        #header {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            display: flex;
            align-items: center;
            padding: 0 var(--space-5);
            height: 90px;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }
        
        #logo-area {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }
        
        #logo-flag {
            width: 25px;
            height: auto;
        }
        
        #logo-text-img {
            height: 50px;
            width: auto;
        }
        
        #search-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-4);
            padding: 0 var(--space-10);
        }
        
        #search-wrapper {
            position: relative;
            width: 100%;
            max-width: 550px;
            z-index: 2000;
        }

        #search-container {
            display: flex;
            align-items: center;
            border: 1px solid var(--grey-300);
            border-radius: var(--radius-sm);
            width: 100%;
            overflow: hidden;
            background: var(--white);
            height: var(--touch-target-min);
        }
        
        #search-icon-btn {
            background: var(--grey-100);
            border: none;
            border-right: 1px solid var(--grey-300);
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #search-icon-btn:hover {
            background: var(--grey-200);
        }
        
        #search-icon-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }
        
        #search-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            outline: none;
        }
        
        #search-input::placeholder {
            color: var(--grey-500);
        }

        /* NEW: Search Clear Button */
        #search-clear-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            color: var(--grey-500);
            height: 100%;
        }

        #search-clear-btn:hover {
            color: var(--grey-900);
            background: var(--grey-50);
        }

        #search-clear-btn .material-symbols-outlined {
            font-size: 18px;
        }

        #search-clear-btn.visible {
            display: flex;
        }

        /* Spinner style */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--grey-100);
            border-top: 2px solid var(--grey-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }

        #search-results.active {
            display: block;
        }

        .search-section-header {
            background: var(--accent-panel);
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-100);
            transition: background 0.15s;
        }

        .search-item:hover {
            background: var(--grey-100);
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--grey-900);
        }

        .search-item-title b {
            color: var(--primary-red);
        }

        .search-item-subtitle {
            font-size: 12px;
            color: var(--grey-600);
            margin-top: 2px;
        }
        
        .view-toggle {
            display: flex;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            height: 40px;
        }
        
        .view-toggle-btn {
            background: var(--white);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-right: 1px solid var(--grey-300);
            transition: background 0.2s, padding 0.2s;
        }
        
        .view-toggle-btn:last-child {
            border-right: none;
        }
        
        .view-toggle-btn:hover {
            background: var(--grey-100);
        }
        
        .view-toggle-btn.active {
            background: var(--accent-panel);
        }
        
        .view-toggle-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }
        
        .view-toggle-btn.active .material-symbols-outlined {
            color: var(--white);
        }
        
        .view-toggle-btn .view-label {
            display: none;
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-900);
        }
        
        .view-toggle-btn.active .view-label {
            display: inline;
            color: var(--white);
        }
        
        #header-right {
            display: flex;
            align-items: center;
            gap: 32px;
            min-width: 250px;
            justify-content: flex-end;
        }

        #filter-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #object-count {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 500;
            padding: 0 8px;
        }
        
        .header-btn {
            background: var(--white);
            border: 1px solid var(--grey-300);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            height: 40px;
            gap: 6px;
            transition: background 0.2s;
        }
        
        .header-btn:hover {
            background: var(--grey-100);
        }
        
        .header-btn .material-symbols-outlined {
            font-size: 18px;
        }
        
        #login-btn {
            background: var(--white);
            border: 1px solid var(--grey-300);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #login-btn:hover {
            background: var(--grey-100);
        }
        
        #login-btn .material-symbols-outlined {
            font-size: 22px;
            color: var(--grey-600);
        }
        
        /* ===== MAIN CONTENT ===== */
        #main {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* ===== MAP VIEW ===== */
        #map-view {
            flex: 1;
            position: relative;
            display: none;
        }
        
        #map-view.active {
            display: flex;
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        /* ===== LIST VIEW ===== */
        #list-view {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--grey-50);
            overflow-y: auto;
            padding: 24px;
        }

        #list-view.active {
            display: flex;
        }

        /* ===== SHARED TOOLBAR STYLES ===== */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--grey-100);
            background: var(--grey-50);
        }

        .toolbar-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            padding: 8px 12px;
            min-width: 250px;
        }

        .toolbar-search .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-500);
        }

        .toolbar-search input {
            border: none;
            outline: none;
            font-size: 14px;
            width: 100%;
            background: transparent;
        }

        .toolbar-search input::placeholder {
            color: var(--grey-500);
        }

        .toolbar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* List View Toolbar - extends .toolbar */
        .list-toolbar-search {
            min-width: 280px;
        }

        /* Dropdown Button Styles */
        .dropdown-container {
            position: relative;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-size: 13px;
            color: var(--grey-700);
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .dropdown-btn:hover {
            background: var(--grey-50);
            border-color: var(--grey-500);
        }

        .dropdown-btn .material-symbols-outlined {
            font-size: 18px;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--white);
            border: 1px solid var(--grey-200);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu-header {
            padding: 10px 14px;
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--grey-100);
        }

        .dropdown-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: var(--grey-700);
            cursor: pointer;
            transition: background 0.15s;
        }

        .dropdown-menu-item:hover {
            background: var(--grey-50);
        }

        .dropdown-menu-item .material-symbols-outlined {
            font-size: 18px;
            color: var(--grey-500);
        }

        .dropdown-menu-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .dropdown-menu-divider {
            height: 1px;
            background: var(--grey-100);
            margin: 4px 0;
        }

        .dropdown-menu-toggle-row {
            display: flex;
            gap: 8px;
            padding: 8px 14px;
        }

        .dropdown-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--grey-700);
            background: var(--grey-100);
            border: 1px solid var(--grey-200);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }

        .dropdown-toggle-btn:hover {
            background: var(--grey-200);
            border-color: var(--grey-300);
        }

        /* List Table Container */
        .list-table-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
        }

        .list-table-wrapper {
            overflow-x: auto;
            padding: 0 var(--space-5);
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .list-table th {
            position: sticky;
            top: 0;
            background: var(--white);
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 1px solid var(--grey-300);
            white-space: nowrap;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .list-table th:hover {
            background: var(--grey-50);
        }

        .list-table th .material-symbols-outlined {
            font-size: 16px;
            color: var(--grey-500);
            vertical-align: middle;
            margin-left: 4px;
        }

        .list-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
            white-space: nowrap;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .list-table tbody tr:hover {
            background: var(--grey-50);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            line-height: var(--leading-tight);
        }
        
        .status-badge.in-betrieb {
            background: var(--status-active-bg);
            color: var(--status-active-text);
        }

        .status-badge.in-renovation {
            background: var(--status-renovation-bg);
            color: var(--status-renovation-text);
        }

        .status-badge.in-planung {
            background: var(--status-planning-bg);
            color: var(--status-planning-text);
        }

        .status-badge.ausser-betrieb {
            background: var(--status-inactive-bg);
            color: var(--status-inactive-text);
        }
        
        /* ===== GALLERY VIEW ===== */
        #gallery-view {
            flex: 1;
            display: none;
            background: var(--grey-50);
            overflow-y: auto;
            padding: 24px;
        }
        
        #gallery-view.active {
            display: block;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .gallery-card {
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: pointer;
        }
        
        .gallery-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .gallery-image {
            height: 180px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .gallery-image .material-symbols-outlined {
            font-size: 64px;
            color: rgba(255,255,255,0.3);
        }
        
        .gallery-image-label {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
        }
        
        .gallery-content {
            padding: 16px;
        }
        
        .gallery-title {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--grey-900);
            margin-bottom: var(--space-1);
            line-height: var(--leading-snug);
        }
        
        .gallery-subtitle {
            font-size: 13px;
            color: var(--grey-600);
            margin-bottom: 12px;
        }
        
        .gallery-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .gallery-tag {
            background: var(--grey-100);
            color: var(--grey-600);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
        }
        
        .gallery-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--grey-100);
            font-size: 12px;
            color: var(--grey-600);
        }
        
        .gallery-link {
            color: var(--interactive-blue);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .gallery-link:hover {
            text-decoration: underline;
        }
        
        .gallery-link .material-symbols-outlined {
            font-size: 16px;
        }
        
        /* ===== DETAIL VIEW ===== */
        #detail-view {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--grey-50);
            overflow: hidden;
        }
        
        #detail-view.active {
            display: flex;
        }
        
        .detail-header {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            padding: 12px 24px;
        }
        
        .detail-header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--grey-600);
        }
        
        .breadcrumb .material-symbols-outlined {
            font-size: 18px;
            color: var(--grey-500);
        }
        
        .breadcrumb a {
            color: var(--grey-600);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            color: var(--grey-900);
            text-decoration: underline;
        }
        
        .breadcrumb span.current {
            color: var(--grey-900);
            font-weight: 500;
        }
        
        .detail-header-actions {
            display: flex;
            gap: 16px;
        }
        
        .btn-edit {
            background: var(--grey-900);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-edit:hover {
            background: var(--grey-800);
        }
        
        .btn-edit .material-symbols-outlined {
            font-size: 16px;
        }
        
        .btn-back {
            background: var(--white);
            color: var(--grey-900);
            border: 1px solid var(--grey-300);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-back:hover {
            background: var(--grey-100);
        }
        
        .btn-back .material-symbols-outlined {
            font-size: 16px;
        }
        
        .detail-tabs {
            background: var(--white);
            border-bottom: 1px solid var(--grey-300);
            padding: 0 24px;
        }
        
        .detail-tabs-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }
        
        .detail-tab {
            padding: 14px 20px;
            font-size: 14px;
            color: var(--grey-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .detail-tab:hover {
            color: var(--grey-900);
            background: var(--grey-50);
        }
        
        .detail-tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            font-weight: 500;
        }
        
        .detail-tab.disabled {
            color: var(--grey-500);
            cursor: not-allowed;
        }
        
        .detail-tab.disabled:hover {
            color: var(--grey-500);
            background: transparent;
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .detail-left,
        .detail-right {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .detail-section {
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .detail-section-title {
            background: var(--grey-100);
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--grey-900);
            border-bottom: 1px solid var(--grey-300);
            line-height: var(--leading-snug);
        }

        .detail-section-content {
            padding: var(--space-5);
        }
        
        /* Image Carousel */
        .carousel {
            position: relative;
            height: 340px;
            background: var(--grey-100);
        }
        
        .carousel-image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }
        
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        
        .carousel-btn:hover {
            background: var(--white);
        }
        
        .carousel-btn.prev {
            left: 16px;
        }
        
        .carousel-btn.next {
            right: 16px;
        }
        
        .carousel-btn .material-symbols-outlined {
            font-size: 24px;
            color: var(--grey-900);
        }
        
        .carousel-dots {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .carousel-dot.active {
            background: var(--white);
        }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
        }

        .data-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .data-item.full-width {
            grid-column: 1 / -1;
        }

        .data-label {
            font-size: var(--text-xs);
            color: var(--grey-600);
            line-height: var(--leading-normal);
        }

        .data-value {
            font-size: var(--text-sm);
            color: var(--grey-900);
            font-weight: var(--font-medium);
            line-height: var(--leading-normal);
        }
        
        /* Mini Map */
        .mini-map-container {
            height: 340px;
            margin-bottom: 16px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .mini-map {
            width: 100%;
            height: 100%;
        }
        
        .address-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .address-table th {
            background: var(--grey-100);
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 1px solid var(--grey-300);
        }
        
        .address-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--grey-100);
        }
        
        .address-table tr:last-child td {
            border-bottom: none;
        }
        
        .address-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary-red);
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .address-marker .material-symbols-outlined {
            font-size: 14px;
            color: var(--white);
        }
        
        /* ===== ACCORDION PANEL ===== */
        #accordion-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 380px;
            background: var(--accent-panel);
            color: white;
            z-index: 500;
            display: flex;
            flex-direction: column;
            max-height: calc(100% - 60px);
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #accordion-panel.collapsed {
            display: none;
        }
        
        .accordion-item {
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .accordion-item:last-of-type {
            border-bottom: none;
        }
        
        .accordion-header {
            padding: 12px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: rgba(255,255,255,0.1);
        }

        .accordion-header.active {
            background: var(--grey-100);
            color: var(--grey-900);
        }

        .accordion-arrow {
            transition: transform 0.3s;
            display: flex;
            align-items: center;
        }

        .accordion-arrow .material-symbols-outlined {
            font-size: 18px;
        }

        .accordion-header.active .accordion-arrow {
            transform: rotate(90deg);
        }

        .accordion-header.active .accordion-arrow .material-symbols-outlined {
            color: var(--grey-900);
        }
        
        .accordion-content {
            display: none;
            padding: 12px 16px;
            background: var(--white);
            font-size: 13px;
            color: var(--grey-900);
        }
        
        .accordion-content.show {
            display: block;
        }

        /* ===== SHARE PANEL ===== */
        .share-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .share-icons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .share-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            border: none;
            background: var(--grey-900);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }

        .share-icon-btn:hover {
            background: var(--grey-600);
            transform: scale(1.05);
        }

        .share-icon-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .share-link-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .share-link-label {
            font-size: 12px;
            color: var(--grey-600);
        }

        .share-link-row {
            display: flex;
            gap: 8px;
        }

        .share-link-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-size: 13px;
            color: var(--grey-900);
            background: var(--grey-50);
        }

        .share-link-input:focus {
            outline: none;
            border-color: var(--accent-panel);
        }

        .share-copy-btn {
            padding: 8px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            background: var(--white);
            color: var(--grey-900);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s, border-color 0.2s;
        }

        .share-copy-btn:hover {
            background: var(--grey-100);
            border-color: var(--grey-500);
        }

        .share-copy-btn.copied {
            background: var(--status-active);
            color: white;
            border-color: var(--status-active);
        }

        /* ===== GEOKATALOG TREE ===== */
        .geokatalog-header .geokatalog-theme-switch {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: normal;
            margin-left: auto;
        }

        .geokatalog-header.active .geokatalog-theme-switch {
            color: var(--grey-600);
        }

        .geokatalog-content {
            padding: 0 !important;
        }

        /* Full height when Geokatalog is expanded */
        #geokatalog-accordion.expanded {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #geokatalog-accordion.expanded .accordion-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #geokatalog-accordion.expanded .geokatalog-tree {
            flex: 1;
            max-height: none;
        }

        .geokatalog-tree {
            max-height: 450px;
            overflow-y: auto;
            padding: 0;
        }

        .geokatalog-tree::-webkit-scrollbar {
            width: 6px;
        }

        .geokatalog-tree::-webkit-scrollbar-track {
            background: var(--grey-100);
        }

        .geokatalog-tree::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .catalog-item {
            user-select: none;
        }

        .catalog-node {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--grey-900);
            border-bottom: 1px solid var(--grey-300);
        }

        .catalog-node:hover {
            background: var(--grey-100);
        }

        .catalog-node .node-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            color: var(--grey-500);
        }

        .catalog-node .node-arrow .material-symbols-outlined {
            font-size: 16px;
            transition: transform 0.15s ease;
        }

        .catalog-node.expanded .node-arrow .material-symbols-outlined {
            transform: rotate(90deg);
        }

        .catalog-node.leaf .node-arrow {
            display: none;
        }

        /* Leaf node with checkbox */
        .catalog-node .node-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--grey-500);
            border-radius: 3px;
            margin-right: 10px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .catalog-node .node-checkbox:hover {
            border-color: var(--grey-600);
        }

        .catalog-node .node-label {
            flex: 1;
        }

        .catalog-node .node-info {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            color: var(--grey-600);
            cursor: pointer;
            flex-shrink: 0;
        }

        .catalog-node .node-info .material-symbols-outlined {
            font-size: 18px;
        }

        .catalog-node .node-info:hover {
            color: var(--grey-900);
        }

        .catalog-children {
            display: none;
            margin-left: 20px;
        }

        .catalog-item.expanded > .catalog-children {
            display: block;
        }

        .geokatalog-loading {
            text-align: center;
            padding: 20px;
            color: var(--grey-500);
        }

        .geokatalog-error {
            text-align: center;
            padding: 20px;
            color: var(--primary-red);
            font-size: 12px;
        }

        #menu-toggle {
            position: absolute;
            left: 10px;
            background: var(--grey-900);
            color: white;
            padding: 10px 20px 10px 12px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 501;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: auto;
            margin-left: calc((380px - 180px) / 2);
        }
        
        #menu-toggle:hover {
            background: var(--grey-800);
        }
        
        #menu-toggle .material-symbols-outlined {
            font-size: 18px;
        }
        
        /* ===== INFO PANEL ===== */
        #info-panel {
            position: absolute;
            top: 10px;
            right: 60px;
            width: 320px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 500;
            display: none;
        }
        
        #info-panel.show {
            display: block;
        }
        
        #info-preview-image {
            height: 140px;
            background-size: cover;
            background-position: center;
            background-color: var(--grey-100);
        }
        
        #info-header {
            background: var(--grey-100);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--grey-300);
        }
        
        #info-header-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        #info-header-actions {
            display: flex;
            gap: 8px;
        }
        
        #info-header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--grey-600);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #info-header-actions button:hover {
            color: var(--grey-900);
        }
        
        #info-header-actions .material-symbols-outlined {
            font-size: 20px;
        }
        
        #info-body {
            padding: 16px;
        }
        
        .info-section-title {
            background: var(--grey-100);
            padding: 8px 12px;
            margin: -16px -16px 16px -16px;
            font-size: 13px;
            color: var(--grey-600);
        }
        
        .info-location {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--grey-100);
        }
        
        .info-row {
            display: flex;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .info-label {
            color: var(--grey-600);
            width: 120px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: var(--grey-900);
        }
        
        .info-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--grey-100);
        }
        
        .info-detail-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--grey-900);
            color: var(--white);
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        
        .info-detail-link:hover {
            background: var(--grey-800);
        }
        
        .info-detail-link .material-symbols-outlined {
            font-size: 18px;
        }
        
        /* ===== FOOTER ===== */
        #footer {
            background: var(--grey-100);
            border-top: 1px solid var(--grey-300);
            padding: 4px 16px;
            font-size: 12px;
            color: var(--grey-600);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #coordinates {
            font-family: monospace;
        }
        
        #footer-links a {
            color: var(--interactive-blue);
            text-decoration: none;
            margin-left: 16px;
        }
        
        #footer-links a:hover {
            text-decoration: underline;
        }
        
        /* Mapbox Controls */
        .mapboxgl-ctrl-top-right {
            top: 10px;
            right: 10px;
        }

        /* Home Button Control - matches Mapbox default control size for visual consistency */
        .map-home-btn {
            background: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            width: 29px;
            height: 29px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }

        .map-home-btn:hover {
            background: var(--grey-100);
        }

        .map-home-btn .material-symbols-outlined {
            font-size: 18px;
            color: var(--grey-600);
        }

        /* ===== FLOATING CONTROLS (bottom-right) ===== */
        .floating-controls {
            position: absolute;
            bottom: 40px;
            right: 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            z-index: 500;
            transition: right 0.3s ease;
        }

        /* Move floating controls left when filter-pane is open */
        .main-content:has(#filter-pane.open) .floating-controls {
            right: 360px; /* 340px filter + 20px margin */
        }

        /* Move floating controls when AI panel is open */
        #main:has(#ai-assistant-panel.show) .floating-controls {
            right: 20px; /* Stay at edge of shrunken .main-content */
        }

        /* When both panels are open */
        #main:has(#ai-assistant-panel.show) .main-content:has(#filter-pane.open) .floating-controls {
            right: 360px;
        }

        /* ===== STYLE SWITCHER ===== */
        .style-switcher {
            position: relative;
            display: none;
        }

        .style-switcher.visible {
            display: block;
        }

        .style-switcher-btn {
            background: var(--white);
            border: 2px solid var(--grey-300);
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .style-switcher-btn:hover {
            border-color: var(--grey-500);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .style-switcher-btn.active {
            border-color: var(--primary-red);
            background: var(--grey-100);
        }

        .style-switcher-btn img {
            width: 80px;
            height: 60px;
            border-radius: 2px;
            object-fit: cover;
        }

        .style-switcher-btn span {
            font-size: var(--text-xs);
            color: var(--grey-600);
            font-weight: var(--font-medium);
        }

        .style-switcher-panel {
            position: absolute;
            bottom: 0;
            right: 100%;
            margin-right: 10px;
            background: var(--white);
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            padding: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(10px);
            transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
        }

        .style-switcher-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .style-option {
            background: var(--white);
            border: 2px solid var(--grey-300);
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: border-color 0.2s, transform 0.15s;
        }

        .style-option:hover {
            border-color: var(--grey-500);
            transform: translateY(-2px);
        }

        .style-option.active {
            border-color: var(--primary-red);
            border-width: 3px;
            padding: 3px;
        }

        .style-option img {
            width: 70px;
            height: 50px;
            border-radius: 2px;
            object-fit: cover;
        }

        .style-option span {
            font-size: var(--text-xs);
            color: var(--grey-600);
            font-weight: var(--font-medium);
            white-space: nowrap;
        }

        .style-option.active span {
            color: var(--primary-red);
            font-weight: var(--font-semibold);
        }

        /* ===== AI ASSISTANT BUTTON ===== */
        .ai-assistant-btn {
            background: var(--white);
            border: 2px solid var(--grey-300);
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .ai-assistant-btn:hover {
            border-color: var(--grey-500);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .ai-assistant-btn.active {
            border-color: var(--primary-red);
            background: var(--grey-100);
        }

        .ai-assistant-btn .ai-btn-icon {
            width: 80px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--grey-100);
            border-radius: 2px;
        }

        .ai-assistant-btn .material-symbols-outlined {
            font-size: 36px;
            color: var(--grey-600);
        }

        .ai-assistant-btn.active .material-symbols-outlined {
            color: var(--primary-red);
        }

        .ai-assistant-btn span:not(.material-symbols-outlined):not(.ai-btn-icon) {
            font-size: var(--text-xs);
            color: var(--grey-600);
            font-weight: var(--font-medium);
            white-space: nowrap;
        }

        .ai-assistant-btn.active span:not(.material-symbols-outlined):not(.ai-btn-icon) {
            color: var(--primary-red);
            font-weight: var(--font-semibold);
        }

        /* ===== AI ASSISTANT PANEL ===== */
        #ai-assistant-panel {
            width: 0;
            min-width: 0;
            height: 100%;
            background: var(--white);
            border-left: 1px solid var(--grey-300);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease, min-width 0.3s ease;
            flex-shrink: 0;
        }

        #ai-assistant-panel.show {
            width: 400px;
            min-width: 400px;
            box-shadow: -4px 0 16px rgba(0,0,0,0.15);
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--grey-200);
            background: var(--grey-50);
        }

        .ai-panel-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--grey-900);
        }

        .ai-panel-header-title .material-symbols-outlined {
            font-size: 24px;
            color: var(--grey-600);
        }

        .ai-panel-close {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .ai-panel-close:hover {
            background: var(--grey-200);
        }

        .ai-panel-close .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }

        .ai-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .ai-chat-message {
            margin-bottom: 20px;
        }

        .ai-chat-message-label {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--grey-700);
            margin-bottom: 8px;
        }

        .ai-chat-message-content {
            font-size: var(--text-sm);
            color: var(--grey-800);
            line-height: 1.6;
        }

        .ai-chat-message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .ai-chat-message-content li {
            margin-bottom: 4px;
        }

        .ai-panel-input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--grey-200);
            background: var(--grey-50);
        }

        .ai-panel-input-field {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--white);
            border: 1px solid var(--grey-300);
            border-radius: 24px;
            padding: 10px 16px;
        }

        .ai-panel-input-field .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-400);
        }

        .ai-panel-input-field input {
            flex: 1;
            border: none;
            outline: none;
            font-size: var(--text-sm);
            color: var(--grey-800);
            background: transparent;
        }

        .ai-panel-input-field input::placeholder {
            color: var(--grey-400);
        }

        .ai-panel-send-btn {
            background: var(--grey-200);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ai-panel-send-btn:hover {
            background: var(--grey-300);
        }

        .ai-panel-send-btn .material-symbols-outlined {
            font-size: 18px;
            color: var(--grey-600);
        }

        /* ===== TAB CONTENT SWITCHING ===== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== DETAIL TABLE (shared styles for Bemessungen & Dokumente) ===== */
        .detail-table-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Detail Table Toolbar - extends .toolbar */
        .detail-table-actions {
            gap: 12px;
        }

        .btn-action {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--grey-600);
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }

        .btn-action:hover:not(:disabled) {
            background: var(--grey-100);
            color: var(--grey-900);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-action .material-symbols-outlined {
            font-size: 18px;
        }

        /* Detail Table Base */
        .detail-table-wrapper {
            overflow-x: auto;
            padding: 0 var(--space-5);
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 13px;
        }

        .detail-table th {
            background: var(--white);
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 1px solid var(--grey-300);
            white-space: nowrap;
        }

        .detail-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .detail-table th.sortable:hover {
            background: var(--grey-50);
        }

        .detail-table th .sort-icon {
            font-size: 16px;
            vertical-align: middle;
            margin-left: 4px;
        }

        .detail-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        .detail-table tbody tr:hover {
            background: var(--grey-50);
        }

        .detail-table tbody tr.selected {
            background: var(--status-planning-bg);
        }

        .detail-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Shared column: checkbox (4% in both tables) */
        .detail-table .col-checkbox {
            width: 4%;
            text-align: center;
        }

        /* ===== SHARED DETAIL TABLE STYLES ===== */
        .detail-table .col-id   { width: 12%; }
        .detail-table .col-type { width: 18%; }

        /* ===== MEASUREMENTS TABLE: 9 columns = 100% ===== */
        /* checkbox:4% + id:20% + type:18% + area:10% + source:10% + accuracy:10% + standard:10% + from:9% + until:9% = 100% */
        #measurements-table .col-area     { width: 10%; text-align: right; }
        #measurements-table .col-source   { max-width: 10%; }
        #measurements-table .col-accuracy { max-width: 10%; }
        #measurements-table .col-standard { max-width: 10%; }
        #measurements-table .col-from     { max-width: 9%; }
        #measurements-table .col-until    { max-width: 9%; }

        /* ===== DOCUMENTS TABLE: 7 columns = 100% ===== */
        /* checkbox:4% + id:20% + title:30% + type:16% + format:10% + date:10% + size:10% = 100% */
        #documents-table .col-title  { width: 34%; }
        #documents-table .col-format { max-width: 10%; }
        #documents-table .col-date   { max-width: 10%; }
        #documents-table .col-size   { width: auto;}

        /* ===== KONTAKTE TABLE: 7 columns = 100% ===== */
        /* checkbox:4% + id:12% + name:20% + rolle:16% + org:18% + telefon:15% + email:15% = 100% */
        #kontakte-table .col-kontakt-id      { width: 12%; }
        #kontakte-table .col-kontakt-name    { width: 20%; }
        #kontakte-table .col-kontakt-rolle   { width: 16%; }
        #kontakte-table .col-kontakt-org     { width: 18%; }
        #kontakte-table .col-kontakt-telefon { width: 15%; }
        #kontakte-table .col-kontakt-email   { width: auto; }

        #kontakte-table .col-kontakt-telefon a,
        #kontakte-table .col-kontakt-email a {
            color: var(--primary-red);
            text-decoration: none;
        }
        #kontakte-table .col-kontakt-telefon a:hover,
        #kontakte-table .col-kontakt-email a:hover {
            text-decoration: underline;
        }

        /* ===== KOSTEN TABLE: 7 columns = 100% ===== */
        /* checkbox:4% + id:10% + gruppe:12% + art:26% + betrag:16% + einheit:14% + stichtag:auto */
        #kosten-table .col-kosten-id       { width: 10%; }
        #kosten-table .col-kosten-gruppe   { width: 12%; }
        #kosten-table .col-kosten-art      { width: 26%; }
        #kosten-table .col-kosten-betrag   { width: 16%; text-align: right; }
        #kosten-table .col-kosten-einheit  { width: 14%; }
        #kosten-table .col-kosten-stichtag { width: auto; }

        #kosten-table td.col-kosten-betrag {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        /* ===== VERTRAEGE TABLE: 8 columns = 100% ===== */
        /* checkbox:4% + id:9% + art:17% + partner:26% + beginn:10% + ende:10% + betrag:14% + status:10% = 100% */
        #vertraege-table .col-vertrag-id      { width: 9%; }
        #vertraege-table .col-vertrag-art     { width: 17%; }
        #vertraege-table .col-vertrag-partner { width: 26%; }
        #vertraege-table .col-vertrag-beginn  { width: 10%; }
        #vertraege-table .col-vertrag-ende    { width: 10%; }
        #vertraege-table .col-vertrag-betrag  { width: 14%; text-align: right; }
        #vertraege-table .col-vertrag-status  { width: 10%; }

        #vertraege-table td.col-vertrag-betrag {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .vertrag-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .vertrag-status.aktiv {
            background: rgba(46, 125, 50, 0.1);
            color: #2e7d32;
        }
        .vertrag-status.gekuendigt {
            background: rgba(245, 124, 0, 0.1);
            color: #f57c00;
        }
        .vertrag-status.ausgelaufen {
            background: rgba(117, 117, 117, 0.1);
            color: #757575;
        }

        /* ===== AUSSTATTUNG TABLE: 7 columns = 100% ===== */
        /* checkbox:4% + id:10% + bezeichnung:24% + kategorie:14% + hersteller:18% + baujahr:10% + standort:auto */
        #ausstattung-table .col-ausstattung-id          { width: 10%; }
        #ausstattung-table .col-ausstattung-bezeichnung { width: 24%; }
        #ausstattung-table .col-ausstattung-kategorie   { width: 14%; }
        #ausstattung-table .col-ausstattung-hersteller  { width: 18%; }
        #ausstattung-table .col-ausstattung-baujahr     { width: 10%; text-align: center; }
        #ausstattung-table .col-ausstattung-standort    { width: auto; }

        #ausstattung-table td.col-ausstattung-baujahr {
            text-align: center;
        }

        .kategorie-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(107, 116, 124, 0.1);
            color: var(--accent-panel);
        }

        /* ===== FILTER PANE ===== */
        #filter-pane {
            width: 0;
            min-width: 0;
            height: 100%;
            background: var(--white);
            border-left: 1px solid var(--grey-300);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease, min-width 0.3s ease;
            flex-shrink: 0;
        }

        #filter-pane.open {
            width: 340px;
            min-width: 340px;
        }

        #filter-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--grey-200);
            background: var(--grey-50);
            flex-shrink: 0;
        }

        .filter-pane-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--grey-900);
        }

        .filter-pane-title .material-symbols-outlined {
            font-size: 24px;
            color: var(--grey-600);
        }

        #filter-pane-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-pane-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--grey-600);
            border-radius: 4px;
            transition: background 0.2s;
        }

        .filter-pane-btn:hover {
            background: var(--grey-200);
        }

        .filter-pane-btn .material-symbols-outlined {
            font-size: 20px;
        }

        #filter-pane-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .filter-section {
            border-bottom: 1px solid var(--grey-200);
        }

        .filter-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            cursor: pointer;
            background: var(--white);
            transition: background 0.2s;
        }

        .filter-section-header:hover {
            background: var(--grey-50);
        }

        .filter-section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--grey-900);
        }

        .filter-section-arrow {
            display: flex;
            align-items: center;
            transition: transform 0.2s;
        }

        .filter-section-arrow .material-symbols-outlined {
            font-size: 20px;
            color: var(--grey-600);
        }

        .filter-section.open .filter-section-arrow {
            transform: rotate(180deg);
        }

        .filter-section-content {
            display: none;
            padding: 0 20px 16px 20px;
        }

        .filter-section.open .filter-section-content {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--primary-red);
        }

        .filter-option label {
            font-size: 14px;
            color: var(--grey-900);
            cursor: pointer;
            flex: 1;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--grey-100);
            border: 1px solid var(--grey-300);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--grey-900);
            margin: 4px;
        }

        .filter-chip-remove {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            color: var(--grey-600);
        }

        .filter-chip-remove:hover {
            color: var(--primary-red);
        }

        .filter-chip-remove .material-symbols-outlined {
            font-size: 16px;
        }

        /* Filter button - pane open state */
        #filter-btn.pane-open {
            background: var(--accent-panel);
            border-color: var(--accent-panel);
            color: var(--white);
        }

        #filter-btn.pane-open .material-symbols-outlined {
            color: var(--white);
        }

        /* Filter button - active filters state */
        #filter-btn.has-active-filters {
            background: rgba(204, 0, 0, 0.1); /* --primary-red at 10% opacity */
        }

        #filter-btn.has-active-filters.pane-open {
            background: var(--accent-panel);
        }

        /* Filter count badge */
        .filter-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            background: var(--primary-red);
            color: var(--white);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            margin-left: 6px;
        }

        /* ===== FOCUS VISIBLE STYLES (Accessibility) ===== */
        *:focus {
            outline: none;
        }

        *:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        [tabindex]:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        .view-toggle-btn:focus-visible,
        .dropdown-btn:focus-visible,
        .header-btn:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            z-index: 1;
        }

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--grey-900);
            color: var(--white);
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
            font-size: 14px;
        }

        .skip-link:focus {
            top: 0;
        }

        /* ===== UNIFIED BUTTON STYLES ===== */
        /* Primary Button */
        .btn-primary {
            background: var(--grey-900);
            color: var(--white);
            border: none;
            padding: var(--space-2) var(--space-5);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            line-height: var(--leading-normal);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            transition: background 0.2s;
            min-height: var(--touch-target-min);
        }

        .btn-primary:hover {
            background: var(--grey-700);
        }

        .btn-primary:active {
            background: var(--grey-900);
        }

        /* Secondary Button */
        .btn-secondary {
            background: var(--white);
            color: var(--grey-900);
            border: 1px solid var(--grey-300);
            padding: var(--space-2) var(--space-5);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            line-height: var(--leading-normal);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            transition: background 0.2s, border-color 0.2s;
            min-height: var(--touch-target-min);
        }

        .btn-secondary:hover {
            background: var(--grey-100);
            border-color: var(--grey-500);
        }

        /* Tertiary Button (text-only) */
        .btn-tertiary {
            background: transparent;
            color: var(--grey-700);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            transition: background 0.2s, color 0.2s;
            min-height: var(--touch-target-min);
        }

        .btn-tertiary:hover {
            background: var(--grey-100);
            color: var(--grey-900);
        }

        /* ===== EMPTY & LOADING STATES ===== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-16) var(--space-5);
            text-align: center;
            color: var(--grey-600);
        }

        .empty-state .material-symbols-outlined {
            font-size: 64px;
            color: var(--grey-300);
            margin-bottom: var(--space-4);
        }

        .empty-state-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--grey-900);
            margin-bottom: var(--space-2);
            line-height: var(--leading-snug);
        }

        .empty-state-description {
            font-size: var(--text-sm);
            color: var(--grey-600);
            max-width: 400px;
            line-height: var(--leading-normal);
        }

        .empty-state-action {
            margin-top: var(--space-5);
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-16) var(--space-5);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--grey-200);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: var(--grey-600);
        }

        /* ===== STATUS BADGES WITH ICONS (Accessibility for colorblind users) ===== */
        .status-badge .status-icon {
            font-size: 12px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .status-badge.in-betrieb .status-icon::before {
            content: "\e876"; /* check_circle */
            font-family: 'Material Symbols Outlined';
        }

        .status-badge.in-renovation .status-icon::before {
            content: "\e8b8"; /* build */
            font-family: 'Material Symbols Outlined';
        }

        .status-badge.in-planung .status-icon::before {
            content: "\e873"; /* schedule */
            font-family: 'Material Symbols Outlined';
        }

        .status-badge.ausser-betrieb .status-icon::before {
            content: "\e5c9"; /* close */
            font-family: 'Material Symbols Outlined';
        }

        /* ===== RESPONSIVE DESIGN ===== */

        /* Tablet breakpoint (768px - 1024px) */
        @media screen and (max-width: 1024px) {
            #header {
                padding: 0 16px;
                height: 70px;
            }

            #logo-text-img {
                height: 40px;
            }

            #search-area {
                padding: 0 16px;
                gap: 12px;
            }

            #search-wrapper {
                max-width: 400px;
            }

            #header-right {
                min-width: auto;
                gap: 16px;
            }

            #accordion-panel {
                width: 320px;
            }

            #menu-toggle {
                margin-left: calc((320px - 160px) / 2);
            }

            #info-panel {
                width: 300px;
                right: 10px;
            }

            .detail-grid {
                gap: 16px;
            }

            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 16px;
                padding: 16px;
            }

            #gallery-view {
                padding: 16px;
            }
        }

        /* Mobile breakpoint (< 768px) */
        @media screen and (max-width: 767px) {
            #header {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 16px;
                gap: 12px;
            }

            #logo-area {
                order: 1;
            }

            #logo-text-img {
                height: 32px;
            }

            #header-right {
                order: 2;
                margin-left: auto;
            }

            #filter-controls {
                gap: 4px;
            }

            #object-count {
                display: none;
            }

            .header-btn span:not(.material-symbols-outlined) {
                display: none;
            }

            .header-btn {
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                justify-content: center;
            }

            #search-area {
                order: 3;
                width: 100%;
                padding: 0;
                flex-wrap: wrap;
            }

            #search-wrapper {
                max-width: 100%;
                flex: 1;
                min-width: 200px;
            }

            .view-toggle {
                flex-shrink: 0;
            }

            .view-toggle-btn {
                padding: 8px 10px;
            }

            .view-toggle-btn .view-label {
                display: none !important;
            }

            /* Accordion panel - full width bottom sheet on mobile */
            #accordion-panel {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 60vh;
                margin: 0;
                border-radius: 16px 16px 0 0;
            }

            #menu-toggle {
                position: fixed;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                margin-left: 0;
                width: auto;
                padding: 10px 20px;
            }

            #accordion-panel.collapsed + #menu-toggle {
                bottom: 10px;
            }

            /* Info panel - full width bottom sheet on mobile */
            #info-panel {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 70vh;
                border-radius: 16px 16px 0 0;
                overflow-y: auto;
            }

            /* Style switcher position on mobile */
            .style-switcher {
                bottom: 80px;
                right: 10px;
            }

            .style-switcher-panel {
                right: 0;
                bottom: 100%;
                margin-bottom: 10px;
                margin-right: 0;
                flex-direction: column;
            }

            /* List view adjustments */
            .toolbar {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }

            .toolbar-search {
                width: 100%;
                min-width: auto;
            }

            .toolbar-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .list-table {
                font-size: 12px;
            }

            .list-table th,
            .list-table td {
                padding: 10px 8px;
            }

            /* Hide some columns on mobile */
            .list-table .col-adresse,
            .list-table .col-portfolio {
                display: none;
            }

            /* Gallery view adjustments */
            #gallery-view {
                padding: 12px;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .gallery-card {
                display: flex;
                flex-direction: row;
            }

            .gallery-image {
                width: 120px;
                height: auto;
                min-height: 120px;
                flex-shrink: 0;
            }

            .gallery-content {
                flex: 1;
                padding: 12px;
            }

            .gallery-title {
                font-size: 14px;
            }

            .gallery-subtitle {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .gallery-meta {
                margin-bottom: 8px;
            }

            .gallery-tag {
                font-size: var(--text-xs);
                padding: 2px 6px;
            }

            /* Detail view adjustments */
            .detail-header {
                padding: 12px 16px;
            }

            .detail-header-inner {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .breadcrumb {
                font-size: 12px;
                flex-wrap: wrap;
            }

            .detail-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .detail-tabs {
                padding: 0 16px;
                overflow-x: auto;
            }

            .detail-tabs-inner {
                min-width: max-content;
            }

            .detail-tab {
                padding: 12px 14px;
                font-size: 13px;
                white-space: nowrap;
            }

            .detail-content {
                padding: 16px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .carousel {
                height: 200px;
            }

            .mini-map-container {
                height: 200px;
            }

            .address-table {
                font-size: var(--text-xs);
            }

            .address-table th,
            .address-table td {
                padding: 6px 4px;
            }

            /* Filter pane - full screen overlay on mobile */
            #filter-pane {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100% !important;
                min-width: 100% !important;
                z-index: 2000;
                border-left: none;
            }

            #filter-pane:not(.open) {
                display: none;
            }

            /* Footer adjustments */
            #footer {
                padding: var(--space-2) var(--space-3);
                font-size: var(--text-xs);
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            #coordinates {
                font-size: var(--text-xs);
            }

            #footer-links a {
                margin-left: 12px;
            }
        }

        /* Small mobile (< 480px) */
        @media screen and (max-width: 479px) {
            #logo-text-img {
                display: none;
            }

            .view-toggle-btn {
                padding: 8px;
            }

            #info-panel {
                max-height: 80vh;
            }

            #info-preview-image {
                height: 100px;
            }

            .gallery-image {
                width: 100px;
                min-height: 100px;
            }

            .detail-tab {
                padding: var(--space-2) var(--space-3);
                font-size: var(--text-xs);
            }
        }

        /* Print styles */
        @media print {
            #header,
            #footer,
            #accordion-panel,
            #info-panel,
            .style-switcher,
            #menu-toggle,
            .btn-back,
            .btn-edit,
            #filter-pane {
                display: none !important;
            }

            #main {
                height: auto;
                overflow: visible;
            }

            .detail-view {
                overflow: visible;
            }

            .detail-content {
                overflow: visible;
            }
        }

    </style>
</head>
<body>
    <!-- Skip link for keyboard navigation -->
    <a href="#main" class="skip-link">Zum Hauptinhalt springen</a>

    <header id="header" role="banner">
        <div id="logo-area">
            <img id="logo-flag" src="https://www.swisstopo.admin.ch/images/swiss-logo-flag.svg" alt="Schweizer Flagge">
            <img id="logo-text-img" src="https://prod-swisstopoch-hcms-sdweb.imgix.net/2023/12/16/26d017bc-3987-4322-aa29-18052c11eac5.png" alt="Schweizerische Eidgenossenschaft">
        </div>
        
        <div id="search-area" role="search">
            <div id="search-wrapper">
                <div id="search-container">
                    <button id="search-icon-btn" aria-label="Suche starten" type="button">
                        <span class="material-symbols-outlined" aria-hidden="true">search</span>
                    </button>
                    <input type="search" id="search-input" placeholder="Suche nach Objekten, Orten oder Karten" aria-label="Suchbegriff eingeben" autocomplete="off">
                    <button id="search-clear-btn" title="Suche lschen" aria-label="Suche lschen" type="button">
                        <span class="material-symbols-outlined" aria-hidden="true">close</span>
                    </button>
                    <div id="search-spinner" class="spinner" role="status" aria-label="Suche luft"></div>
                </div>
                <div id="search-results" role="listbox" aria-label="Suchergebnisse"></div>
            </div>

            <div class="view-toggle" role="tablist" aria-label="Ansicht whlen">
                <button class="view-toggle-btn active" data-view="map" title="Karte" aria-label="Kartenansicht" role="tab" aria-selected="true">
                    <span class="material-symbols-outlined" aria-hidden="true">map</span>
                    <span class="view-label">Karte</span>
                </button>
                <button class="view-toggle-btn" data-view="list" title="Tabelle" aria-label="Tabellenansicht" role="tab" aria-selected="false">
                    <span class="material-symbols-outlined" aria-hidden="true">view_list</span>
                    <span class="view-label">Tabelle</span>
                </button>
                <button class="view-toggle-btn" data-view="gallery" title="Galerie" aria-label="Galerieansicht" role="tab" aria-selected="false">
                    <span class="material-symbols-outlined" aria-hidden="true">grid_view</span>
                    <span class="view-label">Galerie</span>
                </button>
            </div>
        </div>

        <div id="header-right">
            <div id="filter-controls">
                <span id="object-count" aria-live="polite">10 Objekte</span>
                <button class="header-btn" id="filter-btn" aria-label="Filter ffnen" aria-expanded="false" aria-controls="filter-pane">
                    <span class="material-symbols-outlined" aria-hidden="true">filter_list</span>
                    Filter
                </button>
            </div>
            <div id="login-area">
                <button id="login-btn" title="Anmelden" aria-label="Anmelden">
                    <span class="material-symbols-outlined" aria-hidden="true">person</span>
                </button>
            </div>
        </div>
    </header>

    <main id="main">
        <div class="main-content">
            <div id="map-view" class="active">
            <div id="map"></div>
            
            <nav id="accordion-panel">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-arrow"><span class="material-symbols-outlined">chevron_right</span></span>
                        <span>Teilen</span>
                    </div>
                    <div class="accordion-content">
                        <div class="share-panel">
                            <div class="share-icons" role="group" aria-label="Teilen ber soziale Medien">
                                <!-- Email -->
                                <button class="share-icon-btn" onclick="shareViaEmail()" title="Per E-Mail teilen" aria-label="Per E-Mail teilen">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                    </svg>
                                </button>
                                <!-- Facebook -->
                                <button class="share-icon-btn" onclick="shareViaFacebook()" title="Auf Facebook teilen" aria-label="Auf Facebook teilen">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/>
                                    </svg>
                                </button>
                                <!-- LinkedIn -->
                                <button class="share-icon-btn" onclick="shareViaLinkedIn()" title="Auf LinkedIn teilen" aria-label="Auf LinkedIn teilen">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
                                    </svg>
                                </button>
                                <!-- X (Twitter) -->
                                <button class="share-icon-btn" onclick="shareViaX()" title="Auf X teilen" aria-label="Auf X teilen">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="share-link-section">
                                <span class="share-link-label">Link zum Teilen:</span>
                                <div class="share-link-row">
                                    <input type="text" id="share-link-input" class="share-link-input" readonly aria-label="Link zum Teilen">
                                    <button class="share-copy-btn" onclick="copyShareLink()" aria-label="Link in die Zwischenablage kopieren">Link kopieren</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-arrow"><span class="material-symbols-outlined">chevron_right</span></span>
                        <span>Drucken</span>
                    </div>
                    <div class="accordion-content">
                        Exportieren Sie den aktuellen Kartenausschnitt als PDF-Dokument mit Legende, Massstab und Nordpfeil fr Berichte und Prsentationen.
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-arrow"><span class="material-symbols-outlined">chevron_right</span></span>
                        <span>Zeichnen & Messen auf der Karte</span>
                    </div>
                    <div class="accordion-content">
                        Zeichnen Sie Punkte, Linien und Polygone direkt auf der Karte. Messen Sie Distanzen in Metern oder Kilometern und berechnen Sie Flchen in Quadratmetern.
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-arrow"><span class="material-symbols-outlined">chevron_right</span></span>
                        <span>Export</span>
                    </div>
                    <div class="accordion-content">
                        Exportieren Sie Portfolio-Daten in verschiedenen Formaten: GeoJSON fr Web-Anwendungen, CSV fr Excel, KML fr Google Earth oder Shapefile fr GIS-Software.
                    </div>
                </div>

                <div class="accordion-item" id="geokatalog-accordion">
                    <div class="accordion-header geokatalog-header">
                        <span class="accordion-arrow"><span class="material-symbols-outlined">chevron_right</span></span>
                        <span>Geokatalog</span>
                        <span class="geokatalog-theme-switch">Thema wechseln</span>
                    </div>
                    <div class="accordion-content geokatalog-content">
                        <div id="geokatalog-tree" class="geokatalog-tree">
                            <div class="geokatalog-loading">Lade Katalog...</div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <div id="menu-toggle">
                <span class="material-symbols-outlined">expand_less</span>
                <span id="menu-toggle-text">Men schliessen</span>
            </div>
            
            <aside id="info-panel" role="complementary" aria-label="Objektinformation">
                <div id="info-preview-image" role="img" aria-label="Vorschaubild des Objekts"></div>
                <div id="info-header">
                    <span id="info-header-title">Objekt-Information</span>
                    <div id="info-header-actions">
                        <button title="Drucken" aria-label="Objektinformation drucken"><span class="material-symbols-outlined" aria-hidden="true">print</span></button>
                        <button title="Link kopieren" aria-label="Link zum Objekt kopieren"><span class="material-symbols-outlined" aria-hidden="true">link</span></button>
                        <button id="info-close" title="Schliessen" aria-label="Informationspanel schliessen"><span class="material-symbols-outlined" aria-hidden="true">close</span></button>
                    </div>
                </div>
                <div id="info-body"></div>
            </aside>
        </div>

        <div id="list-view">
            <!-- Table Container -->
            <div class="list-table-container">
                <!-- Toolbar -->
                <div class="toolbar">
                    <div class="toolbar-search list-toolbar-search">
                        <span class="material-symbols-outlined">search</span>
                        <input type="text" id="list-search-input" placeholder="Tabelle durchsuchen...">
                    </div>
                    <div class="toolbar-actions">
                        <!-- Export Dropdown -->
                        <div class="dropdown-container">
                            <button class="dropdown-btn" id="export-dropdown-btn">
                                <span class="material-symbols-outlined">download</span>
                                Export
                                <span class="material-symbols-outlined">expand_more</span>
                            </button>
                            <div class="dropdown-menu" id="export-dropdown-menu">
                                <div class="dropdown-menu-header">Exportieren als</div>
                                <div class="dropdown-menu-item" onclick="handleExport('csv')">
                                    <span class="material-symbols-outlined">table_view</span>
                                    CSV (.csv)
                                </div>
                                <div class="dropdown-menu-item" onclick="handleExport('excel')">
                                    <span class="material-symbols-outlined">grid_on</span>
                                    Excel (.xlsx)
                                </div>
                                <div class="dropdown-menu-item" onclick="handleExport('geojson')">
                                    <span class="material-symbols-outlined">map</span>
                                    GeoJSON (.geojson)
                                </div>
                            </div>
                        </div>
                        <!-- Columns Dropdown -->
                        <div class="dropdown-container">
                            <button class="dropdown-btn" id="columns-dropdown-btn">
                                <span class="material-symbols-outlined">view_column</span>
                                Spalten
                                <span class="material-symbols-outlined">expand_more</span>
                            </button>
                            <div class="dropdown-menu" id="columns-dropdown-menu">
                                <div class="dropdown-menu-header">Spalten anzeigen</div>
                                <div class="dropdown-menu-toggle-row">
                                    <button class="dropdown-toggle-btn" onclick="toggleAllColumns(true)">Alle</button>
                                    <button class="dropdown-toggle-btn" onclick="toggleAllColumns(false)">Keine</button>
                                </div>
                                <div class="dropdown-menu-divider"></div>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-id"> ID
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-name"> Bezeichnung
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-land"> Land
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-ort"> Ort
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-adresse"> Adresse
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-portfolio"> Teilportfolio
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-flaeche"> Flche NGF
                                </label>
                                <label class="dropdown-menu-item">
                                    <input type="checkbox" checked data-column="col-status"> Status
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-table-wrapper">
                    <table class="list-table" id="list-table">
                        <thead>
                            <tr>
                                <th class="col-id">ID <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-name">Bezeichnung <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-land">Land <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-ort">Ort <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-adresse">Adresse <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-portfolio">Teilportfolio <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-flaeche">Flche NGF <span class="material-symbols-outlined">unfold_more</span></th>
                                <th class="col-status">Status <span class="material-symbols-outlined">unfold_more</span></th>
                            </tr>
                        </thead>
                        <tbody id="list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="gallery-view">
            <div class="gallery-grid" id="gallery-grid"></div>
        </div>
        
        <div id="detail-view">
            <div class="detail-header">
                <div class="detail-header-inner">
                    <div class="breadcrumb" id="detail-breadcrumb">
                        <span class="material-symbols-outlined">public</span>
                        <a href="#" onclick="navigateToAllObjects(); return false;">Alle Objekte</a>
                        <span>></span>
                        <a href="#" id="breadcrumb-country-link" onclick="navigateWithLandFilter(); return false;"><span id="breadcrumb-country">Land</span></a>
                        <span>></span>
                        <a href="#" id="breadcrumb-region-link" onclick="navigateWithRegionFilter(); return false;"><span id="breadcrumb-region">Region</span></a>
                        <span>></span>
                        <span class="current" id="breadcrumb-name">Objekt</span>
                    </div>
                    <div class="detail-header-actions">
                        <button class="btn-edit">
                            <span class="material-symbols-outlined">edit</span>
                            Bearbeiten
                        </button>
                        <button class="btn-back" id="btn-back">
                            <span class="material-symbols-outlined">arrow_back</span>
                            Zurck
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="detail-tabs">
                <div class="detail-tabs-inner">
                    <div class="detail-tab active" data-tab="uebersicht">bersicht</div>
                    <div class="detail-tab" data-tab="bemessungen">Bemessungen</div>
                    <div class="detail-tab" data-tab="kosten">Kosten</div>
                    <div class="detail-tab" data-tab="vertraege">Vertrge</div>
                    <div class="detail-tab" data-tab="ausstattung">Ausstattung</div>
                    <div class="detail-tab" data-tab="dokumente">Dokumente</div>
                    <div class="detail-tab" data-tab="kontakte">Kontakte</div>
                </div>
            </div>
            
            <div class="detail-content">
                <!-- Tab Content: bersicht -->
                <div class="tab-content active" data-content="uebersicht">
                <div class="detail-grid">
                    <div class="detail-left">
                        <div class="detail-section">
                            <div class="detail-section-title">Bilder</div>
                            <div class="carousel" id="detail-carousel">
                                <div class="carousel-image" id="carousel-image"></div>
                                <button class="carousel-btn prev" onclick="carouselPrev()">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <button class="carousel-btn next" onclick="carouselNext()">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                                <div class="carousel-dots" id="carousel-dots"></div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Zustzliche Informationen</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Baujahr</span>
                                        <span class="data-value" id="detail-baujahr"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Sanierung</span>
                                        <span class="data-value" id="detail-sanierung"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Ladestationen fr Elektrofahrzeuge</span>
                                        <span class="data-value" id="detail-ladestationen"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Denkmalschutz</span>
                                        <span class="data-value" id="detail-denkmalschutz"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Parkpltze</span>
                                        <span class="data-value" id="detail-parkplaetze"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Anzahl Geschosse</span>
                                        <span class="data-value" id="detail-geschosse"></span>
                                    </div>
                                    <div class="data-item full-width">
                                        <span class="data-label">Baubewilligung</span>
                                        <span class="data-value" id="detail-baubewilligung"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Energiestatistik</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Energieklasse</span>
                                        <span class="data-value" id="detail-energieklasse"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Wrmeerzeuger Heizung</span>
                                        <span class="data-value" id="detail-waermeerzeuger"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Energie-/Wrmequelle Heizung</span>
                                        <span class="data-value" id="detail-waermequelle"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Wrmeerzeuger Warmwasser</span>
                                        <span class="data-value" id="detail-warmwasser"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-right">
                        <div class="detail-section">
                            <div class="detail-section-title">Objekt Stammdaten</div>
                            <div class="detail-section-content">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Bezeichnung Objekt</span>
                                        <span class="data-value" id="detail-name"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Bezeichnung Grundstck</span>
                                        <span class="data-value" id="detail-grundstueck-name"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">ID Objekt</span>
                                        <span class="data-value" id="detail-id"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">ID Grundstck</span>
                                        <span class="data-value" id="detail-grundstueck-id"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">EGID Objekt (nur Schweiz)</span>
                                        <span class="data-value" id="detail-egid"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">EGRID Grundstck (nur Schweiz)</span>
                                        <span class="data-value" id="detail-egrid"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Gltig von</span>
                                        <span class="data-value" id="detail-gueltig-von"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Gltig bis</span>
                                        <span class="data-value" id="detail-gueltig-bis">Keine Angabe</span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Teilportfolio</span>
                                        <span class="data-value" id="detail-teilportfolio"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Objektart Bund 1</span>
                                        <span class="data-value" id="detail-objektart1"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Teilportfolio Gruppe</span>
                                        <span class="data-value" id="detail-teilportfolio-gruppe"></span>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Objektart Bund 2</span>
                                        <span class="data-value" id="detail-objektart2"></span>
                                    </div>
                                    <div class="data-item full-width">
                                        <span class="data-label">Art Eigentum</span>
                                        <span class="data-value" id="detail-eigentum"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">Adresse</div>
                            <div class="detail-section-content">
                                <div class="mini-map-container">
                                    <div id="mini-map" class="mini-map"></div>
                                </div>
                                <table class="address-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Land</th>
                                            <th>Region</th>
                                            <th>Stadt</th>
                                            <th>Postleitzahl</th>
                                            <th>Strasse</th>
                                            <th>Hausnummer</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <span class="address-marker">
                                                    <span class="material-symbols-outlined">location_on</span>
                                                </span>
                                            </td>
                                            <td id="detail-country"></td>
                                            <td id="detail-region"></td>
                                            <td id="detail-city"></td>
                                            <td id="detail-plz"></td>
                                            <td id="detail-street"></td>
                                            <td id="detail-housenumber"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Tab Content: Bemessungen -->
                <div class="tab-content" data-content="bemessungen">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Bemessungen</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="measurements-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action measurements-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action measurements-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action measurements-action" disabled>
                                        <span class="material-symbols-outlined">open_in_new</span>
                                        Anzeigen
                                    </button>
                                    <button class="btn-back" id="btn-add-measurement">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="measurements-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-measurements">
                                            </th>
                                            <th class="col-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-type sortable" data-sort="areaType">
                                                Bemessungsart
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-area sortable" data-sort="value">
                                                Wert
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-source">Herkunft</th>
                                            <th class="col-accuracy sortable" data-sort="accuracy">
                                                Genauigkeit
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-standard sortable" data-sort="standard">
                                                Standard
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-from sortable" data-sort="validFrom">
                                                Gltig von
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-until">Gltig bis</th>
                                        </tr>
                                    </thead>
                                    <tbody id="measurements-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Kosten -->
                <div class="tab-content" data-content="kosten">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Kosten</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="kosten-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action kosten-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action kosten-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action kosten-action" disabled>
                                        <span class="material-symbols-outlined">description</span>
                                        Details
                                    </button>
                                    <button class="btn-back" id="btn-add-kosten">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="kosten-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-kosten">
                                            </th>
                                            <th class="col-kosten-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kosten-gruppe sortable" data-sort="kostengruppe">
                                                Kostengruppe
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kosten-art sortable" data-sort="kostenart">
                                                Kostenart
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kosten-betrag sortable" data-sort="betrag">
                                                Betrag
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kosten-einheit sortable" data-sort="einheit">
                                                Einheit
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kosten-stichtag sortable" data-sort="stichtag">
                                                Stichtag
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="kosten-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Vertrge -->
                <div class="tab-content" data-content="vertraege">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Vertrge</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="vertraege-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action vertraege-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action vertraege-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action vertraege-action" disabled>
                                        <span class="material-symbols-outlined">description</span>
                                        Details
                                    </button>
                                    <button class="btn-back" id="btn-add-vertrag">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="vertraege-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-vertraege">
                                            </th>
                                            <th class="col-vertrag-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-art sortable" data-sort="vertragsart">
                                                Vertragsart
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-partner sortable" data-sort="vertragspartner">
                                                Vertragspartner
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-beginn sortable" data-sort="vertragsbeginn">
                                                Beginn
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-ende sortable" data-sort="vertragsende">
                                                Ende
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-betrag sortable" data-sort="betrag">
                                                Betrag/Jahr
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-vertrag-status sortable" data-sort="status">
                                                Status
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="vertraege-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Ausstattung -->
                <div class="tab-content" data-content="ausstattung">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Ausstattung</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="ausstattung-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action ausstattung-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action ausstattung-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action ausstattung-action" disabled>
                                        <span class="material-symbols-outlined">info</span>
                                        Details
                                    </button>
                                    <button class="btn-back" id="btn-add-ausstattung">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="ausstattung-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-ausstattung">
                                            </th>
                                            <th class="col-ausstattung-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-ausstattung-bezeichnung sortable" data-sort="bezeichnung">
                                                Bezeichnung
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-ausstattung-kategorie sortable" data-sort="kategorie">
                                                Kategorie
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-ausstattung-hersteller sortable" data-sort="hersteller">
                                                Hersteller
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-ausstattung-baujahr sortable" data-sort="baujahr">
                                                Baujahr
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-ausstattung-standort sortable" data-sort="standort">
                                                Standort
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ausstattung-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Dokumente -->
                <div class="tab-content" data-content="dokumente">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Dokumente</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="documents-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action documents-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action documents-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action documents-action" disabled>
                                        <span class="material-symbols-outlined">download</span>
                                        Herunterladen
                                    </button>
                                    <button class="btn-back" id="btn-add-document">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="documents-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-documents">
                                            </th>
                                            <th class="col-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-title sortable" data-sort="titel">
                                                Titel
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-type sortable" data-sort="dokumentTyp">
                                                Typ
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-format">Format</th>
                                            <th class="col-date sortable" data-sort="datum">
                                                Datum
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-size">Grsse</th>
                                        </tr>
                                    </thead>
                                    <tbody id="documents-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Kontakte -->
                <div class="tab-content" data-content="kontakte">
                    <div class="detail-table-container">
                        <div class="detail-section">
                            <div class="detail-section-title">Kontakte</div>

                            <div class="toolbar">
                                <div class="toolbar-search">
                                    <span class="material-symbols-outlined">search</span>
                                    <input type="text" id="kontakte-filter" placeholder="Alle Spalten filtern">
                                </div>
                                <div class="toolbar-actions detail-table-actions">
                                    <button class="btn-action kontakte-action" disabled>
                                        <span class="material-symbols-outlined">edit</span>
                                        Bearbeiten
                                    </button>
                                    <button class="btn-action kontakte-action" disabled>
                                        <span class="material-symbols-outlined">delete</span>
                                        Lschen
                                    </button>
                                    <button class="btn-action kontakte-action" disabled>
                                        <span class="material-symbols-outlined">mail</span>
                                        Kontaktieren
                                    </button>
                                    <button class="btn-back" id="btn-add-kontakt">
                                        <span class="material-symbols-outlined">add</span>
                                        Hinzufgen
                                    </button>
                                </div>
                            </div>

                            <div class="detail-table-wrapper">
                                <table class="detail-table" id="kontakte-table">
                                    <thead>
                                        <tr>
                                            <th class="col-checkbox">
                                                <input type="checkbox" id="select-all-kontakte">
                                            </th>
                                            <th class="col-kontakt-id sortable" data-sort="id">
                                                ID
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kontakt-name sortable" data-sort="name">
                                                Name
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kontakt-rolle sortable" data-sort="rolle">
                                                Rolle
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kontakt-org sortable" data-sort="organisation">
                                                Organisation
                                                <span class="material-symbols-outlined sort-icon">unfold_more</span>
                                            </th>
                                            <th class="col-kontakt-telefon">Telefon</th>
                                            <th class="col-kontakt-email">E-Mail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kontakte-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Pane -->
        <aside id="filter-pane">
            <div id="filter-pane-header">
                <div class="filter-pane-title">
                    <span class="material-symbols-outlined">filter_alt</span>
                    Suchfilter
                </div>
                <div id="filter-pane-actions">
                    <button class="filter-pane-btn" id="filter-reset-btn" title="Filter zurcksetzen">
                        <span class="material-symbols-outlined">replay</span>
                    </button>
                    <button class="filter-pane-btn" id="filter-close-btn" title="Schliessen">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <div id="filter-pane-body">
                <!-- Status -->
                <div class="filter-section open" data-filter="status">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Status</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-status-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>

                <!-- Art Eigentum -->
                <div class="filter-section open" data-filter="eigentum">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Art Eigentum</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-eigentum-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>

                <!-- Teilportfolio -->
                <div class="filter-section open" data-filter="teilportfolio">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Teilportfolio</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-teilportfolio-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>

                <!-- Gebudeart -->
                <div class="filter-section open" data-filter="gebaeudeart">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Gebudeart</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-gebaeudeart-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>

                <!-- Land -->
                <div class="filter-section open" data-filter="land">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Land</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-land-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>

                <!-- Region -->
                <div class="filter-section open" data-filter="region">
                    <div class="filter-section-header">
                        <span class="filter-section-title">Region</span>
                        <span class="filter-section-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </div>
                    <div class="filter-section-content" id="filter-region-options">
                        <!-- Options populated dynamically -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Floating Controls (bottom-right) -->
        <div class="floating-controls" id="floating-controls">
            <!-- Style Switcher (visible only in map view) -->
            <div class="style-switcher" id="style-switcher">
                <div class="style-switcher-panel" id="style-panel">
                    <button class="style-option active" data-style="light-v11" title="Light">
                        <img id="thumb-light-v11" src="" alt="Light">
                        <span>Light</span>
                    </button>
                    <button class="style-option" data-style="streets-v12" title="Standard">
                        <img id="thumb-streets-v12" src="" alt="Standard">
                        <span>Standard</span>
                    </button>
                    <button class="style-option" data-style="satellite-v9" title="Luftbild">
                        <img id="thumb-satellite-v9" src="" alt="Luftbild">
                        <span>Luftbild</span>
                    </button>
                    <button class="style-option" data-style="satellite-streets-v12" title="Luftbild + Strassen">
                        <img id="thumb-satellite-streets-v12" src="" alt="Luftbild + Strassen">
                        <span>Hybrid</span>
                    </button>
                </div>
                <button class="style-switcher-btn" id="style-switcher-btn" title="Hintergrund wechseln">
                    <img id="current-style-thumb" src="" alt="Aktueller Stil">
                    <span>Hintergrund</span>
                </button>
            </div>
            <!-- AI Assistant Toggle -->
            <button class="ai-assistant-btn" id="ai-assistant-btn" title="KI Assistent">
                <span class="ai-btn-icon">
                    <span class="material-symbols-outlined">smart_toy</span>
                </span>
                <span>KI Assistent</span>
            </button>
        </div>
        </div><!-- /.main-content -->

        <!-- AI Assistant Panel -->
        <aside id="ai-assistant-panel" role="complementary" aria-label="KI Assistent">
            <div class="ai-panel-header">
                <div class="ai-panel-header-title">
                    <span class="material-symbols-outlined">smart_toy</span>
                    KI Assistent
                </div>
                <button class="ai-panel-close" id="ai-panel-close" title="Schliessen">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="ai-panel-content" id="ai-panel-content">
                <div class="ai-chat-message">
                    <div class="ai-chat-message-label">Benutzer:</div>
                    <div class="ai-chat-message-content">
                        Hallo, ich mchte gerne die aktuellen Vermietungszahlen unserer Immobilien sehen.
                    </div>
                </div>
                <div class="ai-chat-message">
                    <div class="ai-chat-message-label">KI Assistent:</div>
                    <div class="ai-chat-message-content">
                        Hallo! Natrlich, ich kann Ihnen dabei helfen. Mchten Sie die Vermietungszahlen fr ein bestimmtes Quartal oder das gesamte Jahr sehen?
                    </div>
                </div>
                <div class="ai-chat-message">
                    <div class="ai-chat-message-label">Benutzer:</div>
                    <div class="ai-chat-message-content">
                        Zeigen Sie mir bitte die Vermietungszahlen fr das zweite Quartal 2024.
                    </div>
                </div>
                <div class="ai-chat-message">
                    <div class="ai-chat-message-label">KI Assistent:</div>
                    <div class="ai-chat-message-content">
                        Hier sind die Vermietungszahlen fr das zweite Quartal 2024:
                        <ul>
                            <li>Anzahl der vermieteten Einheiten: 120</li>
                            <li>Durchschnittliche Vermietungsdauer: 6 Monate</li>
                            <li>Durchschnittliche Mieteinnahmen pro Einheit: 1.200 CHF</li>
                        </ul>
                        Ich erstelle auch einen Chart zur besseren Visualisierung der Daten.
                    </div>
                </div>
            </div>
            <div class="ai-panel-input">
                <div class="ai-panel-input-field">
                    <span class="material-symbols-outlined">attach_file</span>
                    <input type="text" placeholder="Eine Frage an KI Assistent stellen" id="ai-panel-input">
                </div>
                <button class="ai-panel-send-btn" id="ai-panel-send" title="Senden">
                    <span class="material-symbols-outlined">arrow_upward</span>
                </button>
            </div>
        </aside>
    </main>

    <footer id="footer">
        <div id="coordinates">WGS 84 | Koordinaten: --</div>
        <div id="footer-links">
            <a href="https://www.admin.ch/gov/de/start/rechtliches.html" target="_blank">Rechtliches</a>
            <a href="https://github.com/davras5/gis-immo" target="_blank">Quellcode</a>
        </div>
    </footer>

    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';
        
        // Status Farben (synchronized with CSS --status-* variables)
        var statusColors = {
            'In Betrieb': '#2e7d32',      // --status-active
            'In Renovation': '#ef6c00',   // --status-renovation
            'In Planung': '#1976d2',      // --status-planning
            'Ausser Betrieb': '#6C757D'   // --status-inactive
        };
        
        // Placeholder images
        var placeholderImages = [
            'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1554435493-93422e8220c8?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1577495508048-b635879837f1?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800&h=600&fit=crop'
        ];
        
        // Variables
        var portfolioData = null;
        var filteredData = null;
        var currentDetailBuilding = null;

        // Entity data stores (loaded from separate JSON files)
        var allAreaMeasurements = [];
        var allDocuments = [];
        var allContacts = [];
        var allContracts = [];
        var allAssets = [];
        var allCosts = [];
        var currentCarouselIndex = 0;
        var miniMap = null;
        var previousView = 'gallery';
        var selectedBuildingId = null;
        var searchMarker = null;

        // View dirty flags - track if view needs re-render after filter change
        var listViewDirty = false;
        var galleryViewDirty = false;

        // ===== FILTER STATE =====
        var activeFilters = {
            status: [],
            eigentum: [],
            teilportfolio: [],
            gebaeudeart: [],
            land: [],
            region: []
        };

        // Filter configuration - maps filter keys to data properties
        var filterConfig = {
            status: { property: 'status', label: 'Status' },
            eigentum: { property: 'eigentum', label: 'Art Eigentum' },
            teilportfolio: { property: 'teilportfolio', label: 'Teilportfolio' },
            gebaeudeart: { property: 'objektart1', label: 'Gebudeart' },
            land: { property: 'land', label: 'Land' },
            region: { property: 'region', label: 'Region' }
        };

        // ===== FILTER FUNCTIONS =====

        function getFiltersFromURL() {
            var params = new URLSearchParams(window.location.search);
            var filters = {
                status: [],
                eigentum: [],
                teilportfolio: [],
                gebaeudeart: [],
                land: [],
                region: []
            };

            Object.keys(filters).forEach(function(key) {
                var value = params.get('filter_' + key);
                if (value) {
                    filters[key] = value.split(',').map(function(v) {
                        return decodeURIComponent(v);
                    });
                }
            });

            return filters;
        }

        function setFiltersInURL(filters) {
            var url = new URL(window.location);

            // Remove all filter params first
            Object.keys(filters).forEach(function(key) {
                url.searchParams.delete('filter_' + key);
            });

            // Add active filters
            Object.keys(filters).forEach(function(key) {
                if (filters[key].length > 0) {
                    var encoded = filters[key].map(function(v) {
                        return encodeURIComponent(v);
                    }).join(',');
                    url.searchParams.set('filter_' + key, encoded);
                }
            });

            window.history.pushState({}, '', url);
        }

        function getActiveFilterCount() {
            var count = 0;
            Object.keys(activeFilters).forEach(function(key) {
                count += activeFilters[key].length;
            });
            return count;
        }

        function applyFilters() {
            if (!portfolioData) return;

            // Filter the data
            filteredData = {
                type: portfolioData.type,
                name: portfolioData.name,
                features: portfolioData.features.filter(function(feature) {
                    var props = feature.properties;

                    // Check each filter category (AND between categories)
                    for (var filterKey in activeFilters) {
                        var filterValues = activeFilters[filterKey];
                        if (filterValues.length === 0) continue;

                        var propKey = filterConfig[filterKey].property;
                        var propValue = props[propKey];

                        // OR within category - at least one must match
                        var matches = filterValues.some(function(filterValue) {
                            return propValue === filterValue;
                        });

                        if (!matches) return false;
                    }

                    return true;
                })
            };

            // Update URL
            setFiltersInURL(activeFilters);

            // Update object count
            updateObjectCount();

            // Update filter button state
            updateFilterButtonState();

            // Re-render current view
            renderCurrentView();

            // Update map layer filter if on map view
            if (currentView === 'map' && window.map && map.getLayer('portfolio-points')) {
                updateMapFilter();
            }
        }

        function updateMapFilter() {
            if (!map || !map.getLayer('portfolio-points')) return;

            // If no active filters, show all buildings
            if (getActiveFilterCount() === 0) {
                map.setFilter('portfolio-points', null);
                if (map.getLayer('portfolio-labels')) {
                    map.setFilter('portfolio-labels', null);
                }
                return;
            }

            var filteredIds = filteredData.features.map(function(f) {
                return f.properties.id;
            });

            // Apply filter to show only filtered buildings
            map.setFilter('portfolio-points', ['in', ['get', 'id'], ['literal', filteredIds]]);

            // Also filter labels layer if it exists
            if (map.getLayer('portfolio-labels')) {
                map.setFilter('portfolio-labels', ['in', ['get', 'id'], ['literal', filteredIds]]);
            }

            // Zoom to fit filtered points
            zoomToFilteredPoints();
        }

        function zoomToFilteredPoints() {
            if (!filteredData || filteredData.features.length === 0) return;

            var features = filteredData.features;

            if (features.length === 1) {
                // Single point - fly to it with a reasonable zoom level
                var coords = features[0].geometry.coordinates;
                map.flyTo({
                    center: coords,
                    zoom: 14,
                    duration: 1000
                });
            } else {
                // Multiple points - fit bounds
                var bounds = new mapboxgl.LngLatBounds();
                features.forEach(function(feature) {
                    bounds.extend(feature.geometry.coordinates);
                });
                map.fitBounds(bounds, {
                    padding: 80,
                    duration: 1000,
                    maxZoom: 16
                });
            }
        }

        function resetFilters() {
            activeFilters = {
                status: [],
                eigentum: [],
                teilportfolio: [],
                gebaeudeart: [],
                land: [],
                region: []
            };

            // Uncheck all checkboxes
            document.querySelectorAll('#filter-pane input[type="checkbox"]').forEach(function(cb) {
                cb.checked = false;
            });

            applyFilters();
        }

        // Global alias for empty state buttons
        window.resetAllFilters = resetFilters;

        function navigateToAllObjects() {
            resetFilters();
            switchView(previousView || 'gallery');
        }

        function navigateWithLandFilter() {
            if (!currentDetailBuilding) return;
            var land = currentDetailBuilding.properties.land;
            if (!land) return;

            // Reset all filters and set only land filter
            resetFilters();
            activeFilters.land = [land];

            // Update checkbox state
            var checkbox = document.querySelector('#filter-pane input[data-filter="land"][data-value="' + land + '"]');
            if (checkbox) checkbox.checked = true;

            applyFilters();
            switchView(previousView || 'gallery');
        }

        function navigateWithRegionFilter() {
            if (!currentDetailBuilding) return;
            var region = currentDetailBuilding.properties.region;
            if (!region) return;

            // Reset all filters and set only region filter
            resetFilters();
            activeFilters.region = [region];

            // Update checkbox state
            var checkbox = document.querySelector('#filter-pane input[data-filter="region"][data-value="' + region + '"]');
            if (checkbox) checkbox.checked = true;

            applyFilters();
            switchView(previousView || 'gallery');
        }

        function updateObjectCount() {
            var count = filteredData ? filteredData.features.length : (portfolioData ? portfolioData.features.length : 0);
            var countEl = document.getElementById('object-count');
            if (countEl) {
                countEl.textContent = count + ' Objekte';
            }
        }

        function updateFilterButtonState() {
            var filterBtn = document.getElementById('filter-btn');
            var count = getActiveFilterCount();

            if (count > 0) {
                // Add active filters highlight
                filterBtn.classList.add('has-active-filters');
                // Add or update count badge
                var badge = filterBtn.querySelector('.filter-count');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'filter-count';
                    filterBtn.appendChild(badge);
                }
                badge.textContent = count;
            } else {
                // Remove active filters highlight
                filterBtn.classList.remove('has-active-filters');
                // Remove count badge
                var badge = filterBtn.querySelector('.filter-count');
                if (badge) {
                    badge.remove();
                }
            }
        }

        function renderCurrentView() {
            // Mark non-current views as dirty (they'll re-render when switched to)
            if (currentView !== 'list') {
                listViewDirty = true;
            }
            if (currentView !== 'gallery') {
                galleryViewDirty = true;
            }

            // Render current view and clear its dirty flag
            if (currentView === 'list') {
                renderListView();
                listViewDirty = false;
            } else if (currentView === 'gallery') {
                renderGalleryView();
                galleryViewDirty = false;
            }
            // Map view updates via updateMapFilter()
        }

        function toggleFilterPane(open) {
            var pane = document.getElementById('filter-pane');
            var filterBtn = document.getElementById('filter-btn');

            if (open === undefined) {
                open = !pane.classList.contains('open');
            }

            if (open) {
                pane.classList.add('open');
                filterBtn.classList.add('pane-open');
                filterBtn.setAttribute('aria-expanded', 'true');
            } else {
                pane.classList.remove('open');
                filterBtn.classList.remove('pane-open');
                filterBtn.setAttribute('aria-expanded', 'false');
            }

            // Resize map after transition completes
            if (window.map) {
                setTimeout(function() {
                    map.resize();
                }, 350); // Slightly longer than CSS transition (300ms)
            }
        }

        function initFilterOptions() {
            if (!portfolioData) return;

            // Collect unique values for each filter category
            var uniqueValues = {
                status: new Set(),
                eigentum: new Set(),
                teilportfolio: new Set(),
                gebaeudeart: new Set(),
                land: new Set(),
                region: new Set()
            };

            portfolioData.features.forEach(function(feature) {
                var props = feature.properties;
                if (props.status) uniqueValues.status.add(props.status);
                if (props.eigentum) uniqueValues.eigentum.add(props.eigentum);
                if (props.teilportfolio) uniqueValues.teilportfolio.add(props.teilportfolio);
                if (props.objektart1) uniqueValues.gebaeudeart.add(props.objektart1);
                if (props.land) uniqueValues.land.add(props.land);
                if (props.region) uniqueValues.region.add(props.region);
            });

            // Render options for each filter
            Object.keys(uniqueValues).forEach(function(filterKey) {
                var container = document.getElementById('filter-' + filterKey + '-options');
                if (!container) return;

                var values = Array.from(uniqueValues[filterKey]).sort();
                var html = '';

                values.forEach(function(value) {
                    var id = 'filter-' + filterKey + '-' + value.replace(/[^a-zA-Z0-9]/g, '_');
                    var checked = activeFilters[filterKey].includes(value) ? 'checked' : '';

                    html += '<div class="filter-option">' +
                        '<input type="checkbox" id="' + id + '" data-filter="' + filterKey + '" data-value="' + value + '" ' + checked + '>' +
                        '<label for="' + id + '">' + value + '</label>' +
                        '</div>';
                });

                container.innerHTML = html;

                // Add event listeners to checkboxes
                container.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        var filterKey = this.dataset.filter;
                        var value = this.dataset.value;

                        if (this.checked) {
                            if (!activeFilters[filterKey].includes(value)) {
                                activeFilters[filterKey].push(value);
                            }
                        } else {
                            activeFilters[filterKey] = activeFilters[filterKey].filter(function(v) {
                                return v !== value;
                            });
                        }

                        applyFilters();
                    });
                });
            });
        }

        function initFilterPane() {
            // Toggle filter pane
            document.getElementById('filter-btn').addEventListener('click', function() {
                toggleFilterPane();
            });

            // Close filter pane
            document.getElementById('filter-close-btn').addEventListener('click', function() {
                toggleFilterPane(false);
            });

            // Reset filters (button inside pane)
            document.getElementById('filter-reset-btn').addEventListener('click', function() {
                resetFilters();
            });

            // Filter section accordion toggle
            document.querySelectorAll('.filter-section-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    var section = this.parentElement;
                    section.classList.toggle('open');
                });
            });

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    toggleFilterPane(false);
                }
            });

            // Logo click - navigate to main page
            document.getElementById('logo-area').addEventListener('click', function() {
                navigateToAllObjects();
            });
        }

        // ===== LIST VIEW TOOLBAR FUNCTIONS =====

        // Dropdown Toggle Function
        function toggleDropdown(dropdownId) {
            var menu = document.getElementById(dropdownId);
            var isOpen = menu.classList.contains('show');

            // Close all dropdowns first
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.remove('show');
            });

            // Toggle the clicked one
            if (!isOpen) {
                menu.classList.add('show');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Export Handler (Platzhalter/Demo)
        function handleExport(format) {
            var formatNames = {
                'csv': 'CSV (.csv)',
                'excel': 'Excel (.xlsx)',
                'geojson': 'GeoJSON (.geojson)'
            };
            alert('Export als ' + formatNames[format] + '\n\nDiese Funktion ist ein Platzhalter und wird in einer zuknftigen Version implementiert.');

            // Close dropdown
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.remove('show');
            });
        }

        // ===== SHARE FUNCTIONS =====
        function getShareUrl() {
            var baseUrl = window.location.origin + window.location.pathname;
            var params = new URLSearchParams(window.location.search);

            // Add current map position if map exists
            if (typeof map !== 'undefined' && map) {
                var center = map.getCenter();
                var zoom = map.getZoom();
                params.set('lng', center.lng.toFixed(5));
                params.set('lat', center.lat.toFixed(5));
                params.set('zoom', zoom.toFixed(2));
            }

            // Add selected building if one is selected
            if (selectedBuildingId) {
                params.set('id', selectedBuildingId);
            } else {
                params.delete('id');
            }

            return baseUrl + '?' + params.toString();
        }

        function updateShareLink() {
            var input = document.getElementById('share-link-input');
            if (input) {
                input.value = getShareUrl();
            }
        }

        function shareViaEmail() {
            var url = getShareUrl();
            var subject = encodeURIComponent('BBL Immobilienportfolio - Kartenansicht');
            var body = encodeURIComponent('Schauen Sie sich diese Kartenansicht an:\n\n' + url);
            window.open('mailto:?subject=' + subject + '&body=' + body, '_self');
        }

        function shareViaFacebook() {
            var url = encodeURIComponent(getShareUrl());
            window.open('https://www.facebook.com/sharer/sharer.php?u=' + url, '_blank', 'width=600,height=400');
        }

        function shareViaLinkedIn() {
            var url = encodeURIComponent(getShareUrl());
            window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + url, '_blank', 'width=600,height=400');
        }

        function shareViaX() {
            var url = encodeURIComponent(getShareUrl());
            var text = encodeURIComponent('BBL Immobilienportfolio - Kartenansicht');
            window.open('https://twitter.com/intent/tweet?url=' + url + '&text=' + text, '_blank', 'width=600,height=400');
        }

        function copyShareLink() {
            var input = document.getElementById('share-link-input');
            var button = document.querySelector('.share-copy-btn');

            if (input && navigator.clipboard) {
                navigator.clipboard.writeText(input.value).then(function() {
                    button.textContent = 'Kopiert!';
                    button.classList.add('copied');
                    setTimeout(function() {
                        button.textContent = 'Link kopieren';
                        button.classList.remove('copied');
                    }, 2000);
                });
            } else if (input) {
                // Fallback for older browsers
                input.select();
                document.execCommand('copy');
                button.textContent = 'Kopiert!';
                button.classList.add('copied');
                setTimeout(function() {
                    button.textContent = 'Link kopieren';
                    button.classList.remove('copied');
                }, 2000);
            }
        }

        // Column Toggle Handler
        function handleColumnToggle(checkbox) {
            var columnClass = checkbox.getAttribute('data-column');
            var isVisible = checkbox.checked;

            // Toggle visibility of header and body cells
            document.querySelectorAll('.' + columnClass).forEach(function(cell) {
                cell.style.display = isVisible ? '' : 'none';
            });
        }

        // Toggle All Columns (Alle/Keine)
        function toggleAllColumns(showAll) {
            var checkboxes = document.querySelectorAll('#columns-dropdown-menu input[type="checkbox"]');

            checkboxes.forEach(function(checkbox) {
                checkbox.checked = showAll;
                handleColumnToggle(checkbox);
            });
        }

        // List Search Handler
        function handleListSearch(query) {
            var searchTerm = query.toLowerCase().trim();
            var rows = document.querySelectorAll('#list-body tr');

            rows.forEach(function(row) {
                var text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Initialize List View Toolbar Event Listeners
        function initListToolbar() {
            // Dropdown buttons
            var exportBtn = document.getElementById('export-dropdown-btn');
            var columnsBtn = document.getElementById('columns-dropdown-btn');

            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleDropdown('export-dropdown-menu');
                });
            }

            if (columnsBtn) {
                columnsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleDropdown('columns-dropdown-menu');
                });
            }

            // Column checkboxes
            document.querySelectorAll('#columns-dropdown-menu input[type="checkbox"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    handleColumnToggle(this);
                });
            });

            // Search input
            var searchInput = document.getElementById('list-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    handleListSearch(this.value);
                });
            }
        }

        // Daten laden (parallel fetch of all entity files)
        Promise.all([
            fetch('data/buildings.geojson').then(function(r) { return r.json(); }),
            fetch('data/area-measurements.json').then(function(r) { return r.json(); }),
            fetch('data/documents.json').then(function(r) { return r.json(); }),
            fetch('data/contacts.json').then(function(r) { return r.json(); }),
            fetch('data/contracts.json').then(function(r) { return r.json(); }),
            fetch('data/assets.json').then(function(r) { return r.json(); }),
            fetch('data/costs.json').then(function(r) { return r.json(); })
        ])
            .then(function(results) {
                // Destructure results
                portfolioData = results[0];
                allAreaMeasurements = results[1].areaMeasurements;
                allDocuments = results[2].documents;
                allContacts = results[3].contacts;
                allContracts = results[4].contracts;
                allAssets = results[5].assets;
                allCosts = results[6].costs;

                // Initialize filters from URL
                activeFilters = getFiltersFromURL();

                // Initialize filter pane with options
                initFilterOptions();
                initFilterPane();

                // Apply initial filters (this sets filteredData and updates count)
                applyFilters();

                renderListView();
                renderGalleryView();
                initListToolbar();
                
                if (map.loaded()) {
                    addMapLayers();
                } else {
                    map.on('load', addMapLayers);
                }
                
                // Check if URL has detail view
                var initialView = getViewFromURL();
                var buildingId = getBuildingIdFromURL();
                if (initialView === 'detail' && buildingId) {
                    showDetailView(buildingId);
                } else if (initialView !== 'map') {
                    switchView(initialView);
                } else {
                    // Map view is default - show style switcher
                    var styleSwitcher = document.getElementById('style-switcher');
                    if (styleSwitcher) {
                        styleSwitcher.classList.add('visible');
                    }
                }
            })
            .catch(function(error) {
                console.error('Fehler beim Laden der Daten:', error);
            });
        
        // ===== VIEW MANAGEMENT =====
        var currentView = 'map';
        
        function getViewFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('view') || 'map';
        }
        
        function getBuildingIdFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        function setViewInURL(view, buildingId) {
            var url = new URL(window.location);
            url.searchParams.set('view', view);
            if (buildingId) {
                url.searchParams.set('id', buildingId);
            } else {
                url.searchParams.delete('id');
            }
            window.history.pushState({}, '', url);
        }
        
        function switchView(view) {
            if (view !== 'detail') {
                previousView = currentView !== 'detail' ? currentView : previousView;
            }
            currentView = view;
            setViewInURL(view);
            
            // Update toggle buttons and ARIA attributes
            document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                }
            });
            
            // Show/hide views
            document.getElementById('map-view').classList.remove('active');
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('gallery-view').classList.remove('active');
            document.getElementById('detail-view').classList.remove('active');
            
            var viewElement = document.getElementById(view + '-view');
            if (viewElement) {
                viewElement.classList.add('active');
            }

            // Show/hide style switcher based on view (only visible in map view)
            var styleSwitcher = document.getElementById('style-switcher');
            if (styleSwitcher) {
                styleSwitcher.classList.toggle('visible', view === 'map');
            }

            // Resize map if switching to map view
            if (view === 'map' && window.map) {
                setTimeout(function() {
                    map.resize();
                    // Apply filters to map when switching to map view
                    if (map.getLayer('portfolio-points')) {
                        updateMapFilter();
                    }
                }, 100);
            }

            // Re-render list view if dirty (filters changed while on another view)
            if (view === 'list' && listViewDirty) {
                renderListView();
                listViewDirty = false;
            }

            // Re-render gallery view if dirty (filters changed while on another view)
            if (view === 'gallery' && galleryViewDirty) {
                renderGalleryView();
                galleryViewDirty = false;
            }
        }

        function showDetailView(buildingId) {
            if (!portfolioData) return;
            
            // Find building by ID
            var building = portfolioData.features.find(function(f) {
                return f.properties.id === buildingId;
            });
            
            if (!building) {
                console.error('Building not found:', buildingId);
                return;
            }
            
            currentDetailBuilding = building;
            
            // Store previous view if not already in detail
            if (currentView !== 'detail') {
                previousView = currentView;
            }
            
            // Update URL
            setViewInURL('detail', buildingId);
            currentView = 'detail';
            
            // Hide all views, show detail
            document.getElementById('map-view').classList.remove('active');
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('gallery-view').classList.remove('active');
            document.getElementById('detail-view').classList.add('active');

            // Hide style switcher in detail view
            var styleSwitcher = document.getElementById('style-switcher');
            if (styleSwitcher) {
                styleSwitcher.classList.remove('visible');
            }

            // Clear active state from view toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Populate detail view
            populateDetailView(building);
        }
        
        function populateDetailView(building) {
            var props = building.properties;
            var coords = building.geometry.coordinates;
            
            // Breadcrumb
            document.getElementById('breadcrumb-name').textContent = props.name;
            document.getElementById('breadcrumb-country').textContent = props.land || '';
            document.getElementById('breadcrumb-region').textContent = props.region || '';
            
            // Objekt Stammdaten
            document.getElementById('detail-name').textContent = props.name;
            document.getElementById('detail-id').textContent = props.id;
            document.getElementById('detail-teilportfolio').textContent = props.teilportfolio;
            document.getElementById('detail-baujahr').textContent = props.baujahr;
            
            // Address
            document.getElementById('detail-country').textContent = props.land;
            document.getElementById('detail-region').textContent = props.region || '';
            document.getElementById('detail-city').textContent = props.ort;

            // Read address parts directly from properties, parse street from address
            var addressParts = parseAddress(props.adresse);
            document.getElementById('detail-plz').textContent = props.plz || '';
            document.getElementById('detail-street').textContent = addressParts.street || '';
            document.getElementById('detail-housenumber').textContent = props.hausnummer || '';
            
            // Gebudedaten
            document.getElementById('detail-sanierung').textContent = props.sanierung || '';
            document.getElementById('detail-ladestationen').textContent = props.ladestationen !== undefined ? props.ladestationen : '';
            document.getElementById('detail-denkmalschutz').textContent = props.denkmalschutz || '';
            document.getElementById('detail-parkplaetze').textContent = props.parkplaetze !== undefined ? props.parkplaetze : '';
            document.getElementById('detail-geschosse').textContent = props.geschosse !== undefined ? props.geschosse : '';
            document.getElementById('detail-baubewilligung').textContent = props.baubewilligung || '';

            // Energie
            document.getElementById('detail-energieklasse').textContent = props.energieklasse || '';
            document.getElementById('detail-waermeerzeuger').textContent = props.waermeerzeuger || '';
            document.getElementById('detail-waermequelle').textContent = props.waermequelle || '';
            document.getElementById('detail-warmwasser').textContent = props.warmwasser || '';

            // Grundstck
            document.getElementById('detail-grundstueck-name').textContent = props.grundstueck_name || '';
            document.getElementById('detail-grundstueck-id').textContent = props.grundstueck_id || '';
            document.getElementById('detail-egid').textContent = props.egid || '';
            document.getElementById('detail-egrid').textContent = props.egrid || '';
            document.getElementById('detail-gueltig-von').textContent = props.gueltig_von || '';
            document.getElementById('detail-gueltig-bis').textContent = props.gueltig_bis || 'Keine Angabe';

            // Klassifizierung
            document.getElementById('detail-objektart1').textContent = props.objektart1 || '';
            document.getElementById('detail-teilportfolio-gruppe').textContent = props.teilportfolio_gruppe || '';
            document.getElementById('detail-objektart2').textContent = props.objektart2 || '';
            document.getElementById('detail-eigentum').textContent = props.eigentum || '';

            // Load measurements for this building
            loadMeasurementsForBuilding(building);

            // Load documents for this building
            loadDocumentsForBuilding(building);

            // Load kontakte for this building
            loadKontakteForBuilding(building);

            // Load kosten for this building
            loadKostenForBuilding(building);

            // Load vertraege for this building
            loadVertraegeForBuilding(building);

            // Load ausstattung for this building
            loadAusstattungForBuilding(building);

            // Initialize carousel
            initCarousel();

            // Initialize mini map
            initMiniMap(coords);
        }
        
        function parseAddress(address) {
            // Parse address into street, house number, and PLZ
            // Expected formats: "Strasse Nr, PLZ Stadt" or "Nr Strasse, Stadt, State PLZ"
            var street = '';
            var number = '';
            var plz = '';

            if (!address) {
                return { street: street, number: number, plz: plz };
            }

            // Split by comma to separate street+number from PLZ+city
            var commaParts = address.split(',');
            var streetPart = commaParts[0].trim();

            // Extract PLZ from the part after the comma
            if (commaParts.length > 1) {
                var restPart = commaParts.slice(1).join(',').trim();
                // Look for PLZ patterns: Swiss (4 digits), German (5 digits), US (5 digits), etc.
                var plzMatch = restPart.match(/\b(\d{4,5})\b/);
                if (plzMatch) {
                    plz = plzMatch[1];
                }
            }

            // Parse street and house number from the first part
            // Check for number at the end (European style: "Strasse 123")
            var endNumberMatch = streetPart.match(/^(.+?)\s+(\d+[A-Za-z]?)$/);
            if (endNumberMatch) {
                street = endNumberMatch[1];
                number = endNumberMatch[2];
            } else {
                // Check for number at the beginning (US/UK style: "123 Street")
                var startNumberMatch = streetPart.match(/^(\d+[A-Za-z]?)\s+(.+)$/);
                if (startNumberMatch) {
                    number = startNumberMatch[1];
                    street = startNumberMatch[2];
                } else {
                    // No clear number found, use entire part as street
                    street = streetPart;
                }
            }

            return { street: street, number: number, plz: plz };
        }
        
        function initCarousel() {
            currentCarouselIndex = 0;
            updateCarouselImage();
            
            // Create dots
            var dotsContainer = document.getElementById('carousel-dots');
            dotsContainer.innerHTML = '';
            placeholderImages.forEach(function(_, index) {
                var dot = document.createElement('div');
                dot.className = 'carousel-dot' + (index === 0 ? ' active' : '');
                dot.onclick = function() {
                    currentCarouselIndex = index;
                    updateCarouselImage();
                };
                dotsContainer.appendChild(dot);
            });
        }
        
        function updateCarouselImage() {
            var imageEl = document.getElementById('carousel-image');
            imageEl.style.backgroundImage = 'url(' + placeholderImages[currentCarouselIndex] + ')';
            
            // Update dots
            document.querySelectorAll('.carousel-dot').forEach(function(dot, index) {
                dot.classList.toggle('active', index === currentCarouselIndex);
            });
        }
        
        function carouselPrev() {
            currentCarouselIndex = (currentCarouselIndex - 1 + placeholderImages.length) % placeholderImages.length;
            updateCarouselImage();
        }
        
        function carouselNext() {
            currentCarouselIndex = (currentCarouselIndex + 1) % placeholderImages.length;
            updateCarouselImage();
        }
        
        function initMiniMap(coords) {
            // Destroy existing map if any
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
            
            // Create new mini map
            miniMap = new mapboxgl.Map({
                container: 'mini-map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: coords,
                zoom: 17,
                pitch: 50,
                bearing: -17
            });
            
            // Add 3D buildings layer
            miniMap.on('load', function() {
                // Add 3D buildings
                var layers = miniMap.getStyle().layers;
                var labelLayerId;
                for (var i = 0; i < layers.length; i++) {
                    if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                        labelLayerId = layers[i].id;
                        break;
                    }
                }
                
                miniMap.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#A8B0B7',
                        'fill-extrusion-height': [
                            'interpolate', ['linear'], ['zoom'],
                            15, 0,
                            15.05, ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate', ['linear'], ['zoom'],
                            15, 0,
                            15.05, ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.6
                    }
                }, labelLayerId);
                
                // Add marker
                new mapboxgl.Marker({ color: '#c00' })
                    .setLngLat(coords)
                    .addTo(miniMap);
            });
            
            // Add navigation controls
            miniMap.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
        }
        
        // View toggle click handlers
        document.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                switchView(this.dataset.view);
            });
        });
        
        // Back button handler
        document.getElementById('btn-back').addEventListener('click', function() {
            switchView(previousView || 'gallery');
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', function() {
            var view = getViewFromURL();
            var buildingId = getBuildingIdFromURL();
            if (view === 'detail' && buildingId) {
                showDetailView(buildingId);
            } else {
                switchView(view);
            }
        });
        
        // ===== RENDER LIST VIEW =====
        function renderListView() {
            if (!portfolioData) return;

            var dataToRender = filteredData || portfolioData;
            var listBody = document.getElementById('list-body');
            var tableWrapper = document.querySelector('#list-view .list-table-wrapper');
            var html = '';

            // Handle empty state
            if (dataToRender.features.length === 0) {
                listBody.innerHTML = '';
                // Check if empty state already exists
                var existingEmpty = document.querySelector('#list-view .empty-state');
                if (!existingEmpty) {
                    var emptyHtml = '<div class="empty-state">' +
                        '<span class="material-symbols-outlined">search_off</span>' +
                        '<div class="empty-state-title">Keine Objekte gefunden</div>' +
                        '<div class="empty-state-description">Die aktuellen Filter ergeben keine Treffer. Passen Sie die Filterkriterien an oder setzen Sie die Filter zurck.</div>' +
                        '<div class="empty-state-action"><button class="btn-secondary" onclick="resetAllFilters()">Filter zurcksetzen</button></div>' +
                    '</div>';
                    tableWrapper.insertAdjacentHTML('afterend', emptyHtml);
                }
                return;
            } else {
                // Remove empty state if it exists
                var existingEmpty = document.querySelector('#list-view .empty-state');
                if (existingEmpty) existingEmpty.remove();
            }

            dataToRender.features.forEach(function(feature) {
                var props = feature.properties;
                var statusClass = props.status === 'In Betrieb' ? 'in-betrieb' :
                                  props.status === 'In Renovation' ? 'in-renovation' :
                                  props.status === 'In Planung' ? 'in-planung' : 'ausser-betrieb';
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');

                html += '<tr data-id="' + props.id + '" tabindex="0" role="row">' +
                    '<td class="col-id">' + props.id + '</td>' +
                    '<td class="col-name">' + props.name + '</td>' +
                    '<td class="col-land">' + props.land + '</td>' +
                    '<td class="col-ort">' + props.ort + '</td>' +
                    '<td class="col-adresse">' + props.adresse + '</td>' +
                    '<td class="col-portfolio">' + props.teilportfolio + '</td>' +
                    '<td class="col-flaeche">' + flaeche + ' m</td>' +
                    '<td class="col-status"><span class="status-badge ' + statusClass + '"><span class="status-icon" aria-hidden="true"></span>' + props.status + '</span></td>' +
                '</tr>';
            });

            listBody.innerHTML = html;

            // Add click and keyboard handlers
            document.querySelectorAll('#list-body tr').forEach(function(row) {
                row.addEventListener('click', function() {
                    var buildingId = this.dataset.id;
                    showDetailView(buildingId);
                });
                row.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        var buildingId = this.dataset.id;
                        showDetailView(buildingId);
                    }
                });
            });
        }
        
        // ===== RENDER GALLERY VIEW =====
        function renderGalleryView() {
            if (!portfolioData) return;

            var dataToRender = filteredData || portfolioData;
            var galleryGrid = document.getElementById('gallery-grid');
            var html = '';

            // Handle empty state
            if (dataToRender.features.length === 0) {
                galleryGrid.innerHTML = '<div class="empty-state">' +
                    '<span class="material-symbols-outlined">search_off</span>' +
                    '<div class="empty-state-title">Keine Objekte gefunden</div>' +
                    '<div class="empty-state-description">Die aktuellen Filter ergeben keine Treffer. Passen Sie die Filterkriterien an oder setzen Sie die Filter zurck.</div>' +
                    '<div class="empty-state-action"><button class="btn-secondary" onclick="resetAllFilters()">Filter zurcksetzen</button></div>' +
                '</div>';
                return;
            }

            dataToRender.features.forEach(function(feature, index) {
                var props = feature.properties;
                var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
                // Use placeholder images
                var imageUrl = placeholderImages[index % placeholderImages.length];

                html += '<div class="gallery-card" data-id="' + props.id + '" tabindex="0" role="article" aria-label="' + props.name + '">' +
                    '<div class="gallery-image" style="background-image: url(' + imageUrl + ')" role="img" aria-label="Bild von ' + props.name + '">' +
                        '<div class="gallery-image-label">' + props.land + '</div>' +
                    '</div>' +
                    '<div class="gallery-content">' +
                        '<div class="gallery-title">' + props.name + '</div>' +
                        '<div class="gallery-subtitle">' + props.adresse + '</div>' +
                        '<div class="gallery-meta">' +
                            '<span class="gallery-tag">' + props.teilportfolio + '</span>' +
                            '<span class="gallery-tag">' + flaeche + ' m</span>' +
                        '</div>' +
                        '<div class="gallery-footer">' +
                            '<span>Baujahr ' + props.baujahr + '</span>' +
                            '<a href="#" class="gallery-link" onclick="event.stopPropagation();" aria-label="Details zu ' + props.name + ' anzeigen">Details <span class="material-symbols-outlined" aria-hidden="true">arrow_forward</span></a>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            galleryGrid.innerHTML = html;

            // Add click and keyboard handlers
            document.querySelectorAll('.gallery-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    var buildingId = this.dataset.id;
                    showDetailView(buildingId);
                });
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        var buildingId = this.dataset.id;
                        showDetailView(buildingId);
                    }
                });
            });
        }
        
        // ===== INITIALIZE MAP =====
        
        // 1. Parse URL parameters for map state
        var urlParams = new URLSearchParams(window.location.search);
        var initialLat = parseFloat(urlParams.get('lat'));
        var initialLng = parseFloat(urlParams.get('lng'));
        var initialZoom = parseFloat(urlParams.get('zoom'));

        // Defaults (Switzerland)
        var startCenter = [8.2275, 46.8182];
        var startZoom = 2;

        // Override defaults if URL params exist
        if (!isNaN(initialLat) && !isNaN(initialLng) && !isNaN(initialZoom)) {
            startCenter = [initialLng, initialLat];
            startZoom = initialZoom;
        }

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: startCenter,
            zoom: startZoom
        });
        
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.ScaleControl({ maxWidth: 200 }), 'bottom-left');

        // Home button control
        var HomeControl = function() {};
        HomeControl.prototype.onAdd = function(map) {
            this._map = map;
            this._container = document.createElement('div');
            this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';

            var button = document.createElement('button');
            button.className = 'map-home-btn';
            button.type = 'button';
            button.title = 'Zur Startansicht';
            button.innerHTML = '<span class="material-symbols-outlined">home</span>';
            button.onclick = function() {
                map.flyTo({
                    center: [8.2275, 46.8182],
                    zoom: 2,
                    duration: 1000
                });
            };

            this._container.appendChild(button);
            return this._container;
        };
        HomeControl.prototype.onRemove = function() {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        };

        map.addControl(new HomeControl(), 'top-right');

        // 2. Update URL on map move/zoom
        map.on('moveend', function() {
            if (currentView !== 'map') return; // Don't update if not in map view
            
            var center = map.getCenter();
            var zoom = map.getZoom();
            
            var url = new URL(window.location);
            url.searchParams.set('lng', center.lng.toFixed(5));
            url.searchParams.set('lat', center.lat.toFixed(5));
            url.searchParams.set('zoom', zoom.toFixed(2));
            
            // Use replaceState to update URL without adding to history stack
            window.history.replaceState({}, '', url);
        });

        map.on('mousemove', function(e) {
            var lng = e.lngLat.lng.toFixed(5);
            var lat = e.lngLat.lat.toFixed(5);
            document.getElementById('coordinates').textContent = 'WGS 84 | Koordinaten: ' + lng + ', ' + lat;
        });
        
        function addMapLayers() {
            if (!portfolioData) return;
            
            map.addSource('portfolio', {
                type: 'geojson',
                data: portfolioData
            });
            
            // Main points layer
            map.addLayer({
                id: 'portfolio-points',
                type: 'circle',
                source: 'portfolio',
                paint: {
                    'circle-radius': 10,
                    'circle-color': [
                        'match',
                        ['get', 'status'],
                        'In Betrieb', statusColors['In Betrieb'],
                        'In Renovation', statusColors['In Renovation'],
                        'In Planung', statusColors['In Planung'],
                        'Ausser Betrieb', statusColors['Ausser Betrieb'],
                        '#6C757D'  // fallback
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });

            // Selected point highlight layer - outer ring
            map.addLayer({
                id: 'portfolio-selected',
                type: 'circle',
                source: 'portfolio',
                filter: ['==', ['get', 'id'], ''],
                paint: {
                    'circle-radius': 18,
                    'circle-color': 'transparent',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#c00',  // primary-red
                    'circle-stroke-opacity': 0.9
                }
            });

            // Selected point pulse animation layer
            map.addLayer({
                id: 'portfolio-selected-pulse',
                type: 'circle',
                source: 'portfolio',
                filter: ['==', ['get', 'id'], ''],
                paint: {
                    'circle-radius': 24,
                    'circle-color': 'transparent',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#c00',
                    'circle-stroke-opacity': 0.4
                }
            });

            // Animate the pulse layer
            var pulseRadius = 24;
            var pulseOpacity = 0.4;
            var pulseDirection = 1;

            function animatePulse() {
                pulseRadius += 0.3 * pulseDirection;
                pulseOpacity -= 0.01 * pulseDirection;

                if (pulseRadius >= 32) {
                    pulseDirection = -1;
                } else if (pulseRadius <= 24) {
                    pulseDirection = 1;
                }

                if (map.getLayer('portfolio-selected-pulse')) {
                    map.setPaintProperty('portfolio-selected-pulse', 'circle-radius', pulseRadius);
                    map.setPaintProperty('portfolio-selected-pulse', 'circle-stroke-opacity', Math.max(0.1, pulseOpacity));
                }

                requestAnimationFrame(animatePulse);
            }

            animatePulse();
            
            map.on('mouseenter', 'portfolio-points', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'portfolio-points', function() {
                map.getCanvas().style.cursor = '';
            });
            
            // CLICK HANDLER
            map.on('click', 'portfolio-points', function(e) {
                var props = e.features[0].properties;
                // UPDATED: Pass 'false' so map does NOT zoom on click
                selectBuilding(props.id, false);
            });
            
            // Click on map (not on a point) to deselect
            map.on('click', function(e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['portfolio-points'] });
                if (features.length === 0) {
                    selectedBuildingId = null;
                    updateSelectedBuilding();
                    updateUrlWithSelection();
                    document.getElementById('info-panel').classList.remove('show');
                }
            });

            // Apply initial filters to map if any
            if (filteredData && getActiveFilterCount() > 0) {
                updateMapFilter();
            }

            // Select building from URL parameter if present
            var urlBuildingId = urlParams.get('id');
            if (urlBuildingId) {
                var building = portfolioData.features.find(function(f) {
                    return f.properties.id === urlBuildingId;
                });
                if (building) {
                    selectBuilding(urlBuildingId, true);
                }
            }
        }

        // Reusable function to select a building
        // UPDATED: Added flyToBuilding parameter (default false)
        function selectBuilding(buildingId, flyToBuilding = false) {
            // Find feature props
            var building = portfolioData.features.find(function(f) { return f.properties.id === buildingId; });
            if (!building) return;
            
            var props = building.properties;
            var flaeche = Number(props.flaeche_ngf).toLocaleString('de-CH');
            var statusColor = statusColors[props.status] || '#8B949C';
            
            // Update selected ID
            selectedBuildingId = buildingId;
            updateSelectedBuilding();
            updateUrlWithSelection();
            
            // Find building index for placeholder image
            var buildingIndex = portfolioData.features.findIndex(function(f) {
                return f.properties.id === buildingId;
            });
            var imageUrl = placeholderImages[buildingIndex % placeholderImages.length];
            
            // Set preview image
            document.getElementById('info-preview-image').style.backgroundImage = 'url(' + imageUrl + ')';
            
            var infoHtml = 
                '<div class="info-section-title">' + props.teilportfolio + '</div>' +
                '<div class="info-location">' + props.ort + ', ' + props.land + '</div>' +
                '<div class="info-row"><span class="info-label">Objekt-ID</span><span class="info-value">' + props.id + '</span></div>' +
                '<div class="info-row"><span class="info-label">Name</span><span class="info-value">' + props.name + '</span></div>' +
                '<div class="info-row"><span class="info-label">Adresse</span><span class="info-value">' + props.adresse + '</span></div>' +
                '<div class="info-row"><span class="info-label">Flche NGF</span><span class="info-value">' + flaeche + ' m</span></div>' +
                '<div class="info-row"><span class="info-label">Baujahr</span><span class="info-value">' + props.baujahr + '</span></div>' +
                '<div class="info-row"><span class="info-label">Verantwortlich</span><span class="info-value">' + props.verantwortlich + '</span></div>' +
                '<div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color:' + statusColor + '; font-weight: 600;">' + props.status + '</span></div>' +
                '<div class="info-footer">' +
                    '<button class="info-detail-link" onclick="showDetailView(\'' + props.id + '\')">' +
                        '<span class="material-symbols-outlined">open_in_new</span>' +
                        'Details anzeigen' +
                    '</button>' +
                '</div>';
            
            document.getElementById('info-body').innerHTML = infoHtml;
            document.getElementById('info-panel').classList.add('show');
            
            // UPDATED: Only fly to building if explicitly requested (e.g. from Search)
            if (map && flyToBuilding) {
                map.flyTo({
                    center: building.geometry.coordinates,
                    zoom: 16
                });
            }
        }
        
        function updateSelectedBuilding() {
            if (map && map.getLayer('portfolio-selected')) {
                map.setFilter('portfolio-selected', ['==', ['get', 'id'], selectedBuildingId || '']);
            }
            if (map && map.getLayer('portfolio-selected-pulse')) {
                map.setFilter('portfolio-selected-pulse', ['==', ['get', 'id'], selectedBuildingId || '']);
            }
        }

        function updateUrlWithSelection() {
            var url = new URL(window.location);
            if (selectedBuildingId) {
                url.searchParams.set('id', selectedBuildingId);
            } else {
                url.searchParams.delete('id');
            }
            window.history.replaceState({}, '', url);
        }

        // ===== SEARCH FUNCTIONALITY =====
        var searchInput = document.getElementById('search-input');
        var searchResults = document.getElementById('search-results');
        var searchSpinner = document.getElementById('search-spinner');
        var searchClearBtn = document.getElementById('search-clear-btn');
        var searchDebounceTimer;
        
        // Listen for input
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchDebounceTimer);
            var val = e.target.value.trim();
            
            // Toggle clear button visibility
            if (val.length > 0) {
                searchClearBtn.classList.add('visible');
            } else {
                searchClearBtn.classList.remove('visible');
            }
            
            if (val.length < 2) {
                searchResults.classList.remove('active');
                searchSpinner.style.display = 'none';
                return;
            }
            
            searchSpinner.style.display = 'block';
            searchDebounceTimer = setTimeout(function() {
                performSearch(val);
            }, 300);
        });

        // Clear Button Click Listener
        searchClearBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            searchResults.classList.remove('active');
            searchInput.focus();
            
            // Remove the search marker if it exists
            if (searchMarker) {
                searchMarker.remove();
                searchMarker = null;
            }
        });
        
        // Close search on click outside
        document.addEventListener('click', function(e) {
            if (!document.getElementById('search-wrapper').contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // Close search on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchResults.classList.remove('active');
            }
        });
        
        function performSearch(term) {
            var promises = [];
            
            // 1. Local Search
            promises.push(new Promise(function(resolve) {
                var matches = [];
                if (portfolioData) {
                    var lowerTerm = term.toLowerCase();
                    matches = portfolioData.features.filter(function(f) {
                        var p = f.properties;
                        return (p.name && p.name.toLowerCase().includes(lowerTerm)) ||
                               (p.adresse && p.adresse.toLowerCase().includes(lowerTerm)) ||
                               (p.ort && p.ort.toLowerCase().includes(lowerTerm));
                    });
                }
                resolve({ type: 'local', data: matches });
            }));
            
            // 2. Swisstopo Locations
            promises.push(fetch('https://api3.geo.admin.ch/rest/services/ech/SearchServer?type=locations&limit=5&sr=4326&searchText=' + encodeURIComponent(term))
                .then(r => r.json())
                .then(data => ({ type: 'locations', data: data.results }))
                .catch(e => ({ type: 'locations', data: [] })));
                
            // 3. Swisstopo Layers
            promises.push(fetch('https://api3.geo.admin.ch/rest/services/ech/SearchServer?type=layers&limit=5&lang=de&searchText=' + encodeURIComponent(term))
                .then(r => r.json())
                .then(data => ({ type: 'layers', data: data.results }))
                .catch(e => ({ type: 'layers', data: [] })));
                
            Promise.all(promises).then(function(results) {
                renderSearchResults(results);
                searchSpinner.style.display = 'none';
            });
        }
        
        function renderSearchResults(results) {
            var localResults = results.find(function(r) { return r.type === 'local'; }).data;
            var locResults = results.find(function(r) { return r.type === 'locations'; }).data;
            var layerResults = results.find(function(r) { return r.type === 'layers'; }).data;
            
            var html = '';
            
            // Section: Objekte (Local)
            if (localResults.length > 0) {
                html += '<div class="search-section-header">Objekte</div>';
                localResults.forEach(function(f) {
                    html += '<div class="search-item" onclick="handleSearchClick(\'local\', \'' + f.properties.id + '\')">' +
                            '<div class="search-item-title">' + f.properties.name + '</div>' +
                            '<div class="search-item-subtitle">' + f.properties.adresse + ', ' + f.properties.ort + '</div>' +
                            '</div>';
                });
            }
            
            // Section: Orte (API)
            if (locResults.length > 0) {
                html += '<div class="search-section-header">Orte</div>';
                locResults.forEach(function(r, index) {
                    var lat = r.attrs.lat;
                    var lon = r.attrs.lon;
                    var zoom = r.attrs.zoomlevel || 14;
                    html += '<div class="search-item" onclick="handleSearchClick(\'location\', null, ' + lat + ', ' + lon + ', ' + zoom + ')">' +
                            '<div class="search-item-title">' + r.attrs.label + '</div>' +
                            '</div>';
                });
            }
            
            // Section: Karten (API)
            if (layerResults.length > 0) {
                html += '<div class="search-section-header">Karten hinzufgen...</div>';
                layerResults.forEach(function(r) {
                    html += '<div class="search-item" onclick="handleSearchClick(\'layer\', \'' + r.attrs.label.replace(/'/g, "\\'") + '\')">' +
                            '<div class="search-item-title">' + r.attrs.label + '</div>' +
                            '</div>';
                });
            }
            
            if (html === '') {
                html = '<div class="search-item" style="cursor:default;"><div class="search-item-subtitle">Keine Resultate gefunden</div></div>';
            }
            
            searchResults.innerHTML = html;
            searchResults.classList.add('active');
        }
        
        // Make this function global so onclick in HTML string works
        window.handleSearchClick = function(type, id, lat, lon, zoom) {
            searchResults.classList.remove('active');
            
            if (currentView !== 'map') {
                switchView('map');
            }
            
            if (type === 'local') {
                // Pass true to fly to the building when searching
                selectBuilding(id, true);
                
                // Remove generic search marker if we select a specific building
                if (searchMarker) {
                    searchMarker.remove();
                    searchMarker = null;
                }

                var b = portfolioData.features.find(f => f.properties.id === id);
                if(b) {
                    searchInput.value = b.properties.name;
                    searchClearBtn.classList.add('visible');
                }

            } else if (type === 'location') {
                // 1. Remove existing marker
                if (searchMarker) {
                    searchMarker.remove();
                }

                // 2. Fly to location
                map.flyTo({
                    center: [lon, lat],
                    zoom: zoom
                });

                // 3. Add Red Marker
                searchMarker = new mapboxgl.Marker({ color: '#c00' })
                    .setLngLat([lon, lat])
                    .addTo(map);

                // Clear selected building info panel
                selectedBuildingId = null;
                updateSelectedBuilding();
                updateUrlWithSelection();
                document.getElementById('info-panel').classList.remove('show');

                searchClearBtn.classList.add('visible');

            } else if (type === 'layer') {
                alert('Layer "' + id + '" wird bald verfgbar sein.');
            }
        };
        
        // ===== ACCORDION =====
        var geokatalogAccordion = document.getElementById('geokatalog-accordion');

        document.querySelectorAll('.accordion-header').forEach(function(header) {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                var isActive = this.classList.contains('active');
                var isGeokatalog = this.parentElement.id === 'geokatalog-accordion';

                document.querySelectorAll('.accordion-header').forEach(function(h) { h.classList.remove('active'); });
                document.querySelectorAll('.accordion-content').forEach(function(c) { c.classList.remove('show'); });
                geokatalogAccordion.classList.remove('expanded');

                if (!isActive) {
                    this.classList.add('active');
                    content.classList.add('show');

                    // Update share link when Teilen accordion is opened
                    var headerSpans = this.querySelectorAll(':scope > span');
                    var lastSpan = headerSpans[headerSpans.length - 1];
                    if (lastSpan && lastSpan.textContent.trim() === 'Teilen') {
                        updateShareLink();
                    }

                    // Expand Geokatalog to full height
                    if (isGeokatalog) {
                        geokatalogAccordion.classList.add('expanded');
                        loadGeokatalog();
                    }
                }

                setTimeout(updateMenuTogglePosition, 10);
            });
        });

        // ===== GEOKATALOG =====
        var geokatalogLoaded = false;

        function loadGeokatalog() {
            if (geokatalogLoaded) return;

            var treeContainer = document.getElementById('geokatalog-tree');

            fetch('https://api3.geo.admin.ch/rest/services/ech/CatalogServer?lang=de')
                .then(function(response) {
                    if (!response.ok) throw new Error('API nicht erreichbar');
                    return response.json();
                })
                .then(function(data) {
                    geokatalogLoaded = true;
                    treeContainer.innerHTML = '';

                    if (data.results && data.results.root && data.results.root.children) {
                        renderCatalogTree(data.results.root.children, treeContainer);
                    } else {
                        treeContainer.innerHTML = '<div class="geokatalog-error">Keine Daten verfgbar</div>';
                    }

                    setTimeout(updateMenuTogglePosition, 10);
                })
                .catch(function(error) {
                    console.error('Geokatalog Fehler:', error);
                    treeContainer.innerHTML = '<div class="geokatalog-error">Fehler beim Laden des Katalogs</div>';
                });
        }

        function renderCatalogTree(items, container) {
            items.forEach(function(item) {
                var itemEl = document.createElement('div');
                itemEl.className = 'catalog-item';

                var hasChildren = item.children && item.children.length > 0;

                var nodeEl = document.createElement('div');
                nodeEl.className = 'catalog-node' + (hasChildren ? '' : ' leaf');

                if (hasChildren) {
                    // Category node with arrow
                    var arrowEl = document.createElement('span');
                    arrowEl.className = 'node-arrow';
                    arrowEl.innerHTML = '<span class="material-symbols-outlined">chevron_right</span>';
                    nodeEl.appendChild(arrowEl);
                } else {
                    // Leaf node with checkbox
                    var checkboxEl = document.createElement('span');
                    checkboxEl.className = 'node-checkbox';
                    nodeEl.appendChild(checkboxEl);
                }

                var labelEl = document.createElement('span');
                labelEl.className = 'node-label';
                labelEl.textContent = item.label || item.category || 'Unbekannt';
                nodeEl.appendChild(labelEl);

                // Add info icon to leaf nodes
                if (!hasChildren) {
                    var infoEl = document.createElement('span');
                    infoEl.className = 'node-info';
                    infoEl.innerHTML = '<span class="material-symbols-outlined">info</span>';
                    nodeEl.appendChild(infoEl);
                }

                itemEl.appendChild(nodeEl);

                if (hasChildren) {
                    var childrenEl = document.createElement('div');
                    childrenEl.className = 'catalog-children';
                    renderCatalogTree(item.children, childrenEl);
                    itemEl.appendChild(childrenEl);

                    nodeEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        itemEl.classList.toggle('expanded');
                        nodeEl.classList.toggle('expanded');
                        setTimeout(updateMenuTogglePosition, 10);
                    });
                } else {
                    // Click on label does nothing for now (visual mockup)
                    nodeEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }

                container.appendChild(itemEl);
            });
        }

        // ===== MENU TOGGLE =====
        var menuToggle = document.getElementById('menu-toggle');
        var accordionPanel = document.getElementById('accordion-panel');
        var menuToggleText = document.getElementById('menu-toggle-text');
        var menuToggleIcon = menuToggle.querySelector('.material-symbols-outlined');
        var menuOpen = true;
        
        function updateMenuTogglePosition() {
            var mainRect = document.getElementById('map-view').getBoundingClientRect();

            if (menuOpen) {
                var panelRect = accordionPanel.getBoundingClientRect();
                var calculatedTop = panelRect.bottom - mainRect.top;
                // Ensure button stays below the panel - if panel hasn't rendered yet, retry
                if (panelRect.height < 50) {
                    setTimeout(updateMenuTogglePosition, 50);
                    return;
                }
                menuToggle.style.top = calculatedTop + 'px';
            } else {
                menuToggle.style.top = '10px';
            }
        }
        
        setTimeout(updateMenuTogglePosition, 100);
        
        menuToggle.addEventListener('click', function() {
            menuOpen = !menuOpen;
            
            if (menuOpen) {
                accordionPanel.classList.remove('collapsed');
                menuToggleText.textContent = 'Men schliessen';
                menuToggleIcon.textContent = 'expand_less';
            } else {
                accordionPanel.classList.add('collapsed');
                menuToggleText.textContent = 'Men ffnen';
                menuToggleIcon.textContent = 'expand_more';
            }
            
            setTimeout(updateMenuTogglePosition, 10);
        });
        
        var observer = new MutationObserver(function() {
            setTimeout(updateMenuTogglePosition, 10);
        });
        observer.observe(accordionPanel, { attributes: true, childList: true, subtree: true });
        
        // ===== INFO PANEL CLOSE =====
        document.getElementById('info-close').addEventListener('click', function() {
            document.getElementById('info-panel').classList.remove('show');
            selectedBuildingId = null;
            updateSelectedBuilding();
        });

        // ===== AI ASSISTANT PANEL =====
        var aiAssistantBtn = document.getElementById('ai-assistant-btn');
        var aiAssistantPanel = document.getElementById('ai-assistant-panel');
        var aiPanelClose = document.getElementById('ai-panel-close');
        var aiPanelOpen = false;

        function toggleAiPanel(forceClose) {
            if (forceClose === true) {
                aiPanelOpen = false;
            } else {
                aiPanelOpen = !aiPanelOpen;
            }

            if (aiPanelOpen) {
                aiAssistantPanel.classList.add('show');
                aiAssistantBtn.classList.add('active');
            } else {
                aiAssistantPanel.classList.remove('show');
                aiAssistantBtn.classList.remove('active');
            }

            // Resize map after transition completes
            if (window.map) {
                setTimeout(function() {
                    map.resize();
                }, 350);
            }
        }

        aiAssistantBtn.addEventListener('click', function() {
            toggleAiPanel();
        });

        aiPanelClose.addEventListener('click', function() {
            toggleAiPanel(true);
        });

        // ===== DETAIL TABS =====
        document.querySelectorAll('.detail-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                if (this.classList.contains('disabled')) {
                    return;
                }
                var targetTab = this.dataset.tab;

                // Update active tab
                document.querySelectorAll('.detail-tab').forEach(function(t) {
                    t.classList.remove('active');
                });
                this.classList.add('active');

                // Switch content
                document.querySelectorAll('.tab-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                var targetContent = document.querySelector('.tab-content[data-content="' + targetTab + '"]');
                if (targetContent) {
                    targetContent.classList.add('active');
                }

                // Render measurements table when switching to Bemessungen tab
                if (targetTab === 'bemessungen') {
                    renderMeasurementsTable();
                }

                // Render documents table when switching to Dokumente tab
                if (targetTab === 'dokumente') {
                    renderDocumentsTable();
                }

                // Render kontakte table when switching to Kontakte tab
                if (targetTab === 'kontakte') {
                    renderKontakteTable();
                }

                // Render kosten table when switching to Kosten tab
                if (targetTab === 'kosten') {
                    renderKostenTable();
                }

                // Render vertraege table when switching to Vertrge tab
                if (targetTab === 'vertraege') {
                    renderVertraegeTable();
                }

                // Render ausstattung table when switching to Ausstattung tab
                if (targetTab === 'ausstattung') {
                    renderAusstattungTable();
                }
            });
        });

        // ===== STYLE SWITCHER =====
        var currentMapStyle = localStorage.getItem('mapStyle') || 'light-v11';
        var styleSwitcherBtn = document.getElementById('style-switcher-btn');
        var stylePanel = document.getElementById('style-panel');
        var stylePanelOpen = false;

        // Map style definitions
        var mapStyles = {
            'light-v11': { name: 'Light', url: 'mapbox://styles/mapbox/light-v11' },
            'streets-v12': { name: 'Standard', url: 'mapbox://styles/mapbox/streets-v12' },
            'satellite-v9': { name: 'Luftbild', url: 'mapbox://styles/mapbox/satellite-v9' },
            'satellite-streets-v12': { name: 'Hybrid', url: 'mapbox://styles/mapbox/satellite-streets-v12' }
        };

        // Generate thumbnail URL using Mapbox Static Images API
        function getStyleThumbnail(styleId, width, height) {
            var lon = 8.2275;
            var lat = 46.8182;
            var zoom = 6;
            return 'https://api.mapbox.com/styles/v1/mapbox/' + styleId + '/static/' +
                   lon + ',' + lat + ',' + zoom + '/' + width + 'x' + height +
                   '?access_token=' + mapboxgl.accessToken;
        }

        // Initialize thumbnails
        function initStyleThumbnails() {
            Object.keys(mapStyles).forEach(function(styleId) {
                var thumbEl = document.getElementById('thumb-' + styleId);
                if (thumbEl) {
                    thumbEl.src = getStyleThumbnail(styleId, 140, 100);
                }
            });
            // Set current style thumbnail
            document.getElementById('current-style-thumb').src = getStyleThumbnail(currentMapStyle, 160, 120);
        }

        // Update active style button
        function updateActiveStyleButton() {
            document.querySelectorAll('.style-option').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.style === currentMapStyle) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('current-style-thumb').src = getStyleThumbnail(currentMapStyle, 160, 120);
        }

        // Toggle style panel
        function toggleStylePanel() {
            stylePanelOpen = !stylePanelOpen;
            if (stylePanelOpen) {
                stylePanel.classList.add('show');
            } else {
                stylePanel.classList.remove('show');
            }
        }

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            if (stylePanelOpen && !e.target.closest('.style-switcher')) {
                stylePanelOpen = false;
                stylePanel.classList.remove('show');
            }
        });

        // Style switcher button click
        styleSwitcherBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleStylePanel();
        });

        // Style option click handlers
        document.querySelectorAll('.style-option').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var styleId = this.dataset.style;
                if (styleId === currentMapStyle) {
                    toggleStylePanel();
                    return;
                }

                currentMapStyle = styleId;
                localStorage.setItem('mapStyle', styleId);
                updateActiveStyleButton();

                // Change map style
                map.setStyle(mapStyles[styleId].url);

                // Close panel
                stylePanelOpen = false;
                stylePanel.classList.remove('show');
            });
        });

        // Re-add layers after style change
        map.on('style.load', function() {
            // Only re-add if portfolio data is loaded and source doesn't exist
            if (portfolioData && !map.getSource('portfolio')) {
                addMapLayers();
            }
        });

        // Apply saved style on load (if different from default)
        if (currentMapStyle !== 'light-v11') {
            map.once('load', function() {
                map.setStyle(mapStyles[currentMapStyle].url);
            });
        }

        // Initialize thumbnails after a short delay to ensure token is available
        setTimeout(initStyleThumbnails, 100);
        updateActiveStyleButton();

        // ===== SHARED TABLE UTILITIES =====

        // Generic sort function for table data
        function sortTableData(data, column, direction) {
            return data.sort(function(a, b) {
                var valA = a[column];
                var valB = b[column];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Generic selection update for detail tables
        function updateTableSelection(config) {
            var checkboxes = document.querySelectorAll('.' + config.checkboxClass);
            var checkedCount = document.querySelectorAll('.' + config.checkboxClass + ':checked').length;
            var selectAll = document.getElementById(config.selectAllId);

            if (selectAll) {
                selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
            }

            document.querySelectorAll('#' + config.tableId + ' tbody tr').forEach(function(row) {
                var cb = row.querySelector('.' + config.checkboxClass);
                row.classList.toggle('selected', cb && cb.checked);
            });

            document.querySelectorAll('.' + config.actionClass).forEach(function(btn) {
                btn.disabled = checkedCount === 0;
            });
        }

        // Generic sort column click handler setup
        function initTableSorting(config) {
            document.querySelectorAll('#' + config.tableId + ' th.sortable').forEach(function(th) {
                th.addEventListener('click', function() {
                    var column = this.dataset.sort;

                    if (column === config.state.column) {
                        config.state.direction = config.state.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        config.state.column = column;
                        config.state.direction = 'asc';
                    }

                    document.querySelectorAll('#' + config.tableId + ' th.sortable').forEach(function(header) {
                        header.classList.remove('sort-asc', 'sort-desc');
                        var icon = header.querySelector('.sort-icon');
                        if (icon) icon.textContent = 'unfold_more';
                    });

                    this.classList.add('sort-' + config.state.direction);
                    var sortIcon = this.querySelector('.sort-icon');
                    if (sortIcon) {
                        sortIcon.textContent = config.state.direction === 'asc' ? 'arrow_upward' : 'arrow_downward';
                    }

                    config.onSort();
                });
            });
        }

        // Generic select-all checkbox setup
        function initSelectAll(config) {
            var selectAll = document.getElementById(config.selectAllId);
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    var isChecked = this.checked;
                    document.querySelectorAll('.' + config.checkboxClass).forEach(function(cb) {
                        cb.checked = isChecked;
                    });
                    config.onUpdate();
                });
            }
        }

        // ===== MEASUREMENTS TAB =====
        var measurementsData = [];
        var filteredMeasurements = [];
        var measurementsSort = { column: 'id', direction: 'asc' };

        var measurementsConfig = {
            tableId: 'measurements-table',
            checkboxClass: 'measurement-checkbox',
            selectAllId: 'select-all-measurements',
            actionClass: 'measurements-action',
            state: measurementsSort,
            onSort: function() {
                sortTableData(filteredMeasurements, measurementsSort.column, measurementsSort.direction);
                renderMeasurementsTable();
            },
            onUpdate: function() { updateTableSelection(measurementsConfig); }
        };

        function loadMeasurementsForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allAreaMeasurements array (DATAMODEL.md schema)
                measurementsData = allAreaMeasurements
                    .filter(function(m) {
                        return m.buildingIds && m.buildingIds.includes(buildingId);
                    })
                    .map(function(m) {
                        return {
                            id: m.areaMeasurementId, areaType: m.type, value: m.value, unit: m.unit,
                            source: (m.extensionData && m.extensionData.source) || 'Manuell',
                            accuracy: m.accuracy, standard: m.standard,
                            validFrom: m.validFrom, validUntil: m.validUntil || ''
                        };
                    });
            } else {
                measurementsData = [];
            }
            filteredMeasurements = measurementsData.slice();
        }

        function renderMeasurementsTable() {
            var tbody = document.getElementById('measurements-tbody');
            if (!tbody) return;

            var html = '';
            filteredMeasurements.forEach(function(m) {
                var formattedValue = Number(m.value).toLocaleString('de-CH');
                html += '<tr data-id="' + m.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="measurement-checkbox"></td>' +
                    '<td class="col-id">' + m.id + '</td>' +
                    '<td class="col-type">' + m.areaType + '</td>' +
                    '<td class="col-area">' + formattedValue + ' ' + m.unit + '</td>' +
                    '<td class="col-source">' + m.source + '</td>' +
                    '<td class="col-accuracy">' + m.accuracy + '</td>' +
                    '<td class="col-standard">' + m.standard + '</td>' +
                    '<td class="col-from">' + m.validFrom + '</td>' +
                    '<td class="col-until">' + m.validUntil + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.measurement-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(measurementsConfig); });
            });
        }

        // Measurements filter
        var measurementsFilter = document.getElementById('measurements-filter');
        if (measurementsFilter) {
            measurementsFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredMeasurements = measurementsData.slice();
                } else {
                    filteredMeasurements = measurementsData.filter(function(m) {
                        return m.id.toLowerCase().includes(term) ||
                               m.areaType.toLowerCase().includes(term) ||
                               m.accuracy.toLowerCase().includes(term) ||
                               m.standard.toLowerCase().includes(term) ||
                               m.unit.toLowerCase().includes(term) ||
                               String(m.value).includes(term);
                    });
                }
                sortTableData(filteredMeasurements, measurementsSort.column, measurementsSort.direction);
                renderMeasurementsTable();
            });
        }

        initTableSorting(measurementsConfig);
        initSelectAll(measurementsConfig);

        var addMeasurementBtn = document.getElementById('btn-add-measurement');
        if (addMeasurementBtn) {
            addMeasurementBtn.addEventListener('click', function() {
                alert('Bemessung hinzufgen - kommt bald...');
            });
        }

        // ===== DOCUMENTS TAB =====
        var documentsData = [];
        var filteredDocuments = [];
        var documentsSort = { column: 'id', direction: 'asc' };

        var documentsConfig = {
            tableId: 'documents-table',
            checkboxClass: 'document-checkbox',
            selectAllId: 'select-all-documents',
            actionClass: 'documents-action',
            state: documentsSort,
            onSort: function() {
                sortTableData(filteredDocuments, documentsSort.column, documentsSort.direction);
                renderDocumentsTable();
            },
            onUpdate: function() { updateTableSelection(documentsConfig); }
        };

        function loadDocumentsForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allDocuments array (DATAMODEL.md schema)
                documentsData = allDocuments
                    .filter(function(d) {
                        return d.buildingIds && d.buildingIds.includes(buildingId);
                    })
                    .map(function(d) {
                        return {
                            id: d.documentId, titel: d.name, dokumentTyp: d.type,
                            dateiformat: d.fileFormat, datum: d.validFrom,
                            dateigroesse: d.fileSize, url: d.url || '#'
                        };
                    });
            } else {
                documentsData = [];
            }
            filteredDocuments = documentsData.slice();
        }

        function renderDocumentsTable() {
            var tbody = document.getElementById('documents-tbody');
            if (!tbody) return;

            var html = '';
            filteredDocuments.forEach(function(d) {
                html += '<tr data-id="' + d.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="document-checkbox"></td>' +
                    '<td class="col-id">' + d.id + '</td>' +
                    '<td class="col-title">' + d.titel + '</td>' +
                    '<td class="col-type">' + d.dokumentTyp + '</td>' +
                    '<td class="col-format">' + d.dateiformat + '</td>' +
                    '<td class="col-date">' + d.datum + '</td>' +
                    '<td class="col-size">' + d.dateigroesse + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.document-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(documentsConfig); });
            });
        }

        // Documents filter
        var documentsFilter = document.getElementById('documents-filter');
        if (documentsFilter) {
            documentsFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredDocuments = documentsData.slice();
                } else {
                    filteredDocuments = documentsData.filter(function(d) {
                        return d.id.toLowerCase().includes(term) ||
                               d.titel.toLowerCase().includes(term) ||
                               d.dokumentTyp.toLowerCase().includes(term) ||
                               d.dateiformat.toLowerCase().includes(term) ||
                               d.datum.toLowerCase().includes(term) ||
                               d.dateigroesse.toLowerCase().includes(term);
                    });
                }
                sortTableData(filteredDocuments, documentsSort.column, documentsSort.direction);
                renderDocumentsTable();
            });
        }

        initTableSorting(documentsConfig);
        initSelectAll(documentsConfig);

        var addDocumentBtn = document.getElementById('btn-add-document');
        if (addDocumentBtn) {
            addDocumentBtn.addEventListener('click', function() {
                alert('Dokument hinzufgen - kommt bald...');
            });
        }

        // ===== KONTAKTE TAB =====
        var kontakteData = [];
        var filteredKontakte = [];
        var kontakteSort = { column: 'name', direction: 'asc' };

        var kontakteConfig = {
            tableId: 'kontakte-table',
            checkboxClass: 'kontakt-checkbox',
            selectAllId: 'select-all-kontakte',
            actionClass: 'kontakte-action',
            state: kontakteSort,
            onSort: function() {
                sortTableData(filteredKontakte, kontakteSort.column, kontakteSort.direction);
                renderKontakteTable();
            },
            onUpdate: function() { updateTableSelection(kontakteConfig); }
        };

        function loadKontakteForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allContacts array (DATAMODEL.md schema)
                kontakteData = allContacts
                    .filter(function(k) {
                        return k.buildingIds && k.buildingIds.includes(buildingId);
                    })
                    .map(function(k) {
                        return {
                            id: k.contactId,
                            name: k.name,
                            rolle: k.role,
                            organisation: k.organisation,
                            telefon: k.phone,
                            email: k.email
                        };
                    });
            } else {
                kontakteData = [];
            }
            filteredKontakte = kontakteData.slice();
        }

        function renderKontakteTable() {
            var tbody = document.getElementById('kontakte-tbody');
            if (!tbody) return;

            var html = '';
            filteredKontakte.forEach(function(k) {
                html += '<tr data-id="' + k.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="kontakt-checkbox"></td>' +
                    '<td class="col-kontakt-id">' + k.id + '</td>' +
                    '<td class="col-kontakt-name">' + k.name + '</td>' +
                    '<td class="col-kontakt-rolle">' + k.rolle + '</td>' +
                    '<td class="col-kontakt-org">' + k.organisation + '</td>' +
                    '<td class="col-kontakt-telefon"><a href="tel:' + k.telefon + '">' + k.telefon + '</a></td>' +
                    '<td class="col-kontakt-email"><a href="mailto:' + k.email + '">' + k.email + '</a></td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.kontakt-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(kontakteConfig); });
            });
        }

        // Kontakte filter
        var kontakteFilter = document.getElementById('kontakte-filter');
        if (kontakteFilter) {
            kontakteFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredKontakte = kontakteData.slice();
                } else {
                    filteredKontakte = kontakteData.filter(function(k) {
                        return k.id.toLowerCase().includes(term) ||
                               k.name.toLowerCase().includes(term) ||
                               k.rolle.toLowerCase().includes(term) ||
                               k.organisation.toLowerCase().includes(term) ||
                               k.telefon.toLowerCase().includes(term) ||
                               k.email.toLowerCase().includes(term);
                    });
                }
                sortTableData(filteredKontakte, kontakteSort.column, kontakteSort.direction);
                renderKontakteTable();
            });
        }

        initTableSorting(kontakteConfig);
        initSelectAll(kontakteConfig);

        var addKontaktBtn = document.getElementById('btn-add-kontakt');
        if (addKontaktBtn) {
            addKontaktBtn.addEventListener('click', function() {
                alert('Kontakt hinzufgen - kommt bald...');
            });
        }

        // ===== KOSTEN TAB =====
        var kostenData = [];
        var filteredKosten = [];
        var kostenSort = { column: 'kostengruppe', direction: 'asc' };

        var kostenConfig = {
            tableId: 'kosten-table',
            checkboxClass: 'kosten-checkbox',
            selectAllId: 'select-all-kosten',
            actionClass: 'kosten-action',
            state: kostenSort,
            onSort: function() {
                sortTableData(filteredKosten, kostenSort.column, kostenSort.direction);
                renderKostenTable();
            },
            onUpdate: function() { updateTableSelection(kostenConfig); }
        };

        function loadKostenForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allCosts array (DATAMODEL.md schema)
                kostenData = allCosts
                    .filter(function(k) {
                        return k.buildingIds && k.buildingIds.includes(buildingId);
                    })
                    .map(function(k) {
                        return {
                            id: k.costId,
                            kostengruppe: k.costGroup,
                            kostenart: k.costType,
                            betrag: k.amount,
                            einheit: k.unit,
                            stichtag: k.referenceDate
                        };
                    });
            } else {
                kostenData = [];
            }
            filteredKosten = kostenData.slice();
        }

        function formatKostenBetrag(amount, einheit) {
            if (amount == null) return '';
            // Extract currency from einheit (e.g., "CHF/Jahr" -> "CHF")
            var currency = 'CHF';
            if (einheit) {
                var parts = einheit.split('/');
                if (parts.length > 0) {
                    currency = parts[0].trim();
                }
            }
            return new Intl.NumberFormat('de-CH', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function renderKostenTable() {
            var tbody = document.getElementById('kosten-tbody');
            if (!tbody) return;

            var html = '';
            filteredKosten.forEach(function(k) {
                html += '<tr data-id="' + k.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="kosten-checkbox"></td>' +
                    '<td class="col-kosten-id">' + k.id + '</td>' +
                    '<td class="col-kosten-gruppe">' + k.kostengruppe + '</td>' +
                    '<td class="col-kosten-art">' + k.kostenart + '</td>' +
                    '<td class="col-kosten-betrag">' + formatKostenBetrag(k.betrag, k.einheit) + '</td>' +
                    '<td class="col-kosten-einheit">' + (k.einheit || '') + '</td>' +
                    '<td class="col-kosten-stichtag">' + (k.stichtag || '') + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.kosten-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(kostenConfig); });
            });
        }

        // Kosten filter
        var kostenFilter = document.getElementById('kosten-filter');
        if (kostenFilter) {
            kostenFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredKosten = kostenData.slice();
                } else {
                    filteredKosten = kostenData.filter(function(k) {
                        return k.id.toLowerCase().includes(term) ||
                               k.kostengruppe.toLowerCase().includes(term) ||
                               k.kostenart.toLowerCase().includes(term) ||
                               (k.betrag && k.betrag.toString().includes(term)) ||
                               (k.einheit && k.einheit.toLowerCase().includes(term)) ||
                               (k.stichtag && k.stichtag.toLowerCase().includes(term));
                    });
                }
                sortTableData(filteredKosten, kostenSort.column, kostenSort.direction);
                renderKostenTable();
            });
        }

        initTableSorting(kostenConfig);
        initSelectAll(kostenConfig);

        var addKostenBtn = document.getElementById('btn-add-kosten');
        if (addKostenBtn) {
            addKostenBtn.addEventListener('click', function() {
                alert('Kosten hinzufgen - kommt bald...');
            });
        }

        // ===== VERTRAEGE TAB =====
        var vertraegeData = [];
        var filteredVertraege = [];
        var vertraegeSort = { column: 'vertragsart', direction: 'asc' };

        var vertraegeConfig = {
            tableId: 'vertraege-table',
            checkboxClass: 'vertrag-checkbox',
            selectAllId: 'select-all-vertraege',
            actionClass: 'vertraege-action',
            state: vertraegeSort,
            onSort: function() {
                sortTableData(filteredVertraege, vertraegeSort.column, vertraegeSort.direction);
                renderVertraegeTable();
            },
            onUpdate: function() { updateTableSelection(vertraegeConfig); }
        };

        function loadVertraegeForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allContracts array (DATAMODEL.md schema)
                vertraegeData = allContracts
                    .filter(function(v) {
                        return v.buildingIds && v.buildingIds.includes(buildingId);
                    })
                    .map(function(v) {
                        return {
                            id: v.contractId,
                            vertragsart: v.type,
                            vertragspartner: v.contractPartner,
                            vertragsbeginn: v.validFrom,
                            vertragsende: v.validUntil,
                            betrag: v.amount,
                            status: v.status
                        };
                    });
            } else {
                vertraegeData = [];
            }
            filteredVertraege = vertraegeData.slice();
        }

        function formatCurrency(amount) {
            if (amount == null) return '';
            return new Intl.NumberFormat('de-CH', {
                style: 'currency',
                currency: 'CHF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getStatusClass(status) {
            if (!status) return '';
            var s = status.toLowerCase();
            if (s === 'aktiv') return 'aktiv';
            if (s === 'gekndigt') return 'gekuendigt';
            if (s === 'ausgelaufen') return 'ausgelaufen';
            return '';
        }

        function renderVertraegeTable() {
            var tbody = document.getElementById('vertraege-tbody');
            if (!tbody) return;

            var html = '';
            filteredVertraege.forEach(function(v) {
                var statusClass = getStatusClass(v.status);
                html += '<tr data-id="' + v.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="vertrag-checkbox"></td>' +
                    '<td class="col-vertrag-id">' + v.id + '</td>' +
                    '<td class="col-vertrag-art">' + v.vertragsart + '</td>' +
                    '<td class="col-vertrag-partner">' + v.vertragspartner + '</td>' +
                    '<td class="col-vertrag-beginn">' + (v.vertragsbeginn || '') + '</td>' +
                    '<td class="col-vertrag-ende">' + (v.vertragsende || 'unbefristet') + '</td>' +
                    '<td class="col-vertrag-betrag">' + formatCurrency(v.betrag) + '</td>' +
                    '<td class="col-vertrag-status"><span class="vertrag-status ' + statusClass + '">' + v.status + '</span></td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.vertrag-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(vertraegeConfig); });
            });
        }

        // Vertraege filter
        var vertraegeFilter = document.getElementById('vertraege-filter');
        if (vertraegeFilter) {
            vertraegeFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredVertraege = vertraegeData.slice();
                } else {
                    filteredVertraege = vertraegeData.filter(function(v) {
                        return v.id.toLowerCase().includes(term) ||
                               v.vertragsart.toLowerCase().includes(term) ||
                               v.vertragspartner.toLowerCase().includes(term) ||
                               (v.vertragsbeginn && v.vertragsbeginn.toLowerCase().includes(term)) ||
                               (v.vertragsende && v.vertragsende.toLowerCase().includes(term)) ||
                               (v.betrag && v.betrag.toString().includes(term)) ||
                               v.status.toLowerCase().includes(term);
                    });
                }
                sortTableData(filteredVertraege, vertraegeSort.column, vertraegeSort.direction);
                renderVertraegeTable();
            });
        }

        initTableSorting(vertraegeConfig);
        initSelectAll(vertraegeConfig);

        var addVertragBtn = document.getElementById('btn-add-vertrag');
        if (addVertragBtn) {
            addVertragBtn.addEventListener('click', function() {
                alert('Vertrag hinzufgen - kommt bald...');
            });
        }

        // ===== AUSSTATTUNG TAB =====
        var ausstattungData = [];
        var filteredAusstattung = [];
        var ausstattungSort = { column: 'bezeichnung', direction: 'asc' };

        var ausstattungConfig = {
            tableId: 'ausstattung-table',
            checkboxClass: 'ausstattung-checkbox',
            selectAllId: 'select-all-ausstattung',
            actionClass: 'ausstattung-action',
            state: ausstattungSort,
            onSort: function() {
                sortTableData(filteredAusstattung, ausstattungSort.column, ausstattungSort.direction);
                renderAusstattungTable();
            },
            onUpdate: function() { updateTableSelection(ausstattungConfig); }
        };

        function loadAusstattungForBuilding(building) {
            if (building && building.properties) {
                var buildingId = building.properties.id;
                // Filter from global allAssets array (DATAMODEL.md schema)
                ausstattungData = allAssets
                    .filter(function(a) {
                        return a.buildingIds && a.buildingIds.includes(buildingId);
                    })
                    .map(function(a) {
                        return {
                            id: a.assetId,
                            bezeichnung: a.name,
                            kategorie: a.category,
                            hersteller: a.manufacturer,
                            baujahr: a.installationYear,
                            standort: a.location
                        };
                    });
            } else {
                ausstattungData = [];
            }
            filteredAusstattung = ausstattungData.slice();
        }

        function renderAusstattungTable() {
            var tbody = document.getElementById('ausstattung-tbody');
            if (!tbody) return;

            var html = '';
            filteredAusstattung.forEach(function(a) {
                html += '<tr data-id="' + a.id + '">' +
                    '<td class="col-checkbox"><input type="checkbox" class="ausstattung-checkbox"></td>' +
                    '<td class="col-ausstattung-id">' + a.id + '</td>' +
                    '<td class="col-ausstattung-bezeichnung">' + a.bezeichnung + '</td>' +
                    '<td class="col-ausstattung-kategorie"><span class="kategorie-badge">' + a.kategorie + '</span></td>' +
                    '<td class="col-ausstattung-hersteller">' + a.hersteller + '</td>' +
                    '<td class="col-ausstattung-baujahr">' + a.baujahr + '</td>' +
                    '<td class="col-ausstattung-standort">' + a.standort + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.ausstattung-checkbox').forEach(function(cb) {
                cb.addEventListener('change', function() { updateTableSelection(ausstattungConfig); });
            });
        }

        // Ausstattung filter
        var ausstattungFilter = document.getElementById('ausstattung-filter');
        if (ausstattungFilter) {
            ausstattungFilter.addEventListener('input', function() {
                var term = this.value.toLowerCase().trim();
                if (term === '') {
                    filteredAusstattung = ausstattungData.slice();
                } else {
                    filteredAusstattung = ausstattungData.filter(function(a) {
                        return a.id.toLowerCase().includes(term) ||
                               a.bezeichnung.toLowerCase().includes(term) ||
                               a.kategorie.toLowerCase().includes(term) ||
                               a.hersteller.toLowerCase().includes(term) ||
                               a.baujahr.toString().includes(term) ||
                               a.standort.toLowerCase().includes(term);
                    });
                }
                sortTableData(filteredAusstattung, ausstattungSort.column, ausstattungSort.direction);
                renderAusstattungTable();
            });
        }

        initTableSorting(ausstattungConfig);
        initSelectAll(ausstattungConfig);

        var addAusstattungBtn = document.getElementById('btn-add-ausstattung');
        if (addAusstattungBtn) {
            addAusstattungBtn.addEventListener('click', function() {
                alert('Ausstattung hinzufgen - kommt bald...');
            });
        }
    </script>
</body>
</html>
